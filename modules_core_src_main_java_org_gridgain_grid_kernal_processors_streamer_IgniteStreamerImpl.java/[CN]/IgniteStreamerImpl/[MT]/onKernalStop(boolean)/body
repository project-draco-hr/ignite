{
  lock.writeLock();
  try {
    stopping=true;
  }
  finally {
    lock.writeUnlock();
  }
  if (cancel) {
    for (    BatchExecutionFuture execFut : batchFuts.values()) {
      try {
        execFut.cancel();
      }
 catch (      IgniteCheckedException e) {
        U.warn(log,"Failed to cancel batch execution future on node stop (will ignore) " + "[execFut=" + execFut + ", err="+ e+ ']');
      }
    }
  }
 else {
    for (    GridStreamerStageExecutionFuture fut : stageFuts.values()) {
      try {
        if (fut.rootExecution()) {
          if (log.isDebugEnabled())           log.debug("Waiting root execution future on kernal stop: " + fut);
          fut.get();
        }
      }
 catch (      IgniteCheckedException ignore) {
      }
    }
    for (    BatchExecutionFuture execFut : batchFuts.values()) {
      try {
        execFut.get();
      }
 catch (      IgniteCheckedException e) {
        if (!e.hasCause(GridInterruptedException.class))         U.warn(log,"Failed to wait for batch execution future completion (will ignore) " + "[execFut=" + execFut + ", e="+ e+ ']');
      }
    }
  }
  for (  StreamerStageWrapper stage : stages.values()) {
    try {
      ctx.resource().cleanupGeneric(stage.unwrap());
    }
 catch (    IgniteCheckedException e) {
      U.error(log,"Failed to cleanup stage [stage=" + stage + ", streamer="+ this+ ']',e);
    }
  }
}
