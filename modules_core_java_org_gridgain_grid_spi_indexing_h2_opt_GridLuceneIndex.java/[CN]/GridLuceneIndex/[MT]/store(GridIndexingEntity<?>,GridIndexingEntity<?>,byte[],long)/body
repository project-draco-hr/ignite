{
  Document doc=new Document();
  Object k=key.value();
  Object v=val.value();
  boolean stringsFound=false;
  if (type.valueTextIndex() || type.valueClass() == String.class) {
    doc.add(new Field(VAL_STR_FIELD_NAME,v.toString(),Field.Store.YES,Field.Index.ANALYZED));
    stringsFound=true;
  }
  for (int i=0, last=idxdFields.length - 1; i < last; i++) {
    Object fieldVal=type.value(keyFields.get(i) ? k : v,idxdFields[i]);
    if (fieldVal != null) {
      doc.add(new Field(idxdFields[i],fieldVal.toString(),Field.Store.YES,Field.Index.ANALYZED));
      stringsFound=true;
    }
  }
  if (!stringsFound)   return;
  doc.add(new Field(KEY_FIELD_NAME,Base64.encodeBase64String(marshaller.marshal(key)),Field.Store.YES,Field.Index.NOT_ANALYZED));
  if (storeVal && type.valueClass() != String.class)   doc.add(new Field(VAL_FIELD_NAME,marshaller.marshal(val)));
  doc.add(new Field(VER_FIELD_NAME,ver));
  doc.add(new Field(EXPIRATION_TIME_FIELD_NAME,DateTools.timeToString(expires,DateTools.Resolution.MILLISECOND),Field.Store.YES,Field.Index.NOT_ANALYZED));
  try {
    writer.addDocument(doc);
    updateCntr.incrementAndGet();
  }
 catch (  IOException e) {
    throw new GridSpiException(e);
  }
}
