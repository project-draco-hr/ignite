{
  startGrids(gridCount());
  try {
    GridCache<Object,Object> cache=grid(0).cache(null);
    int key=testKey();
    GridCacheTx tx=cache.txStart(PESSIMISTIC,REPEATABLE_READ);
    try {
      cache.get(key);
      cache.remove(key);
      tx.commit();
    }
  finally {
      tx.close();
    }
    CountingCommunicationSpi commSpi=(CountingCommunicationSpi)grid(0).configuration().getCommunicationSpi();
    assertEquals(expectedNearLockRequests(),commSpi.nearLocks());
    assertEquals(expectedDhtLockRequests(),commSpi.dhtLocks());
    assertEquals(expectedDistributedLockRequests(),commSpi.distributedLocks());
  }
  finally {
    stopAllGrids();
  }
}
