{
  GridDeployment dep=null;
  if (!req.forceLocalDeployment()) {
    dep=ctx.deploy().getGlobalDeployment(req.deploymentMode(),req.sampleClassName(),req.sampleClassName(),req.userVersion(),nodeId,req.classLoaderId(),req.loaderParticipants(),null);
    if (dep == null)     throw new GridException("Failed to obtain global deployment based on deployment metadata " + "[nodeId=" + nodeId + ", req="+ req+ ']');
  }
  GridStreamerExecutionBatch batch=ctx.config().getMarshaller().unmarshal(req.batchBytes(),dep != null ? dep.classLoader() : null);
  batch.deployment(dep);
  return batch;
}
