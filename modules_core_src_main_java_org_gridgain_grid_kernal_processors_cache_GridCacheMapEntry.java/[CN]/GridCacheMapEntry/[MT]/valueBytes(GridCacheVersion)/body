{
  V val=null;
  GridCacheValueBytes valBytes=GridCacheValueBytes.nil();
synchronized (this) {
    checkObsolete();
    if (ver == null || this.ver.equals(ver)) {
      val=this.val;
      ver=this.ver;
      valBytes=valueBytesUnlocked();
      if (valBytes.isNull() && cctx.portableOffheap() && valPtr != 0)       valBytes=GridCacheValueBytes.marshaled(CU.marshal(cctx,cctx.portable().unmarshal(valPtr,true)));
    }
 else     ver=null;
  }
  if (valBytes.isNull()) {
    if (val != null)     valBytes=(val instanceof byte[]) ? GridCacheValueBytes.plain(val) : GridCacheValueBytes.marshaled(CU.marshal(cctx,val));
    if (ver != null && !isOffHeapValuesOnly()) {
synchronized (this) {
        checkObsolete();
        if (this.val == val)         this.valBytes=isStoreValueBytes() ? valBytes.getIfMarshaled() : null;
      }
    }
  }
  return valBytes;
}
