{
  if (ctx.config().isDaemon())   return;
  if (!F.isEmpty(cacheMBeans)) {
    for (    ObjectName mb : cacheMBeans) {
      try {
        mBeanSrv.unregisterMBean(mb);
        if (log.isDebugEnabled())         log.debug("Unregistered cache MBean: " + mb);
      }
 catch (      JMException e) {
        U.error(log,"Failed to unregister cache MBean: " + mb,e);
      }
    }
  }
  List<? extends GridCacheSharedManager<?,?>> sharedMgrs=sharedCtx.managers();
  for (ListIterator<? extends GridCacheSharedManager<?,?>> it=sharedMgrs.listIterator(sharedMgrs.size()); it.hasPrevious(); ) {
    GridCacheSharedManager<?,?> mgr=it.previous();
    mgr.onKernalStop(cancel);
  }
  for (  GridCacheAdapter<?,?> cache : stopSeq) {
    GridCacheContext ctx=cache.context();
    if (isNearEnabled(ctx)) {
      GridDhtCacheAdapter dht=ctx.near().dht();
      if (dht != null) {
        GridCacheContext<?,?> dhtCtx=dht.context();
        for (        GridCacheManager mgr : dhtManagers(dhtCtx))         mgr.onKernalStop(cancel);
        dht.onKernalStop();
      }
    }
    List<GridCacheManager> mgrs=ctx.managers();
    Collection<GridCacheManager> excludes=dhtExcludes(ctx);
    for (ListIterator<GridCacheManager> it=mgrs.listIterator(mgrs.size()); it.hasPrevious(); ) {
      GridCacheManager mgr=it.previous();
      if (!excludes.contains(mgr))       mgr.onKernalStop(cancel);
    }
    cache.onKernalStop();
  }
}
