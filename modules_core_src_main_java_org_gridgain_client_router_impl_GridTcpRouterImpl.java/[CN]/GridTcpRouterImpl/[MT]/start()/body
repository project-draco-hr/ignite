{
  try {
    client=createClient(cfg);
  }
 catch (  GridClientException e) {
    throw new GridException("Failed to initialise embedded client.",e);
  }
  GridNioServerListener<GridClientMessage> lsnr;
  try {
    Class<?> cls=Class.forName(ENT_NIO_LSNR_CLS);
    Constructor<?> cons=cls.getDeclaredConstructor(IgniteLogger.class,GridRouterClientImpl.class);
    cons.setAccessible(true);
    lsnr=(GridNioServerListener<GridClientMessage>)cons.newInstance(log,client);
  }
 catch (  ClassNotFoundException ignored) {
    lsnr=new GridTcpRouterNioListenerOsImpl(log,client);
  }
catch (  NoSuchMethodException|IllegalAccessException|InstantiationException|InvocationTargetException e) {
    throw new GridException("Failed to create NIO listener.",e);
  }
  parser=new GridTcpRouterNioParser();
  final InetAddress hostAddr;
  try {
    hostAddr=InetAddress.getByName(cfg.getHost());
  }
 catch (  UnknownHostException e) {
    throw new GridException("Failed to resolve grid address for configured host: " + cfg.getHost(),e);
  }
  SSLContext sslCtx;
  try {
    GridSslContextFactory sslCtxFactory=cfg.getSslContextFactory();
    sslCtx=sslCtxFactory == null ? null : sslCtxFactory.createSslContext();
  }
 catch (  SSLException e) {
    throw new GridException("Failed to create SSL context.",e);
  }
  for (int port=cfg.getPort(), last=port + cfg.getPortRange(); port <= last; port++) {
    if (startTcpServer(hostAddr,port,lsnr,parser,cfg.isNoDelay(),sslCtx,cfg.isSslClientAuth(),cfg.isSslClientAuth())) {
      if (log.isInfoEnabled())       log.info("TCP router successfully started for endpoint: " + hostAddr.getHostAddress() + ":"+ port);
      bindPort=port;
      bindHost=hostAddr.getHostName();
      break;
    }
 else     U.warn(log,"TCP REST router failed to start on endpoint: " + hostAddr.getHostAddress() + ":"+ port+ ". Will try next port within allowed port range.");
  }
  if (bindPort == 0)   throw new GridException("Failed to bind TCP router server (possibly all ports in range " + "are in use) [firstPort=" + cfg.getPort() + ", lastPort="+ (cfg.getPort() + cfg.getPortRange())+ ", addr="+ hostAddr+ ']');
  try {
    ObjectName objName=U.registerMBean(ManagementFactory.getPlatformMBeanServer(),"Router","TCP Router " + id,getClass().getSimpleName(),this,GridTcpRouterMBean.class);
    if (log.isDebugEnabled())     log.debug("Registered MBean: " + objName);
    mbeanName=objName;
  }
 catch (  JMException e) {
    U.error(log,"Failed to register MBean.",e);
  }
}
