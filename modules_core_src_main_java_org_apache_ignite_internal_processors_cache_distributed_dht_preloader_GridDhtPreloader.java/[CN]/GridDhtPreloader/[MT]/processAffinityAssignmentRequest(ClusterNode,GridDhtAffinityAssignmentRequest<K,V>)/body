{
  final long topVer=req.topologyVersion();
  if (log.isDebugEnabled())   log.debug("Processing affinity assignment request [node=" + node + ", req="+ req+ ']');
  cctx.affinity().affinityReadyFuture(req.topologyVersion()).listenAsync(new CI1<IgniteInternalFuture<Long>>(){
    @Override public void apply(    IgniteInternalFuture<Long> fut){
      if (log.isDebugEnabled())       log.debug("Affinity is ready for topology version, will send response [topVer=" + topVer + ", node="+ node+ ']');
      List<List<ClusterNode>> assignment=cctx.affinity().assignments(topVer);
      try {
        cctx.io().send(node,new GridDhtAffinityAssignmentResponse<K,V>(cctx.cacheId(),topVer,assignment),AFFINITY_POOL);
      }
 catch (      IgniteCheckedException e) {
        U.error(log,"Failed to send affinity assignment response to remote node [node=" + node + ']',e);
      }
    }
  }
);
}
