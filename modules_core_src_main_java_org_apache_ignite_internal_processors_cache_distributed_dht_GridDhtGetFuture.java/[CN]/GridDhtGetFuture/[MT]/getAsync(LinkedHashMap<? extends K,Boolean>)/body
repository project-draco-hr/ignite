{
  if (F.isEmpty(keys))   return new GridFinishedFuture<Collection<GridCacheEntryInfo<K,V>>>(Collections.<GridCacheEntryInfo<K,V>>emptyList());
  final Collection<GridCacheEntryInfo<K,V>> infos=new LinkedList<>();
  String taskName0=cctx.kernalContext().job().currentTaskName();
  if (taskName0 == null)   taskName0=cctx.kernalContext().task().resolveTaskName(taskNameHash);
  final String taskName=taskName0;
  GridCompoundFuture<Boolean,Boolean> txFut=null;
  for (  Map.Entry<? extends K,Boolean> k : keys.entrySet()) {
    while (true) {
      GridDhtCacheEntry<K,V> e=cache().entryExx(k.getKey(),topVer);
      try {
        GridCacheEntryInfo<K,V> info=e.info();
        if (info == null)         continue;
        IgniteInternalFuture<Boolean> f=(!e.deleted() && k.getValue() && !skipVals) ? e.addReader(reader,msgId,topVer) : null;
        if (f != null) {
          if (txFut == null)           txFut=new GridCompoundFuture<>(CU.boolReducer());
          txFut.add(f);
        }
        infos.add(info);
        break;
      }
 catch (      GridCacheEntryRemovedException ignore) {
        if (log.isDebugEnabled())         log.debug("Got removed entry when getting a DHT value: " + e);
      }
 finally {
        cctx.evicts().touch(e,topVer);
      }
    }
  }
  if (txFut != null)   txFut.markInitialized();
  IgniteInternalFuture<Map<K,V>> fut;
  if (txFut == null || txFut.isDone()) {
    if (reload && cctx.readThrough() && cctx.store().configured()) {
      fut=cache().reloadAllAsync(keys.keySet(),true,skipVals,subjId,taskName);
    }
 else {
      if (tx == null) {
        fut=cache().getDhtAllAsync(keys.keySet(),readThrough,subjId,taskName,deserializePortable,expiryPlc,skipVals);
      }
 else {
        fut=tx.getAllAsync(cctx,keys.keySet(),null,deserializePortable,skipVals);
      }
    }
  }
 else {
    fut=new GridEmbeddedFuture<>(txFut,new C2<Boolean,Exception,IgniteInternalFuture<Map<K,V>>>(){
      @Override public IgniteInternalFuture<Map<K,V>> apply(      Boolean b,      Exception e){
        if (e != null)         throw new GridClosureException(e);
        if (reload && cctx.readThrough() && cctx.store().configured()) {
          return cache().reloadAllAsync(keys.keySet(),true,skipVals,subjId,taskName);
        }
 else {
          if (tx == null) {
            return cache().getDhtAllAsync(keys.keySet(),readThrough,subjId,taskName,deserializePortable,expiryPlc,skipVals);
          }
 else {
            return tx.getAllAsync(cctx,keys.keySet(),null,deserializePortable,skipVals);
          }
        }
      }
    }
);
  }
  return new GridEmbeddedFuture<>(new C2<Map<K,V>,Exception,Collection<GridCacheEntryInfo<K,V>>>(){
    @Override public Collection<GridCacheEntryInfo<K,V>> apply(    Map<K,V> map,    Exception e){
      if (e != null) {
        onDone(e);
        return Collections.emptyList();
      }
 else {
        for (Iterator<GridCacheEntryInfo<K,V>> it=infos.iterator(); it.hasNext(); ) {
          GridCacheEntryInfo<K,V> info=it.next();
          V v=map.get(info.key());
          if (v == null)           it.remove();
 else           info.value(v);
        }
        return infos;
      }
    }
  }
,fut);
}
