{
  if (F.isEmpty(keys))   return new GridFinishedFuture<Collection<GridCacheEntryInfo>>(Collections.<GridCacheEntryInfo>emptyList());
  final Collection<GridCacheEntryInfo> infos=new LinkedList<>();
  String taskName0=cctx.kernalContext().job().currentTaskName();
  if (taskName0 == null)   taskName0=cctx.kernalContext().task().resolveTaskName(taskNameHash);
  final String taskName=taskName0;
  GridCompoundFuture<Boolean,Boolean> txFut=null;
  for (  Map.Entry<KeyCacheObject,Boolean> k : keys.entrySet()) {
    while (true) {
      GridDhtCacheEntry e=cache().entryExx(k.getKey(),topVer);
      try {
        GridCacheEntryInfo info=e.info();
        if (info == null)         continue;
        boolean addReader=(!e.deleted() && k.getValue() && !skipVals);
        if (addReader)         e.unswap(false);
        IgniteInternalFuture<Boolean> f=addReader ? e.addReader(reader,msgId,topVer) : null;
        if (f != null) {
          if (txFut == null)           txFut=new GridCompoundFuture<>(CU.boolReducer());
          txFut.add(f);
        }
        infos.add(info);
        break;
      }
 catch (      IgniteCheckedException err) {
        return new GridFinishedFuture<>(err);
      }
catch (      GridCacheEntryRemovedException ignore) {
        if (log.isDebugEnabled())         log.debug("Got removed entry when getting a DHT value: " + e);
      }
 finally {
        cctx.evicts().touch(e,topVer);
      }
    }
  }
  if (txFut != null)   txFut.markInitialized();
  IgniteInternalFuture<Map<KeyCacheObject,CacheObject>> fut;
  if (txFut == null || txFut.isDone()) {
    if (reload && cctx.readThrough() && cctx.store().configured()) {
      fut=cache().reloadAllAsync0(keys.keySet(),true,skipVals,subjId,taskName);
    }
 else {
      if (tx == null) {
        fut=cache().getDhtAllAsync(keys.keySet(),readThrough,subjId,taskName,expiryPlc,skipVals,true);
      }
 else {
        fut=tx.getAllAsync(cctx,keys.keySet(),null,false,skipVals,true,!readThrough);
      }
    }
  }
 else {
    fut=new GridEmbeddedFuture<>(txFut,new C2<Boolean,Exception,IgniteInternalFuture<Map<KeyCacheObject,CacheObject>>>(){
      @Override public IgniteInternalFuture<Map<KeyCacheObject,CacheObject>> apply(      Boolean b,      Exception e){
        if (e != null)         throw new GridClosureException(e);
        if (reload && cctx.readThrough() && cctx.store().configured()) {
          return cache().reloadAllAsync0(keys.keySet(),true,skipVals,subjId,taskName);
        }
 else {
          if (tx == null) {
            return cache().getDhtAllAsync(keys.keySet(),readThrough,subjId,taskName,expiryPlc,skipVals,true);
          }
 else {
            return tx.getAllAsync(cctx,keys.keySet(),null,false,skipVals,true,!readThrough);
          }
        }
      }
    }
);
  }
  return new GridEmbeddedFuture<>(new C2<Map<KeyCacheObject,CacheObject>,Exception,Collection<GridCacheEntryInfo>>(){
    @Override public Collection<GridCacheEntryInfo> apply(    Map<KeyCacheObject,CacheObject> map,    Exception e){
      if (e != null) {
        onDone(e);
        return Collections.emptyList();
      }
 else {
        for (Iterator<GridCacheEntryInfo> it=infos.iterator(); it.hasNext(); ) {
          GridCacheEntryInfo info=it.next();
          Object v=map.get(info.key());
          if (v == null)           it.remove();
 else           if (!skipVals)           info.value((CacheObject)v);
        }
        return infos;
      }
    }
  }
,fut);
}
