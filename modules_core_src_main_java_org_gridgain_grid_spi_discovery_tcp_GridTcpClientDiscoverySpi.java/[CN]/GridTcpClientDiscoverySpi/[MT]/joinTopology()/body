{
  stats.onJoinStarted();
  Collection<InetSocketAddress> addrs=resolvedAddresses();
  if (addrs == null || addrs.isEmpty())   throw new GridSpiException("No addresses registered in the IP finder: " + ipFinder);
  List<InetSocketAddress> shuffled=new ArrayList<>(addrs);
  Collections.shuffle(shuffled);
  GridTcpDiscoveryJoinRequestMessage req=new GridTcpDiscoveryJoinRequestMessage(locNode,exchange.collect(locNodeId));
  req.client(true);
  while (true) {
    boolean retry=false;
    Iterator<InetSocketAddress> it=shuffled.iterator();
    while (it.hasNext()) {
      InetSocketAddress addr=it.next();
      try {
        long ts=U.currentTimeMillis();
        UUID rmtNodeId=initConnection(addr);
        Socket sock0=sock;
        stats.onClientSocketInitialized(U.currentTimeMillis() - ts);
        writeToSocket(sock0,req);
        int res=readReceipt(sock0,ackTimeout);
switch (res) {
case RES_OK:
          sockRdr=new SocketReader(sock0,rmtNodeId,new MessageWorker(sock0));
        sockRdr.start();
      if (U.await(joinLatch,netTimeout,MILLISECONDS)) {
        if (log.isDebugEnabled())         log.debug("Successfully connected to topology [sock=" + sock0 + ']');
        stats.onJoinFinished();
        return;
      }
 else {
        throw new GridSpiException("Join process timed out [sock=" + sock0 + ", timeout="+ netTimeout+ ']');
      }
case RES_CONTINUE_JOIN:
case RES_WAIT:
    closeConnection();
  retry=true;
break;
default :
throw new GridSpiException("Unexpected response to join request: " + res);
}
}
 catch (GridException|IOException e) {
if (log.isDebugEnabled()) U.error(log,"Failed to establish connection with address: " + addr,e);
closeConnection();
it.remove();
}
}
if (!retry) break;
}
throw new GridSpiException("Failed to connect to any address from IP finder (make sure " + "IP finder addresses are correct, and operating system firewalls are disabled on all " + "host machines): "+ addrs);
}
