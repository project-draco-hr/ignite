{
  if (locNodeId.equals(msg.nodeId())) {
    GridTcpDiscoverySpiState state=spiState();
    if (state == CONNECTING) {
      long topVer=msg.topologyVersion();
      locNode.order(topVer);
synchronized (mux) {
        spiState=CONNECTED;
        mux.notifyAll();
      }
      notifyDiscovery(EVT_NODE_JOINED,topVer,locNode);
    }
 else     if (log.isDebugEnabled())     log.debug("Discarding node add finished message (this message has already been processed) " + "[spiState=" + state + ", msg="+ msg+ ", locNode="+ locNode+ ']');
  }
 else {
    GridTcpDiscoveryNode node=rmtNodes.get(msg.nodeId());
    if (node == null) {
      if (log.isDebugEnabled())       log.debug("Discarding node add finished message since node is not found [msg=" + msg + ']');
      return;
    }
    long topVer=msg.topologyVersion();
    node.order(topVer);
    if (locNodeVer.equals(node.version()))     node.version(locNodeVer);
    notifyDiscovery(EVT_NODE_JOINED,topVer,node);
    stats.onNodeJoined();
  }
}
