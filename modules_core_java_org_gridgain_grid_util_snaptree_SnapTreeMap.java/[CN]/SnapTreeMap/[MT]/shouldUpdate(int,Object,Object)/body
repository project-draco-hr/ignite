{
switch (func) {
case UpdateAlways:
    return true;
case UpdateIfAbsent:
  return prev == null;
case UpdateIfPresent:
return prev != null;
default :
{
assert(expected != null);
if (prev == null) {
  return false;
}
if (AllowNullValues && (prev == SpecialNull || expected == SpecialNull)) {
  return prev == SpecialNull && expected == SpecialNull;
}
return prev.equals(expected);
}
}
}
