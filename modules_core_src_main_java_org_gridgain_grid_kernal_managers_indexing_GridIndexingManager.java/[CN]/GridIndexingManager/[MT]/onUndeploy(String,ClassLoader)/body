{
  if (!busyLock.enterBusy())   throw new IllegalStateException("Failed to process undeploy event (grid is stopping).");
  try {
    try {
      Iterator<Map.Entry<TypeId,TypeDescriptor>> it=types.entrySet().iterator();
      while (it.hasNext()) {
        Map.Entry<TypeId,TypeDescriptor> e=it.next();
        if (!F.eq(e.getKey().space,space))         continue;
        TypeDescriptor desc=e.getValue();
        if (ldr.equals(U.detectClassLoader(desc.valCls)) || ldr.equals(U.detectClassLoader(desc.keyCls))) {
          for (          IndexingSpi spi : getSpis()) {
            if (desc.await() && desc.registered())             spi.unregisterType(e.getKey().space,desc);
          }
          it.remove();
        }
      }
    }
  finally {
      Long id=idByLdr.remove(ldr);
      if (id != null)       ldrById.remove(id);
    }
  }
  finally {
    busyLock.leaveBusy();
  }
}
