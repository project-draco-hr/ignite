{
  boolean res;
switch (status) {
case USER_FINISH:
    res=finalizing.compareAndSet(NONE,USER_FINISH);
  break;
case RECOVERY_WAIT:
finalizing.compareAndSet(NONE,RECOVERY_WAIT);
FinalizationStatus cur=finalizing.get();
res=cur == RECOVERY_WAIT || cur == RECOVERY_FINISH;
break;
case RECOVERY_FINISH:
FinalizationStatus old=finalizing.get();
res=old != USER_FINISH && finalizing.compareAndSet(old,status);
break;
default :
throw new IllegalArgumentException("Cannot set finalization status: " + status);
}
if (res) {
if (log.isDebugEnabled()) log.debug("Marked transaction as finalized: " + this);
}
 else {
if (log.isDebugEnabled()) log.debug("Transaction was not marked finalized: " + this);
}
return res;
}
