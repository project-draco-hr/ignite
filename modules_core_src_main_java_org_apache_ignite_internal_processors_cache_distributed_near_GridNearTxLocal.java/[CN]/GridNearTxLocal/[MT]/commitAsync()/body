{
  if (log.isDebugEnabled())   log.debug("Committing near local tx: " + this);
  prepareAsync();
  GridNearTxFinishFuture fut=commitFut.get();
  if (fut == null && !commitFut.compareAndSet(null,fut=new GridNearTxFinishFuture<>(cctx,this,true)))   return commitFut.get();
  cctx.mvcc().addFuture(fut);
  final IgniteInternalFuture<?> prepareFut=prepFut.get();
  prepareFut.listen(new CI1<IgniteInternalFuture<?>>(){
    @Override public void apply(    IgniteInternalFuture<?> f){
      GridNearTxFinishFuture fut0=commitFut.get();
      try {
        prepareFut.get();
        fut0.finish();
      }
 catch (      Error|RuntimeException e) {
        commitErr.compareAndSet(null,e);
        fut0.onError(e);
        throw e;
      }
catch (      IgniteCheckedException e) {
        commitErr.compareAndSet(null,e);
        fut0.onError(e);
      }
    }
  }
);
  return fut;
}
