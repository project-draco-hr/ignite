{
  if (log.isDebugEnabled())   log.debug("Committing near local tx: " + this);
  if (fastFinish()) {
    state(PREPARING);
    state(PREPARED);
    state(COMMITTING);
    cctx.tm().fastFinishTx(this,true);
    state(COMMITTED);
    return new GridFinishedFuture<>((IgniteInternalTx)this);
  }
  prepareAsync();
  GridNearTxFinishFuture fut=commitFut;
  if (fut == null && !COMMIT_FUT_UPD.compareAndSet(this,null,fut=new GridNearTxFinishFuture<>(cctx,this,true)))   return commitFut;
  cctx.mvcc().addFuture(fut,fut.futureId());
  final IgniteInternalFuture<?> prepareFut=prepFut;
  prepareFut.listen(new CI1<IgniteInternalFuture<?>>(){
    @Override public void apply(    IgniteInternalFuture<?> f){
      GridNearTxFinishFuture fut0=commitFut;
      try {
        prepareFut.get();
        fut0.finish(true);
      }
 catch (      Error|RuntimeException e) {
        COMMIT_ERR_UPD.compareAndSet(GridNearTxLocal.this,null,e);
        fut0.finish(false);
        throw e;
      }
catch (      IgniteCheckedException e) {
        COMMIT_ERR_UPD.compareAndSet(GridNearTxLocal.this,null,e);
        fut0.finish(false);
      }
    }
  }
);
  return fut;
}
