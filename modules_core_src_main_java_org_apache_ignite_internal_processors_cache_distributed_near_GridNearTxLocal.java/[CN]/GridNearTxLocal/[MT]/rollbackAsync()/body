{
  if (log.isDebugEnabled())   log.debug("Rolling back near tx: " + this);
  GridNearTxFinishFuture<K,V> fut=rollbackFut.get();
  if (fut != null)   return fut;
  if (!rollbackFut.compareAndSet(null,fut=new GridNearTxFinishFuture<>(cctx,this,false)))   return rollbackFut.get();
  cctx.mvcc().addFuture(fut);
  IgniteFuture<IgniteTxEx<K,V>> prepFut=this.prepFut.get();
  if (prepFut == null || prepFut.isDone()) {
    try {
      if (prepFut != null)       prepFut.get();
    }
 catch (    IgniteCheckedException e) {
      if (log.isDebugEnabled())       log.debug("Got optimistic tx failure [tx=" + this + ", err="+ e+ ']');
    }
    try {
      if (finish(false) || state() == UNKNOWN)       fut.finish();
 else       fut.onError(new IgniteCheckedException("Failed to gracefully rollback transaction: " + CU.txString(this)));
    }
 catch (    IgniteCheckedException e) {
      fut.onError(e);
    }
  }
 else {
    prepFut.listenAsync(new CI1<IgniteFuture<IgniteTxEx<K,V>>>(){
      @Override public void apply(      IgniteFuture<IgniteTxEx<K,V>> f){
        try {
          f.get();
        }
 catch (        IgniteCheckedException e) {
          if (log.isDebugEnabled())           log.debug("Got optimistic tx failure [tx=" + this + ", err="+ e+ ']');
        }
        GridNearTxFinishFuture<K,V> fut0=rollbackFut.get();
        try {
          if (finish(false) || state() == UNKNOWN)           fut0.finish();
 else           fut0.onError(new IgniteCheckedException("Failed to gracefully rollback transaction: " + CU.txString(GridNearTxLocal.this)));
        }
 catch (        IgniteCheckedException e) {
          U.error(log,"Failed to gracefully rollback transaction: " + CU.txString(GridNearTxLocal.this),e);
          fut0.onError(e);
        }
      }
    }
);
  }
  return fut;
}
