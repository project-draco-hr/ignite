{
  GridNearTxPrepareFutureAdapter fut=(GridNearTxPrepareFutureAdapter)prepFut;
  if (fut == null) {
    long timeout=remainingTime();
    if (optimistic()) {
      fut=serializable() ? new GridNearOptimisticSerializableTxPrepareFuture(cctx,this) : new GridNearOptimisticTxPrepareFuture(cctx,this);
    }
 else     fut=new GridNearPessimisticTxPrepareFuture(cctx,this);
    if (!PREP_FUT_UPD.compareAndSet(this,null,fut))     return prepFut;
    if (timeout == -1) {
      fut.onDone(this,timeoutException());
      return fut;
    }
  }
 else   return fut;
  mapExplicitLocks();
  fut.prepare();
  return fut;
}
