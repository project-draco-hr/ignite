{
  String masked=maskNull(cacheCfg.getName());
  DynamicCacheDescriptor desc=registeredTemplates.get(masked);
  if (desc != null)   return;
  DynamicCacheChangeRequest req=new DynamicCacheChangeRequest(cacheCfg.getName(),ctx.localNodeId());
  CacheConfiguration cfg=new CacheConfiguration(cacheCfg);
  req.template(true);
  req.startCacheConfiguration(cfg);
  req.deploymentId(IgniteUuid.randomUuid());
  TemplateConfigurationFuture fut=new TemplateConfigurationFuture(req.cacheName(),req.deploymentId());
  TemplateConfigurationFuture old=(TemplateConfigurationFuture)pendingTemplateFuts.putIfAbsent(maskNull(cacheCfg.getName()),fut);
  if (old != null)   fut=old;
  Exception err=null;
  try {
    ctx.discovery().sendCustomEvent(new DynamicCacheChangeBatch(Collections.singleton(req)));
    if (ctx.isStopping()) {
      err=new IgniteCheckedException("Failed to execute dynamic cache change request, " + "node is stopping.");
    }
 else     if (ctx.clientDisconnected()) {
      err=new IgniteClientDisconnectedCheckedException(ctx.cluster().clientReconnectFuture(),"Failed to execute dynamic cache change request, client node disconnected.");
    }
  }
 catch (  IgniteCheckedException e) {
    err=e;
  }
  if (err != null)   fut.onDone(err);
  fut.get();
}
