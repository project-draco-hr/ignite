{
  IgniteConfiguration cfg=super.getConfiguration(gridName);
  cfg.setNetworkTimeout(2000);
  TcpDiscoverySpi spi=new TcpDiscoverySpi();
  spi.setIpFinder(ipFinder);
  cfg.setDiscoverySpi(spi);
  cfg.setMarshaller(new IgniteJdkMarshaller());
  cfg.setSwapSpaceSpi(new GridFileSwapSpaceSpi());
  GridCacheConfiguration repCacheCfg=defaultCacheConfiguration();
  repCacheCfg.setName("replicated");
  repCacheCfg.setCacheMode(REPLICATED);
  repCacheCfg.setPreloadMode(mode);
  repCacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
  repCacheCfg.setQueryIndexEnabled(false);
  repCacheCfg.setAtomicityMode(TRANSACTIONAL);
  if (offheap)   repCacheCfg.setOffHeapMaxMemory(OFFHEAP);
 else   repCacheCfg.setSwapEnabled(true);
  GridCacheConfiguration partCacheCfg=defaultCacheConfiguration();
  partCacheCfg.setName("partitioned");
  partCacheCfg.setCacheMode(PARTITIONED);
  partCacheCfg.setPreloadMode(mode);
  partCacheCfg.setAffinity(new GridCacheModuloAffinityFunction(11,1));
  partCacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
  partCacheCfg.setEvictNearSynchronized(false);
  partCacheCfg.setQueryIndexEnabled(false);
  partCacheCfg.setAtomicityMode(TRANSACTIONAL);
  partCacheCfg.setDistributionMode(NEAR_PARTITIONED);
  if (offheap)   partCacheCfg.setOffHeapMaxMemory(OFFHEAP);
 else   partCacheCfg.setSwapEnabled(true);
  cfg.setCacheConfiguration(repCacheCfg,partCacheCfg);
  cfg.setDeploymentMode(SHARED);
  cfg.setPeerClassLoadingLocalClassPathExclude(GridCacheP2PUndeploySelfTest.class.getName());
  cfg.setUserAttributes(F.asMap(GridCacheModuloAffinityFunction.IDX_ATTR,idxGen.getAndIncrement()));
  return cfg;
}
