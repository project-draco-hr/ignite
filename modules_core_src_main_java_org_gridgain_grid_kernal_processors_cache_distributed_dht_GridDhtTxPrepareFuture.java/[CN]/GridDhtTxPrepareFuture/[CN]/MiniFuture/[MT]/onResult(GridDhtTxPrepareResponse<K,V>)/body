{
  if (res.error() != null)   onError(res.error());
 else {
    if (nearMapping != null && !F.isEmpty(res.nearEvicted())) {
      nearMapping.evictReaders(res.nearEvicted());
      for (      GridCacheTxEntry<K,V> entry : nearMapping.entries()) {
        if (res.nearEvicted().contains(entry.key())) {
          while (true) {
            try {
              GridDhtCacheEntry<K,V> cached=(GridDhtCacheEntry<K,V>)entry.cached();
              cached.removeReader(nearMapping.node().id(),res.messageId());
              break;
            }
 catch (            GridCacheEntryRemovedException ignore) {
              GridCacheEntryEx<K,V> e=entry.context().cache().peekEx(entry.key().key());
              if (e == null)               break;
              entry.cached(e,entry.keyBytes());
            }
          }
        }
      }
    }
    if (!F.isEmpty(res.invalidPartitions())) {
      for (Iterator<GridCacheTxEntry<K,V>> it=dhtMapping.entries().iterator(); it.hasNext(); ) {
        GridCacheTxEntry<K,V> entry=it.next();
        if (res.invalidPartitions().contains(entry.cached().partition())) {
          it.remove();
          if (log.isDebugEnabled())           log.debug("Removed mapping for entry from dht mapping [key=" + entry.key() + ", tx="+ tx+ ", dhtMapping="+ dhtMapping+ ']');
        }
      }
      if (dhtMapping.empty()) {
        dhtMap.remove(nodeId);
        if (log.isDebugEnabled())         log.debug("Removed mapping for node entirely because all partitions are invalid [nodeId=" + nodeId + ", tx="+ tx+ ']');
      }
    }
    long topVer=tx.topologyVersion();
    boolean rec=cctx.gridEvents().isRecordable(EVT_CACHE_PRELOAD_OBJECT_LOADED);
    for (    GridCacheEntryInfo<K,V> info : res.preloadEntries()) {
      GridCacheContext<K,V> cacheCtx=cctx.cacheContext(info.cacheId());
      while (true) {
        GridCacheEntryEx<K,V> entry=cacheCtx.cache().entryEx(info.key());
        GridDrType drType=cacheCtx.isDrEnabled() ? GridDrType.DR_PRELOAD : GridDrType.DR_NONE;
        try {
          if (entry.initialValue(info.value(),info.valueBytes(),info.version(),info.ttl(),info.expireTime(),true,topVer,drType)) {
            if (rec && !entry.isInternal())             cctx.gridEvents().addEvent(entry.partition(),entry.key(),cctx.localNodeId(),(GridUuid)null,null,EVT_CACHE_PRELOAD_OBJECT_LOADED,info.value(),true,null,false,null,null,null);
          }
          break;
        }
 catch (        GridException e) {
          onDone(e);
          return;
        }
catch (        GridCacheEntryRemovedException ignore) {
          if (log.isDebugEnabled())           log.debug("Failed to set entry initial value (entry is obsolete, " + "will retry): " + entry);
        }
      }
    }
    onDone(tx);
  }
}
