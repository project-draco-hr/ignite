{
  IgniteKernal ignite=(IgniteKernal)startGrid(0);
  generateData(ignite,0,0);
  log.info("Preloading started.");
  long start=System.currentTimeMillis();
  startGrid(1);
  int waitMinorVer=ignite.configuration().isLateAffinityAssignment() ? 1 : 0;
  waitForRebalancing(0,new AffinityTopologyVersion(2,waitMinorVer));
  waitForRebalancing(1,new AffinityTopologyVersion(2,waitMinorVer));
  awaitPartitionMapExchange(true,true);
  checkPartitionMapExchangeFinished();
  checkPartitionMapMessagesAbsent();
  stopGrid(0);
  waitForRebalancing(1,3);
  awaitPartitionMapExchange(true,true);
  checkPartitionMapExchangeFinished();
  checkPartitionMapMessagesAbsent();
  startGrid(2);
  waitForRebalancing(1,new AffinityTopologyVersion(4,waitMinorVer));
  waitForRebalancing(2,new AffinityTopologyVersion(4,waitMinorVer));
  awaitPartitionMapExchange(true,true);
  checkPartitionMapExchangeFinished();
  checkPartitionMapMessagesAbsent();
  stopGrid(2);
  waitForRebalancing(1,5);
  awaitPartitionMapExchange(true,true);
  checkPartitionMapExchangeFinished();
  checkPartitionMapMessagesAbsent();
  long spend=(System.currentTimeMillis() - start) / 1000;
  checkData(grid(1),0,0);
  log.info("Spend " + spend + " seconds to rebalance entries.");
}
