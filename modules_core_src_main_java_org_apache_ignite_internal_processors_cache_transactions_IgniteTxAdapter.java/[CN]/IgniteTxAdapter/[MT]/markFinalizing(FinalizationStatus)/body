{
  boolean res;
switch (status) {
case USER_FINISH:
    res=finalizing.compareAndSet(FinalizationStatus.NONE,FinalizationStatus.USER_FINISH);
  break;
case RECOVERY_WAIT:
finalizing.compareAndSet(FinalizationStatus.NONE,FinalizationStatus.RECOVERY_WAIT);
FinalizationStatus cur=finalizing.get();
res=cur == FinalizationStatus.RECOVERY_WAIT || cur == FinalizationStatus.RECOVERY_FINISH;
break;
case RECOVERY_FINISH:
FinalizationStatus old=finalizing.get();
res=old != FinalizationStatus.USER_FINISH && finalizing.compareAndSet(old,status);
break;
default :
throw new IllegalArgumentException("Cannot set finalization status: " + status);
}
if (res) {
if (log.isDebugEnabled()) log.debug("Marked transaction as finalized: " + this);
}
 else {
if (log.isDebugEnabled()) log.debug("Transaction was not marked finalized: " + this);
}
return res;
}
