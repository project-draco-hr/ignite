{
  GridCacheVersionedEntryEx<K,V> oldEntry=old.versionedEntry();
  if (newVal == null && newValBytes != null)   newVal=cctx.marshaller().unmarshal(newValBytes,cctx.deploy().globalLoader());
  long newExpireTime=newDrExpireTime >= 0L ? newDrExpireTime : CU.toExpireTime(newTtl);
  GridCacheVersionedEntryEx<K,V> newEntry=new GridCachePlainVersionedEntry<>(key,newVal,newTtl,newExpireTime,newVer);
  GridCacheVersionConflictContext<K,V> ctx=old.context().conflictResolve(oldEntry,newEntry,false);
  if (ctx.isMerge()) {
    V resVal=ctx.mergeValue();
    if ((op == CREATE || op == UPDATE) && resVal == null)     op=DELETE;
 else     if (op == DELETE && resVal != null)     op=old.isNewLocked() ? CREATE : UPDATE;
  }
  return F.t(op,ctx);
}
