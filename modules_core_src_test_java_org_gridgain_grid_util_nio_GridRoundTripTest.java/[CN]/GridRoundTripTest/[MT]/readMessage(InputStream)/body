{
  ByteArrayOutputStream tmp=new ByteArrayOutputStream();
  for (int i=0; i < 4; i++) {
    int symbol=in.read();
    if (symbol == -1)     throw new IOException("Connection was closed.");
    tmp.write(symbol);
  }
  int length=U.bytesToInt(tmp.toByteArray(),0);
  tmp.reset();
  for (int i=0; i < length; i++) {
    int symbol=in.read();
    if (symbol == -1)     throw new IOException("Connection was closed.");
    if ((byte)symbol != (byte)i)     throw new IOException("Invalid packet: mismatch in position " + i);
    tmp.write(symbol);
  }
  return tmp.toByteArray();
}
