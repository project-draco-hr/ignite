{
  IgniteConfiguration cfg=getConfiguration();
  String cacheName="test-checkpoints";
  CacheConfiguration cacheCfg=defaultCacheConfiguration();
  cacheCfg.setName(cacheName);
  CacheCheckpointSpi spi=new CacheCheckpointSpi();
  spi.setCacheName(cacheName);
  cfg.setCacheConfiguration(cacheCfg);
  cfg.setCheckpointSpi(spi);
  if (cfg.getMarshaller() instanceof BinaryMarshaller) {
    PortableContext ctx=new PortableContext(BinaryCachingMetadataHandler.create(),cfg);
    Marshaller marsh=cfg.getMarshaller();
    marsh.setContext(new MarshallerContextTestImpl(null));
    IgniteUtils.invoke(BinaryMarshaller.class,marsh,"setPortableContext",ctx,cfg);
  }
  GridSessionCheckpointSelfTest.spi=spi;
  checkCheckpoints(cfg);
}
