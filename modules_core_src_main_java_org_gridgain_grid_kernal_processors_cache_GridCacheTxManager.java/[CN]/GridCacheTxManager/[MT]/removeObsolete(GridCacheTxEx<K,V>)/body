{
  Collection<GridCacheTxEntry<K,V>> entries=(tx.local() && !tx.dht()) ? tx.allEntries() : tx.writeEntries();
  for (  GridCacheTxEntry<K,V> entry : entries) {
    GridCacheEntryEx<K,V> cached=entry.cached();
    GridCacheContext<K,V> cacheCtx=entry.context();
    if (cached == null)     cached=cacheCtx.cache().peekEx(entry.key().key());
    if (cached.detached())     continue;
    try {
      if (cached.obsolete() || cached.markObsoleteIfEmpty(tx.xidVersion()))       cacheCtx.cache().removeEntry(cached);
      if (tx.dht() && isNearEnabled(cacheCtx)) {
        GridNearCacheEntry<K,V> e=cacheCtx.dht().near().peekExx(entry.key().key());
        if (e != null && e.markObsoleteIfEmpty(tx.xidVersion()))         cacheCtx.dht().near().removeEntry(e);
      }
    }
 catch (    GridException e) {
      U.error(log,"Failed to remove obsolete entry from cache: " + cached,e);
    }
  }
}
