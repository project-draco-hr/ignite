{
  GridAffinityAssignment aff=head.get();
  if (aff.topologyVersion().compareTo(topVer) >= 0) {
    if (log.isDebugEnabled())     log.debug("Returning finished future for readyFuture [head=" + aff.topologyVersion() + ", topVer="+ topVer+ ']');
    return null;
  }
  GridFutureAdapter<AffinityTopologyVersion> fut=F.addIfAbsent(readyFuts,topVer,new AffinityReadyFuture(topVer));
  aff=head.get();
  if (aff.topologyVersion().compareTo(topVer) >= 0) {
    if (log.isDebugEnabled())     log.debug("Completing topology ready future right away [head=" + aff.topologyVersion() + ", topVer="+ topVer+ ']');
    fut.onDone(topVer);
  }
 else   if (stopping)   fut.onDone(new IgniteCheckedException("Failed to wait for topology update, cache (or node) is stopping."));
  return fut;
}
