{
  try {
    GridGgfsDataInputStream dis=new GridGgfsDataInputStream(endpoint.inputStream());
    byte[] hdr=new byte[GridGgfsMarshaller.HEADER_SIZE];
    boolean first=true;
    while (!Thread.currentThread().isInterrupted()) {
      dis.readFully(hdr);
      final long reqId=U.bytesToLong(hdr,0);
      int ordinal=U.bytesToInt(hdr,8);
      if (first) {
        if (reqId != 0 || ordinal != GridGgfsIpcCommand.HANDSHAKE.ordinal()) {
          U.warn(log,"Handshake failed.");
          return;
        }
        first=false;
      }
      final GridGgfsIpcCommand cmd=GridGgfsIpcCommand.valueOf(ordinal);
      GridGgfsMessage msg=marsh.unmarshall(cmd,hdr,dis);
      IgniteInternalFuture<GridGgfsMessage> fut=hnd.handleAsync(ses,msg,dis);
      if (fut != null) {
        if (fut.isDone()) {
          GridGgfsMessage res;
          try {
            res=fut.get();
          }
 catch (          IgniteCheckedException e) {
            res=new GridGgfsControlResponse();
            ((GridGgfsControlResponse)res).error(e);
          }
          try {
synchronized (out) {
              GridGgfsMarshaller.fillHeader(hdr,reqId,res.command());
              marsh.marshall(res,hdr,out);
              out.flush();
            }
          }
 catch (          IOException|IgniteCheckedException e) {
            shutdown0(e);
          }
        }
 else {
          fut.listenAsync(new CIX1<IgniteInternalFuture<GridGgfsMessage>>(){
            @Override public void applyx(            IgniteInternalFuture<GridGgfsMessage> fut){
              GridGgfsMessage res;
              try {
                res=fut.get();
              }
 catch (              IgniteCheckedException e) {
                res=new GridGgfsControlResponse();
                ((GridGgfsControlResponse)res).error(e);
              }
              try {
synchronized (out) {
                  byte[] hdr=GridGgfsMarshaller.createHeader(reqId,res.command());
                  marsh.marshall(res,hdr,out);
                  out.flush();
                }
              }
 catch (              IOException|IgniteCheckedException e) {
                shutdown0(e);
              }
            }
          }
);
        }
      }
    }
  }
 catch (  EOFException ignored) {
  }
catch (  IgniteCheckedException|IOException e) {
    if (!isCancelled())     U.error(log,"Failed to read data from client (will close connection)",e);
  }
 finally {
    onFinished();
  }
}
