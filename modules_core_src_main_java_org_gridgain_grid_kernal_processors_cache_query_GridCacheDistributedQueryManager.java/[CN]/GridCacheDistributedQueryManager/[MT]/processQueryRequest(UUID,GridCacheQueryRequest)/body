{
  if (req.cancel()) {
    cancelIds.add(new CancelMessageId(req.id(),sndId));
    if (req.fields())     removeFieldsQueryResult(sndId,req.id());
 else     removeQueryResult(sndId,req.id());
  }
 else {
    if (!cancelIds.contains(new CancelMessageId(req.id(),sndId))) {
      if (!F.eq(req.cacheName(),cctx.name())) {
        GridCacheQueryResponse res=new GridCacheQueryResponse(req.id(),new GridException("Received request for incorrect cache [expected=" + cctx.name() + ", actual="+ req.cacheName()));
        sendQueryResponse(sndId,res,0);
      }
 else {
        threads.put(req.id(),Thread.currentThread());
        try {
          GridCacheQueryInfo info=distributedQueryInfo(sndId,req);
          if (req.fields())           runFieldsQuery(info);
 else           runQuery(info);
        }
 catch (        Throwable e) {
          U.error(log(),"Failed to run query.",e);
          sendQueryResponse(sndId,new GridCacheQueryResponse(req.id(),e.getCause()),0);
        }
 finally {
          threads.remove(req.id());
        }
      }
    }
  }
}
