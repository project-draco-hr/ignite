{
  AffinityTopologyVersion topVer=null;
  IgniteInternalTx tx=cctx.tm().anyActiveThreadTx(null);
  if (tx != null && tx.topologyVersionSnapshot() != null)   topVer=tx.topologyVersionSnapshot();
  if (topVer == null)   topVer=cctx.mvcc().lastExplicitLockTopologyVersion(Thread.currentThread().getId());
  if (topVer == null)   mapOnTopology();
 else {
    topLocked=true;
    remapCnt=1;
    state.map(topVer);
  }
}
