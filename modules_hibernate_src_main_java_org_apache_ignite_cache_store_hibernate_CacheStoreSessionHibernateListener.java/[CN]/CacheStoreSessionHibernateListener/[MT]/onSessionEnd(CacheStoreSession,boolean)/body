{
  Session hibSes=ses.<String,Session>properties().remove(HIBERNATE_SES_KEY);
  if (hibSes != null) {
    try {
      Transaction tx=hibSes.getTransaction();
      if (commit) {
        hibSes.flush();
        if (tx != null)         tx.commit();
      }
 else       if (tx != null)       tx.rollback();
    }
 catch (    HibernateException e) {
      throw new CacheWriterException("Failed to end store session [tx=" + ses.transaction() + ']',e);
    }
 finally {
      hibSes.close();
    }
  }
}
