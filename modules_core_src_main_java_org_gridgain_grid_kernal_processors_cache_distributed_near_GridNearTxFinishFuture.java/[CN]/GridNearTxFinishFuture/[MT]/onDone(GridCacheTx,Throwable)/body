{
  if ((initialized() || err != null)) {
    if (this.tx.onePhaseCommit() && (this.tx.state() == COMMITTING))     this.tx.tmCommit();
    Throwable th=this.err.get();
    if (super.onDone(tx,th != null ? th : err)) {
      if (error() instanceof GridCacheTxHeuristicException) {
        long topVer=this.tx.topologyVersion();
        for (        GridCacheTxEntry<K,V> e : this.tx.writeMap().values()) {
          GridCacheContext<K,V> cacheCtx=e.context();
          try {
            if (e.op() != NOOP && !cacheCtx.affinity().localNode(e.key().key(),topVer)) {
              GridCacheEntryEx<K,V> cacheEntry=cacheCtx.cache().peekEx(e.key().key());
              if (cacheEntry != null)               cacheEntry.invalidate(null,this.tx.xidVersion());
            }
          }
 catch (          Throwable t) {
            U.error(log,"Failed to invalidate entry.",t);
          }
        }
      }
      cctx.mvcc().removeFuture(this);
      return true;
    }
  }
  return false;
}
