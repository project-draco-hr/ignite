{
  try {
    clientMode=false;
    startGrid(0);
    clientMode=true;
    startGrid(1);
    Class procCls=grid(1).configuration().getClassLoader().loadClass(getEntryProcessor());
    Class valCls=grid(1).configuration().getClassLoader().loadClass(TEST_VALUE);
    assertTrue(grid(1).configuration().isClientMode());
    assertFalse(grid(0).configuration().isClientMode());
    IgniteCache cache=getCache();
    HashSet keys=new HashSet();
    for (int i=0; i < 3; i++) {
      String key="key" + i;
      cache.put(key,valCls.newInstance());
      keys.add(key);
    }
    Map<String,EntryProcessorResult> res=(Map<String,EntryProcessorResult>)cache.invokeAll(keys,(CacheEntryProcessor)procCls.newInstance());
    assertEquals(3,res.size());
    for (    EntryProcessorResult result : res.values())     assertTrue((Boolean)result.get());
    for (int i=0; i < 3; i++) {
      String key="key" + i;
      cache.get(key);
    }
  }
  finally {
    stopAllGrids();
  }
}
