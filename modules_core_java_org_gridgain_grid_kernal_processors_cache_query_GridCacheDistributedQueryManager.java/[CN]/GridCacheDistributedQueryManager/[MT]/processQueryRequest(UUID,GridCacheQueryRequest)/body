{
  if (req.cancel()) {
    cancelIds.add(new CancelMessageId(req.id(),sndId));
    if (req.fields())     removeFieldsQueryResult(sndId,req.id());
 else     removeQueryIterator(sndId,req.id());
  }
 else {
    if (!cancelIds.contains(new CancelMessageId(req.id(),sndId))) {
      GridCacheQueryResponse res=null;
      if (!F.eq(req.cacheName(),cctx.name()))       res=new GridCacheQueryResponse(req.id(),true,req.fields());
      if (res == null) {
        threads.put(req.id(),Thread.currentThread());
        try {
          GridCacheQueryInfo info=distributedQueryInfo(sndId,req,req.fields());
          runQuery(info);
        }
 catch (        Throwable e) {
          U.error(log(),"Failed to run query.",e);
          sendQueryResponse(sndId,new GridCacheQueryResponse(req.id(),e.getCause()),0);
        }
 finally {
          threads.remove(req.id());
        }
      }
 else       sendQueryResponse(sndId,res,0);
    }
  }
}
