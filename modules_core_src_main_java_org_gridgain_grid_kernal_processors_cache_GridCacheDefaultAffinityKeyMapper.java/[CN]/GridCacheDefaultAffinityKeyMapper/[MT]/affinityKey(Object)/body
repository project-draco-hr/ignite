{
  GridArgumentCheck.notNull(key,"key");
  if (key instanceof GridPortableObject) {
    GridPortableObject<?> po=(GridPortableObject)key;
    try {
      String affKeyFieldName=po.metaData().affinityKeyFieldName();
      if (affKeyFieldName != null)       return po.field(affKeyFieldName);
    }
 catch (    GridPortableException e) {
      U.error(log,"Failed ",e);
    }
  }
 else {
    try {
      Object o=reflectCache.firstFieldValue(key);
      if (o != null)       return o;
    }
 catch (    GridException e) {
      U.error(log,"Failed to access affinity field for key [field=" + reflectCache.firstField(key.getClass()) + ", key="+ key+ ']',e);
    }
    try {
      Object o=reflectCache.firstMethodValue(key);
      if (o != null)       return o;
    }
 catch (    GridException e) {
      U.error(log,"Failed to invoke affinity method for key [mtd=" + reflectCache.firstMethod(key.getClass()) + ", key="+ key+ ']',e);
    }
  }
  return key;
}
