{
  GridArgumentCheck.notNull(key,"key");
  if (key instanceof PortableObject) {
    PortableObject po=(PortableObject)key;
    try {
      PortableMetadata meta=po.metaData();
      if (meta != null) {
        String affKeyFieldName=meta.affinityKeyFieldName();
        if (affKeyFieldName != null)         return po.field(affKeyFieldName);
      }
    }
 catch (    PortableException e) {
      U.error(log,"Failed to get affinity field from portable object: " + key,e);
    }
  }
 else {
    try {
      Object o=reflectCache.firstFieldValue(key);
      if (o != null)       return o;
    }
 catch (    IgniteCheckedException e) {
      U.error(log,"Failed to access affinity field for key [field=" + reflectCache.firstField(key.getClass()) + ", key="+ key+ ']',e);
    }
    try {
      Object o=reflectCache.firstMethodValue(key);
      if (o != null)       return o;
    }
 catch (    IgniteCheckedException e) {
      U.error(log,"Failed to invoke affinity method for key [mtd=" + reflectCache.firstMethod(key.getClass()) + ", key="+ key+ ']',e);
    }
  }
  return key;
}
