{
  if (needCopy(ctx)) {
    if (val instanceof byte[]) {
      byte[] byteArr=(byte[])val;
      return new CacheObjectImpl(Arrays.copyOf(byteArr,byteArr.length),null);
    }
 else {
      try {
        if (valBytes == null)         valBytes=ctx.processor().marshal(ctx,val);
        if (ctx.unmarshalValues()) {
          ClassLoader ldr=ctx.p2pEnabled() ? IgniteUtils.detectClass(this.val).getClassLoader() : val.getClass().getClassLoader();
          Object val=ctx.processor().unmarshal(ctx,valBytes,ldr);
          return new CacheObjectImpl(val,valBytes);
        }
        return new CacheObjectImpl(null,valBytes);
      }
 catch (      IgniteCheckedException e) {
        throw new IgniteException("Failed to marshal object: " + val,e);
      }
    }
  }
 else   return new CacheObjectImpl(val,valBytes);
}
