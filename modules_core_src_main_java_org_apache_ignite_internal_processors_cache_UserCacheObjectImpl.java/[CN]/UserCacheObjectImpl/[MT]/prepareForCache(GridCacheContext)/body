{
  if (needCopy(ctx)) {
    if (val instanceof byte[]) {
      byte[] byteArr=(byte[])val;
      return new CacheObjectImpl(Arrays.copyOf(byteArr,byteArr.length),null);
    }
 else {
      try {
        if (valBytes == null)         valBytes=ctx.portable().marshal(ctx.cacheObjectContext(),val);
        return new CacheObjectImpl(null,valBytes);
      }
 catch (      IgniteCheckedException e) {
        throw new IgniteException("Failed to marshal object: " + val,e);
      }
    }
  }
 else   return new CacheObjectImpl(val,valBytes);
}
