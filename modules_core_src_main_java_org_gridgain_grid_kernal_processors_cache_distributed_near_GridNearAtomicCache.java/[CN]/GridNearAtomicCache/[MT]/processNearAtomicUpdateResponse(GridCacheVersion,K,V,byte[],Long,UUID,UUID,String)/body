{
  try {
    while (true) {
      GridCacheEntryEx<K,V> entry=null;
      long topVer=ctx.affinity().affinityTopologyVersion();
      try {
        entry=entryEx(key,topVer);
        GridCacheOperation op=(val != null || valBytes != null) ? UPDATE : DELETE;
        GridCacheUpdateAtomicResult<K,V> updRes=entry.innerUpdate(ver,nodeId,nodeId,op,val,valBytes,false,false,ttl,true,true,false,true,CU.<K,V>empty(),DR_NONE,-1,-1,null,false,false,subjId,taskName);
        if (updRes.removeVersion() != null)         ctx.onDeferredDelete(entry,updRes.removeVersion());
        break;
      }
 catch (      GridCacheEntryRemovedException ignored) {
        if (log.isDebugEnabled())         log.debug("Got removed entry while updating near cache value (will retry): " + key);
        entry=null;
      }
 finally {
        if (entry != null)         ctx.evicts().touch(entry,topVer);
      }
    }
  }
 catch (  GridDhtInvalidPartitionException ignored) {
  }
}
