{
  U.setWorkDirectory(null,U.getIgniteHome());
  spis.clear();
  nodes.clear();
  spiRsrcs.clear();
  Map<ClusterNode,GridSpiTestContext> ctxs=new HashMap<>();
  for (int i=0; i < getSpiCount(); i++) {
    CommunicationSpi<Message> spi=getSpi(i);
    GridTestUtils.setFieldValue(spi,IgniteSpiAdapter.class,"gridName","grid-" + i);
    IgniteTestResources rsrcs=new IgniteTestResources();
    GridTestNode node=new GridTestNode(rsrcs.getNodeId());
    node.order(i);
    GridSpiTestContext ctx=initSpiContext();
    ctx.setLocalNode(node);
    info(">>> Initialized context: nodeId=" + ctx.localNode().id());
    spiRsrcs.add(rsrcs);
    rsrcs.inject(spi);
    if (useSsl) {
      IgniteMock ignite=GridTestUtils.getFieldValue(spi,IgniteSpiAdapter.class,"ignite");
      IgniteConfiguration cfg=ignite.configuration().setSslContextFactory(GridTestUtils.sslFactory());
      ignite.setStaticCfg(cfg);
    }
    spi.setListener(new MessageListener(rsrcs.getNodeId()));
    node.setAttributes(spi.getNodeAttributes());
    node.setAttribute(ATTR_MACS,F.concat(U.allLocalMACs(),", "));
    nodes.add(node);
    spi.spiStart(getTestGridName() + (i + 1));
    spis.put(rsrcs.getNodeId(),spi);
    spi.onContextInitialized(ctx);
    ctxs.put(node,ctx);
  }
  for (  Entry<ClusterNode,GridSpiTestContext> e : ctxs.entrySet()) {
    for (    ClusterNode n : nodes) {
      if (!n.equals(e.getKey()))       e.getValue().remoteNodes().add(n);
    }
  }
}
