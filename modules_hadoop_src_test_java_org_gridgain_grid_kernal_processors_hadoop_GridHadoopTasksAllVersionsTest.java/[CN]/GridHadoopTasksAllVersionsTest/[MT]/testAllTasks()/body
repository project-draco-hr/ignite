{
  Path outputDir=Files.createTempDirectory(GridHadoopWordCount2.class.getSimpleName() + "-output");
  try {
    URI testOutputDirURI=URI.create(outputDir.toString());
    File testInputFile=File.createTempFile(GridHadoopWordCount2.class.getSimpleName(),"-input");
    testInputFile.deleteOnExit();
    URI testInputFileURI=URI.create(testInputFile.getAbsolutePath());
    generateTestFile(testInputFile,"red",100,"blue",200,"green",150,"yellow",70);
    Long l=testInputFile.length() / 2;
    GridHadoopFileBlock fileBlock1=new GridHadoopFileBlock(HOSTS,testInputFileURI,0,l);
    GridHadoopFileBlock fileBlock2=new GridHadoopFileBlock(HOSTS,testInputFileURI,l,testInputFile.length() - l);
    GridHadoopJob gridJob=getHadoopJob(testInputFileURI.toString(),testOutputDirURI.toString());
    GridHadoopTestTaskContext combine1Ctx=runMapCombineTask(fileBlock1,gridJob);
    GridHadoopTestTaskContext combine2Ctx=runMapCombineTask(fileBlock2,gridJob);
    GridHadoopTestTaskContext reduceCtx=new GridHadoopTestTaskContext(gridJob);
    reduceCtx.makeTreeOfWritables(combine1Ctx.mockOutput());
    reduceCtx.makeTreeOfWritables(combine2Ctx.mockOutput());
    GridHadoopTaskInfo taskInfo=new GridHadoopTaskInfo(null,GridHadoopTaskType.REDUCE,gridJob.id(),0,0,null);
    GridHadoopTask task=gridJob.createTask(taskInfo);
    task.run(reduceCtx);
    taskInfo=new GridHadoopTaskInfo(null,GridHadoopTaskType.COMMIT,gridJob.id(),0,0,null);
    task=gridJob.createTask(taskInfo);
    task.run(reduceCtx);
    assertEquals("blue\t200\n" + "green\t150\n" + "red\t100\n"+ "yellow\t70\n",readAndSortFile(outputDir + "/" + getOutputFileNamePrefix()+ "00000"));
  }
  finally {
    FileUtils.deleteDirectory(outputDir.toFile());
  }
}
