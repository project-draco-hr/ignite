{
  GridConfiguration cfg=super.getConfiguration(gridName);
  GridTcpDiscoverySpi spi;
  if (gridName.contains("FailBeforeNodeAddedSentSpi"))   spi=new FailBeforeNodeAddedSentSpi();
 else   if (gridName.contains("FailBeforeNodeLeftSentSpi"))   spi=new FailBeforeNodeLeftSentSpi();
 else   spi=new GridTcpDiscoverySpi();
  discoMap.put(gridName,spi);
  spi.setIpFinder(ipFinder);
  spi.setNetworkTimeout(2500);
  spi.setHeartbeatFrequency(1000);
  spi.setMaxMissedHeartbeats(3);
  spi.setStoresCleanFrequency(5000);
  spi.setJoinTimeout(5000);
  cfg.setDiscoverySpi(spi);
  cfg.setCacheConfiguration();
  cfg.setIncludeEventTypes(EVT_TASK_FAILED,EVT_TASK_FINISHED,EVT_JOB_MAPPED);
  cfg.setIncludeProperties();
  if (!gridName.contains("LoopbackProblemTest"))   cfg.setLocalHost("127.0.0.1");
  if (gridName.contains("testFailureDetectionOnNodePing")) {
    spi.setReconnectCount(1);
    spi.setHeartbeatFrequency(40000);
  }
  cfg.setRestEnabled(false);
  if (nodeId != null)   cfg.setNodeId(nodeId);
  if (gridName.contains("NonSharedIpFinder")) {
    GridTcpDiscoveryVmIpFinder finder=new GridTcpDiscoveryVmIpFinder();
    finder.setAddresses(Arrays.asList("127.0.0.1:47501"));
    spi.setIpFinder(finder);
  }
 else   if (gridName.contains("MulticastIpFinder")) {
    GridTcpDiscoveryMulticastIpFinder finder=new GridTcpDiscoveryMulticastIpFinder();
    finder.setAddressRequestAttempts(10);
    finder.setMulticastGroup(GridTestUtils.getNextMulticastGroup(getClass()));
    finder.setMulticastPort(GridTestUtils.getNextMulticastPort(getClass()));
    spi.setIpFinder(finder);
    if (U.isMacOs())     spi.setLocalAddress(F.first(U.allLocalIps()));
  }
  if (gridName.contains("MetricsStore"))   spi.setMetricsStore(metricsStore);
  return cfg;
}
