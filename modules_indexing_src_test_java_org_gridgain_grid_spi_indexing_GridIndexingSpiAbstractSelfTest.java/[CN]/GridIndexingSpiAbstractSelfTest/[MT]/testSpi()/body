{
  X spi=getSpi();
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeAA.space(),typeAA);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeAB.space(),typeAB);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeBA.space(),typeBA);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  assertFalse(spi.query(typeAA.space(),"select * from A.A",Collections.emptySet(),typeAA,null).hasNext());
  assertFalse(spi.query(typeAB.space(),"select * from A.B",Collections.emptySet(),typeAB,null).hasNext());
  assertFalse(spi.query(typeBA.space(),"select * from B.A",Collections.emptySet(),typeBA,null).hasNext());
  assertFalse(spi.remove("A",new IndexingEntityAdapter<>(1,null)));
  assertFalse(spi.remove("B",new IndexingEntityAdapter<>(1,null)));
  spi.store(typeAA.space(),typeAA,entity(1),entity(aa(1,"Vasya",10)),"v1".getBytes(),0);
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.store(typeAB.space(),typeAB,entity(1),entity(ab(1,"Vasya",20,"Some text about Vasya goes here.")),"v2".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.store(typeBA.space(),typeBA,entity(1),entity(ba(2,"Petya",25,true)),"v3".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeBA.space(),typeBA,entity(1),entity(ba(2,"Kolya",25,true)),"v4".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAA.space(),typeAA,entity(2),entity(aa(2,"Valera",19)),"v5".getBytes(),0);
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAA.space(),typeAA,entity(3),entity(aa(3,"Borya",18)),"v6".getBytes(),0);
  assertEquals(2,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAB.space(),typeAB,entity(4),entity(ab(4,"Vitalya",20,"Very Good guy")),"v7".getBytes(),0);
  assertEquals(2,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  Iterator<IndexingKeyValueRow<Integer,Map<String,Object>>> res=spi.query(typeAA.space(),"select * from a order by age",Collections.emptySet(),typeAA,null);
  assertTrue(res.hasNext());
  assertEquals(aa(3,"Borya",18),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(aa(2,"Valera",19),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.query(typeAB.space(),"select * from b order by name",Collections.emptySet(),typeAB,null);
  assertTrue(res.hasNext());
  assertEquals(ab(1,"Vasya",20,"Some text about Vasya goes here."),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(ab(4,"Vitalya",20,"Very Good guy"),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.query(typeBA.space(),"select * from a",Collections.emptySet(),typeBA,null);
  assertTrue(res.hasNext());
  assertEquals(ba(2,"Kolya",25,true),value(res.next()));
  assertFalse(res.hasNext());
  Iterator<IndexingKeyValueRow<Integer,Map<String,Object>>> txtRes=spi.queryText(typeAB.space(),"good",typeAB,null);
  assertTrue(txtRes.hasNext());
  assertEquals(ab(4,"Vitalya",20,"Very Good guy"),value(txtRes.next()));
  assertFalse(txtRes.hasNext());
  IndexingFieldsResult fieldsRes=spi.queryFields(null,"select a.a.name n1, a.a.age a1, b.a.name n2, " + "b.a.age a2 from a.a, b.a where a.a.id = b.a.id ",Collections.emptySet(),null);
  String[] aliases={"N1","A1","N2","A2"};
  Object[] vals={"Valera",19,"Kolya",25};
  assertTrue(fieldsRes.iterator().hasNext());
  List<IndexingEntity<?>> fields=fieldsRes.iterator().next();
  assertEquals(4,fields.size());
  int i=0;
  for (  IndexingEntity<?> f : fields) {
    assertEquals(aliases[i],fieldsRes.metaData().get(i).fieldName());
    assertEquals(vals[i++],f.value());
  }
  assertFalse(fieldsRes.iterator().hasNext());
  assertFalse(spi.queryFields(null,"select * from not_existing_table",Collections.emptySet(),null).iterator().hasNext());
  spi.remove(typeAA.space(),entity(2));
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.remove(typeBA.space(),entity(1));
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  boolean h2IdxOffheap=(spi instanceof GridH2IndexingSpi) && ((GridH2IndexingSpiMBean)spi).getMaxOffHeapMemory() > 0;
  if (!h2IdxOffheap) {
    spi.rebuildIndexes(typeAB.space(),typeAB);
    assertEquals(1,spi.size(typeAA.space(),typeAA));
    assertEquals(2,spi.size(typeAB.space(),typeAB));
    assertEquals(0,spi.size(typeBA.space(),typeBA));
    spi.rebuildIndexes("not_existing_space",typeAA);
    spi.rebuildIndexes(typeAA.space(),new TypeDesc("C","C",fieldsAA,null));
  }
  spi.unregisterType(typeAA.space(),typeAA);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.unregisterType(typeAB.space(),typeAB);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.unregisterType(typeBA.space(),typeBA);
  spi.store(typeAA.space(),typeAA,entity(10),entity(aa(1,"Fail",100500)),"v220".getBytes(),0);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
}
