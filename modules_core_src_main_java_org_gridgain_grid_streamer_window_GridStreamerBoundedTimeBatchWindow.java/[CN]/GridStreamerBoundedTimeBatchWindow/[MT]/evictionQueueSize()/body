{
  WindowHolder win=ref.get();
  int oversizeCnt=maxBatches > 0 ? Math.max(0,win.batchQueueSize().get() - maxBatches) : 0;
  long now=U.currentTimeMillis();
  Iterator<Batch> it=win.batchQueue().iterator();
  int size=0;
  int idx=0;
  while (it.hasNext()) {
    Batch batch=it.next();
    if (idx++ < oversizeCnt || batch.batchEndTs < now)     size+=batch.size();
  }
  return size;
}
