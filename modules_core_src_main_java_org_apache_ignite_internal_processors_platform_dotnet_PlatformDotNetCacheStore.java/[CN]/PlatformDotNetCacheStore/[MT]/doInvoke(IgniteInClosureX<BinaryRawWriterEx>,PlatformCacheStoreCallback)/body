{
  try (PlatformMemory mem=platformCtx.memory().allocate()){
    PlatformOutputStream out=mem.output();
    BinaryRawWriterEx writer=platformCtx.writer(out);
    task.apply(writer);
    out.synchronize();
    int res=platformCtx.gateway().cacheStoreInvoke(ptr,mem.pointer(),cb);
    if (res != 0) {
      Object nativeErr=platformCtx.reader(mem.input()).readObjectDetached();
      throw platformCtx.createNativeException(nativeErr);
    }
  }
 }
