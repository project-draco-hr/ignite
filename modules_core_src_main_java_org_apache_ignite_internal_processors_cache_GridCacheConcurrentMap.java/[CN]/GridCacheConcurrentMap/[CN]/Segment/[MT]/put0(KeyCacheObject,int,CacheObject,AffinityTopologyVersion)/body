{
  try {
    int c=size;
    if (c++ > threshold)     rehash();
    HashEntry[] tab=tbl;
    int idx=hash & (tab.length - 1);
    HashEntry bin=tab[idx];
    HashEntry e=bin;
    while (e != null && (e.mapEntry.hash() != hash || !key.equals(e.mapEntry.key())))     e=e.next;
    GridCacheMapEntry retVal;
    if (e != null) {
      retVal=e.mapEntry;
      retVal.rawPut(val,0);
    }
 else {
      HashEntry next=bin != null ? bin : null;
      GridCacheMapEntry newEntry=factory.create(ctx,topVer,key,hash,val);
      tab[idx]=new HashEntry(newEntry,next);
      retVal=newEntry;
      if (!retVal.isInternal()) {
        mapPubSize.increment();
        pubSize.increment();
      }
      mapSize.increment();
      size=c;
    }
    return retVal;
  }
  finally {
    if (DEBUG)     checkSegmentConsistency();
  }
}
