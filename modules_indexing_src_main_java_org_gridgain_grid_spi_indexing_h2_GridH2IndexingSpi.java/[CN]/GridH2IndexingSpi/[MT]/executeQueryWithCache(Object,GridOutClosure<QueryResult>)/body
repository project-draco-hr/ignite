{
  GridFutureAdapterEx<QueryResult> fut=new GridFutureAdapterEx<>();
  ConcurrentMap<Object,GridFutureAdapterEx<QueryResult>> qryResCache0=qryResCache;
  GridFutureAdapterEx<QueryResult> old=qryResCache0.putIfAbsent(key,fut);
  if (old == null) {
    try {
      fut.onDone(qryClos.apply());
    }
 catch (    Throwable err) {
      fut.onDone(err);
    }
 finally {
      if (qryResCache0 == qryResCache)       qryResCache0.remove(key,fut);
    }
  }
 else   fut=old;
  try {
    return fut.get();
  }
 catch (  GridException e) {
    throw new GridSpiException(e);
  }
}
