{
  if (log.isDebugEnabled())   log.debug("Stopping cache query index...");
  if (ctxInitLatch.getCount() != 0)   ctxInitLatch.countDown();
  unregisterMBean();
  Connection conn=connectionForThread(null);
  for (  ConcurrentMap<String,TableDescriptor> m : schemas.values()) {
    for (    TableDescriptor desc : m.values()) {
      desc.tbl.close();
      if (desc.luceneIdx != null)       U.closeQuiet(desc.luceneIdx);
    }
  }
  if (conn != null) {
    Statement stmt=null;
    try {
      stmt=conn.createStatement();
      stmt.execute("DROP ALL OBJECTS DELETE FILES");
      stmt.execute("SHUTDOWN");
    }
 catch (    SQLException e) {
      throw new GridSpiException("Failed to shutdown database.",e);
    }
 finally {
      U.close(stmt,log);
    }
  }
  for (  Connection c : conns)   U.close(c,log);
  conns.clear();
  schemas.clear();
  rowCache.clear();
  if (log.isDebugEnabled())   log.debug("Cache query index stopped [cache=" + getName() + "]");
}
