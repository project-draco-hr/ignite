{
  final IgniteKernal kernal=(IgniteKernal)grid(0);
  CacheConfiguration ccfg=new CacheConfiguration();
  ccfg.setWriteSynchronizationMode(CacheWriteSynchronizationMode.FULL_SYNC);
  ccfg.setAtomicityMode(mode);
  ccfg.setName(CACHE_NAME);
  kernal.context().cache().dynamicStartCache(ccfg,F.<ClusterNode>alwaysTrue()).get();
  for (int g=0; g < nodeCount(); g++) {
    IgniteKernal kernal0=(IgniteKernal)grid(g);
    for (    IgniteInternalFuture f : kernal0.context().cache().context().exchange().exchangeFutures())     f.get();
    assertNotNull(grid(g).jcache(CACHE_NAME));
  }
  grid(0).jcache(CACHE_NAME).put("1","1");
  for (int g=0; g < nodeCount(); g++)   assertEquals("1",grid(g).jcache(CACHE_NAME).get("1"));
  final IgniteCache[] caches=new IgniteCache[nodeCount()];
  for (int g=0; g < nodeCount(); g++)   caches[g]=grid(g).jcache(CACHE_NAME);
  kernal.context().cache().dynamicStopCache(CACHE_NAME).get();
  for (int g=0; g < nodeCount(); g++) {
    final IgniteKernal kernal0=(IgniteKernal)grid(g);
    final int idx=g;
    for (    IgniteInternalFuture f : kernal0.context().cache().context().exchange().exchangeFutures())     f.get();
    GridTestUtils.assertThrows(log,new Callable<Object>(){
      @Override public Object call() throws Exception {
        return kernal0.jcache(CACHE_NAME);
      }
    }
,IllegalArgumentException.class,null);
    GridTestUtils.assertThrows(log,new Callable<Object>(){
      @Override public Object call() throws Exception {
        return caches[idx].get("1");
      }
    }
,IllegalStateException.class,null);
  }
}
