{
  if (msg.verified()) {
    DiscoverySpiListener lsnr=TcpClientDiscoverySpi.this.lsnr;
    if (lsnr != null) {
      TcpDiscoveryNode node=nodeId.equals(getLocalNodeId()) ? locNode : rmtNodes.get(nodeId);
      if (node != null && node.visible()) {
        try {
          Serializable msgObj=marsh.unmarshal(msg.messageBytes(),U.gridClassLoader());
          notifyDiscovery(EVT_DISCOVERY_CUSTOM_EVT,topVer,node,allNodes(),msgObj);
        }
 catch (        IgniteCheckedException e) {
          U.error(log,"Failed to unmarshal discovery custom message.",e);
        }
      }
 else       if (log.isDebugEnabled())       log.debug("Received metrics from unknown node: " + nodeId);
    }
  }
 else {
    if (getLocalNodeId().equals(msg.creatorNodeId())) {
      Socket sock0=sock;
      if (sock0 != null) {
        try {
          writeToSocket(sock0,msg);
          if (log.isDebugEnabled())           log.debug("Heartbeat message sent [sock=" + sock0 + ", msg="+ msg+ ']');
        }
 catch (        IOException|IgniteCheckedException e) {
          if (log.isDebugEnabled())           U.error(log,"Failed to send custom message [sock=" + sock0 + ", msg="+ msg+ ']',e);
          U.closeQuiet(sock0);
          sock=null;
          interrupt();
        }
      }
 else       if (log.isDebugEnabled())       log.debug("Failed to send custom message (node is disconnected): " + msg);
    }
  }
}
