{
  info("TEST: Start test testAffinityDeployUpdateTopology");
  Ignite g=randomGrid();
  info("TEST: get random grid");
  final Integer affKey=1;
  info("TEST: try put key");
  g.jcache(CACHE_NAME).put(affKey,affKey.toString());
  info("TEST: put key");
  String name="serviceAffinityUpdateTopology";
  IgniteServices svcs=g.services().withAsync();
  info("TEST: get ignite service");
  svcs.deployKeyAffinitySingleton(name,new AffinityService(affKey),CACHE_NAME,affKey);
  info("TEST: deploy affinity singleton");
  IgniteFuture<?> fut=svcs.future();
  info("Deployed service: " + name);
  fut.get();
  info("Finished waiting for service future: " + name);
  checkCount(name,g.services().serviceDescriptors(),1);
  int nodeCnt=2;
  startExtraNodes(nodeCnt);
  try {
    checkCount(name,g.services().serviceDescriptors(),1);
  }
  finally {
    stopExtraNodes(nodeCnt);
  }
}
