{
  IgniteConfiguration cfg=super.getConfiguration(gridName);
  TestTcpDiscoverySpi disco=new TestTcpDiscoverySpi();
  disco.setMaxMissedClientHeartbeats(maxMissedClientHbs);
  if (gridName.startsWith("server"))   disco.setIpFinder(IP_FINDER);
 else   if (gridName.startsWith("client")) {
    cfg.setClientMode(true);
    TcpDiscoveryVmIpFinder ipFinder;
    if (clientIpFinder != null)     ipFinder=clientIpFinder;
 else {
      ipFinder=new TcpDiscoveryVmIpFinder();
      String addr=new ArrayList<>(IP_FINDER.getRegisteredAddresses()).get((clientIdx.get() - 1) / clientsPerSrv).toString();
      if (addr.startsWith("/"))       addr=addr.substring(1);
      ipFinder.setAddresses(Collections.singletonList(addr));
    }
    disco.setIpFinder(ipFinder);
    String nodeId=cfg.getNodeId().toString();
    nodeId="cc" + nodeId.substring(2);
    cfg.setNodeId(UUID.fromString(nodeId));
  }
 else   throw new IllegalArgumentException();
  if (longSockTimeouts) {
    disco.setAckTimeout(2000);
    disco.setSocketTimeout(2000);
  }
  disco.setJoinTimeout(joinTimeout);
  disco.setNetworkTimeout(netTimeout);
  disco.afterWrite(afterWrite);
  cfg.setDiscoverySpi(disco);
  if (nodeId != null)   cfg.setNodeId(nodeId);
  return cfg;
}
