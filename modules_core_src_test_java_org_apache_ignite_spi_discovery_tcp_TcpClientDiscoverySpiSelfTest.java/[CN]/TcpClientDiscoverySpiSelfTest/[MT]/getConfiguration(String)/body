{
  IgniteConfiguration cfg=super.getConfiguration(gridName);
  if (gridName.startsWith("server")) {
    TcpDiscoverySpi disco=new TcpDiscoverySpi();
    disco.setIpFinder(IP_FINDER);
    cfg.setDiscoverySpi(disco);
  }
 else   if (gridName.startsWith("client")) {
    TcpClientDiscoverySpi disco=new TestTcpClientDiscovery();
    disco.setJoinTimeout(joinTimeout);
    TcpDiscoveryVmIpFinder ipFinder;
    if (clientIpFinder != null)     ipFinder=clientIpFinder;
 else {
      ipFinder=new TcpDiscoveryVmIpFinder();
      String addr=new ArrayList<>(IP_FINDER.getRegisteredAddresses()).get((clientIdx.get() - 1) / clientsPerSrv).toString();
      if (addr.startsWith("/"))       addr=addr.substring(1);
      ipFinder.setAddresses(Collections.singletonList(addr));
    }
    disco.setIpFinder(ipFinder);
    cfg.setDiscoverySpi(disco);
    String nodeId=cfg.getNodeId().toString();
    nodeId="cc" + nodeId.substring(2);
    cfg.setNodeId(UUID.fromString(nodeId));
  }
  if (nodeId != null)   cfg.setNodeId(nodeId);
  return cfg;
}
