{
  DiscoverySpiListener lsnr=TcpDiscoverySpi.this.lsnr;
  TcpDiscoverySpiState spiState=spiStateCopy();
  Map<Long,Collection<ClusterNode>> hist;
synchronized (mux) {
    hist=new TreeMap<>(topHist);
  }
  Collection<ClusterNode> snapshot=hist.get(msg.topologyVersion());
  if (lsnr != null && (spiState == CONNECTED || spiState == DISCONNECTING)) {
    TcpDiscoveryNode node=ring.node(msg.creatorNodeId());
    if (node != null) {
      try {
        DiscoverySpiCustomMessage msgObj=msg.message(marsh);
        lsnr.onDiscovery(DiscoveryCustomEvent.EVT_DISCOVERY_CUSTOM_EVT,msg.topologyVersion(),node,snapshot,hist,msgObj);
        if (msgObj.isMutable())         msg.message(msgObj,marsh.marshal(msgObj));
      }
 catch (      Throwable e) {
        U.error(log,"Failed to unmarshal discovery custom message.",e);
      }
    }
  }
}
