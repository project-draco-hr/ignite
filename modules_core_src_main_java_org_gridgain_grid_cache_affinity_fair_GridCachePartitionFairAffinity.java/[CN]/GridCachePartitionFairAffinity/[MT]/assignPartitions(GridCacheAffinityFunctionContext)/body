{
  List<GridNode> topSnapshot=ctx.currentTopologySnapshot();
  if (topSnapshot.size() == 1) {
    GridNode primary=topSnapshot.get(0);
    List<List<GridNode>> assignments=new ArrayList<>(parts);
    for (int i=0; i < parts; i++)     assignments.add(Collections.singletonList(primary));
    return assignments;
  }
  GridBiTuple<List<List<GridNode>>,Map<UUID,PartitionSet>> cp=createCopy(ctx,topSnapshot);
  List<List<GridNode>> assignment=cp.get1();
  int tiers=Math.min(ctx.backups() + 1,topSnapshot.size());
  Map<Integer,Queue<Integer>> pendingParts=new HashMap<>();
  FullAssignmentMap fullMap=new FullAssignmentMap(tiers,assignment,topSnapshot);
  for (int tier=0; tier < tiers; tier++) {
    Queue<Integer> pending=pendingParts.get(tier);
    for (int part=0; part < parts; part++) {
      if (fullMap.assignments.get(part).size() < tier + 1) {
        if (pending == null) {
          pending=new LinkedList<>();
          pendingParts.put(tier,pending);
        }
        if (!pending.contains(part))         pending.add(part);
      }
    }
    assignPending(tier,pendingParts,fullMap,topSnapshot);
    balance(tier,pendingParts,fullMap,topSnapshot);
  }
  return fullMap.assignments;
}
