{
  IgniteH2Indexing spi=getIndexing();
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeAA.space(),typeAA);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeAB.space(),typeAB);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(-1,spi.size(typeBA.space(),typeBA));
  spi.registerType(typeBA.space(),typeBA);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  assertFalse(spi.queryLocalSql(typeAA.space(),"select * from A.A",Collections.emptySet(),typeAA,null).hasNext());
  assertFalse(spi.queryLocalSql(typeAB.space(),"select * from A.B",Collections.emptySet(),typeAB,null).hasNext());
  assertFalse(spi.queryLocalSql(typeBA.space(),"select * from B.A",Collections.emptySet(),typeBA,null).hasNext());
  assertFalse(spi.queryLocalSql(typeBA.space(),"select * from B.A, A.B, A.A",Collections.emptySet(),typeBA,null).hasNext());
  try {
    spi.queryLocalSql(typeBA.space(),"select aa.*, ab.*, ba.* from A.A aa, A.B ab, B.A ba",Collections.emptySet(),typeBA,null).hasNext();
    fail("Enumerations of aliases in select block must be prohibited");
  }
 catch (  IgniteCheckedException e) {
  }
  assertFalse(spi.queryLocalSql(typeAB.space(),"select ab.* from A.B ab",Collections.emptySet(),typeAB,null).hasNext());
  assertFalse(spi.queryLocalSql(typeBA.space(),"select   ba.*   from B.A  as ba",Collections.emptySet(),typeBA,null).hasNext());
  spi.remove("A",key(1),aa(1,"",10));
  spi.remove("B",key(1),ba(1,"",10,true));
  spi.store(typeAA.space(),typeAA,key(1),aa(1,"Vasya",10),"v1".getBytes(),0);
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(0,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.store(typeAB.space(),typeAB,key(1),ab(1,"Vasya",20,"Some text about Vasya goes here."),"v2".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.store(typeBA.space(),typeBA,key(1),ba(2,"Petya",25,true),"v3".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeBA.space(),typeBA,key(1),ba(2,"Kolya",25,true),"v4".getBytes(),0);
  assertEquals(0,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAA.space(),typeAA,key(2),aa(2,"Valera",19),"v5".getBytes(),0);
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAA.space(),typeAA,key(3),aa(3,"Borya",18),"v6".getBytes(),0);
  assertEquals(2,spi.size(typeAA.space(),typeAA));
  assertEquals(1,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.store(typeAB.space(),typeAB,key(4),ab(4,"Vitalya",20,"Very Good guy"),"v7".getBytes(),0);
  assertEquals(2,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  Iterator<IgniteBiTuple<Integer,Map<String,Object>>> res=spi.queryLocalSql(typeAA.space(),"from a order by age",Collections.emptySet(),typeAA,null);
  assertTrue(res.hasNext());
  assertEquals(aa(3,"Borya",18).value(null,false),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(aa(2,"Valera",19).value(null,false),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.queryLocalSql(typeAA.space(),"select aa.* from a aa order by aa.age",Collections.emptySet(),typeAA,null);
  assertTrue(res.hasNext());
  assertEquals(aa(3,"Borya",18).value(null,false),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(aa(2,"Valera",19).value(null,false),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.queryLocalSql(typeAB.space(),"from b order by name",Collections.emptySet(),typeAB,null);
  assertTrue(res.hasNext());
  assertEquals(ab(1,"Vasya",20,"Some text about Vasya goes here.").value(null,false),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(ab(4,"Vitalya",20,"Very Good guy").value(null,false),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.queryLocalSql(typeAB.space(),"select bb.* from b as bb order by bb.name",Collections.emptySet(),typeAB,null);
  assertTrue(res.hasNext());
  assertEquals(ab(1,"Vasya",20,"Some text about Vasya goes here.").value(null,false),value(res.next()));
  assertTrue(res.hasNext());
  assertEquals(ab(4,"Vitalya",20,"Very Good guy").value(null,false),value(res.next()));
  assertFalse(res.hasNext());
  res=spi.queryLocalSql(typeBA.space(),"from a",Collections.emptySet(),typeBA,null);
  assertTrue(res.hasNext());
  assertEquals(ba(2,"Kolya",25,true).value(null,false),value(res.next()));
  assertFalse(res.hasNext());
  Iterator<IgniteBiTuple<Integer,Map<String,Object>>> txtRes=spi.queryLocalText(typeAB.space(),"good",typeAB,null);
  assertTrue(txtRes.hasNext());
  assertEquals(ab(4,"Vitalya",20,"Very Good guy").value(null,false),value(txtRes.next()));
  assertFalse(txtRes.hasNext());
  GridQueryFieldsResult fieldsRes=spi.queryLocalSqlFields("A","select a.a.name n1, a.a.age a1, b.a.name n2, " + "b.a.age a2 from a.a, b.a where a.a.id = b.a.id ",Collections.emptySet(),null,false);
  String[] aliases={"N1","A1","N2","A2"};
  Object[] vals={"Valera",19,"Kolya",25};
  assertTrue(fieldsRes.iterator().hasNext());
  List<?> fields=fieldsRes.iterator().next();
  assertEquals(4,fields.size());
  int i=0;
  for (  Object f : fields) {
    assertEquals(aliases[i],fieldsRes.metaData().get(i).fieldName());
    assertEquals(vals[i++],f);
  }
  assertFalse(fieldsRes.iterator().hasNext());
  spi.remove(typeAA.space(),key(2),aa(2,"Valera",19));
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(1,spi.size(typeBA.space(),typeBA));
  spi.remove(typeBA.space(),key(1),ba(2,"Kolya",25,true));
  assertEquals(1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  boolean h2IdxOffheap=offheap();
  if (!h2IdxOffheap) {
    spi.rebuildIndexes(typeAB.space(),typeAB);
    assertEquals(1,spi.size(typeAA.space(),typeAA));
    assertEquals(2,spi.size(typeAB.space(),typeAB));
    assertEquals(0,spi.size(typeBA.space(),typeBA));
    spi.rebuildIndexes("not_existing_space",typeAA);
    spi.rebuildIndexes(typeAA.space(),new TypeDesc("C","C",fieldsAA,null));
  }
  spi.unregisterType(typeAA.space(),typeAA);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(2,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.unregisterType(typeAB.space(),typeAB);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
  assertEquals(-1,spi.size(typeAB.space(),typeAB));
  assertEquals(0,spi.size(typeBA.space(),typeBA));
  spi.unregisterType(typeBA.space(),typeBA);
  spi.store(typeAA.space(),typeAA,key(10),aa(1,"Fail",100500),"v220".getBytes(),0);
  assertEquals(-1,spi.size(typeAA.space(),typeAA));
}
