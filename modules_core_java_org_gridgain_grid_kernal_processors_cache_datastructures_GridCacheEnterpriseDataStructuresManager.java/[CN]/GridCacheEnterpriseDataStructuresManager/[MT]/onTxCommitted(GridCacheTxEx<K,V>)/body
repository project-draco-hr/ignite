{
  if (!cctx.isDht() && tx.internal() && !cctx.isColocated()) {
    try {
      waitInitialization();
    }
 catch (    GridException e) {
      U.error(log,"Failed to wait for manager initialization.",e);
      return;
    }
    Collection<GridCacheTxEntry<K,V>> entries=tx.writeEntries();
    if (log.isDebugEnabled())     log.debug("Committed entries: " + entries);
    for (    GridCacheTxEntry<K,V> entry : entries) {
      if ((entry.op() == CREATE || entry.op() == UPDATE) && entry.key() instanceof GridCacheInternalKey) {
        GridCacheInternal key=(GridCacheInternal)entry.key();
        if (entry.value() instanceof GridCacheQueueHeader) {
          if (queueBusyLock.enterBusy()) {
            try {
              GridCacheRemovable queue=dsMap.get(key);
              if (queue instanceof GridCacheQueueEx) {
                GridCacheQueueHeader hdr=(GridCacheQueueHeader)entry.value();
                ((GridCacheQueueEx)queue).onHeaderChanged(hdr);
              }
 else               if (queue != null)               U.error(log,"Failed to cast object [expected=" + GridCacheQueue.class.getSimpleName() + ", actual="+ queue.getClass()+ ", value="+ queue+ ']');
            }
  finally {
              queueBusyLock.leaveBusy();
            }
          }
 else           U.warn(log,"Ignored queue update from TX because grid is stopping.");
        }
 else         if (entry.value() instanceof GridCacheCountDownLatchValue) {
          GridCacheRemovable latch=dsMap.get(key);
          GridCacheCountDownLatchValue val=(GridCacheCountDownLatchValue)entry.value();
          if (latch instanceof GridCacheCountDownLatchEx) {
            GridCacheCountDownLatchEx latch0=(GridCacheCountDownLatchEx)latch;
            latch0.onUpdate(val.get());
            if (val.get() == 0 && val.autoDelete()) {
              entry.cached().markObsolete(cctx.versions().next());
              dsMap.remove(key);
              latch.onRemoved();
            }
          }
 else           if (latch != null) {
            U.error(log,"Failed to cast object " + "[expected=" + GridCacheCountDownLatch.class.getSimpleName() + ", actual="+ latch.getClass()+ ", value="+ latch+ ']');
          }
        }
      }
      if (entry.op() == DELETE && entry.key() instanceof GridCacheInternal) {
        GridCacheInternal key=(GridCacheInternal)entry.key();
        GridCacheRemovable obj=dsMap.remove(key);
        if (obj != null)         obj.onRemoved();
      }
    }
  }
}
