{
  this.p2pEnabled=p2pEnabled;
  Ignite grid=startGrid();
  assertEquals(p2pEnabled,grid.configuration().isPeerClassLoadingEnabled());
  try {
    doTest(true,false,OLD_VAL,1);
    doTest(true,true,NEW_VAL,p2pEnabled ? 2 : 1);
    doTest(false,false,NEW_VAL,0);
    doTest(false,true,NEW_VAL,1);
  }
  finally {
    stopAllGrids();
  }
}
