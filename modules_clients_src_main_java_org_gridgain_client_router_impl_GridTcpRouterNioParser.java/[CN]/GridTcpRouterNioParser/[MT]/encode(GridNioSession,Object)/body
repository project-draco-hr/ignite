{
  sndCnt++;
  if (msg instanceof GridRouterResponse) {
    GridRouterResponse resp=(GridRouterResponse)msg;
    ByteBuffer res=ByteBuffer.allocate(resp.body().length + 45);
    res.put(GRIDGAIN_REQ_FLAG);
    res.putInt(resp.body().length + 40);
    res.putLong(resp.requestId());
    res.put(U.uuidToBytes(resp.clientId()));
    res.put(U.uuidToBytes(resp.destinationId()));
    res.put(resp.body());
    res.flip();
    return res;
  }
 else   if (msg instanceof GridClientResponse) {
    GridClientMarshaller marsh=marshaller(ses);
    byte[] msgBytes=marsh.marshal(msg);
    ByteBuffer res=ByteBuffer.allocate(msgBytes.length + 45);
    GridClientMessage clientMsg=(GridClientMessage)msg;
    res.put(GRIDGAIN_REQ_FLAG);
    res.put(U.intToBytes(msgBytes.length + 40));
    res.putLong(clientMsg.requestId());
    res.put(U.uuidToBytes(clientMsg.clientId()));
    res.put(U.uuidToBytes(clientMsg.destinationId()));
    res.put(msgBytes);
    res.flip();
    return res;
  }
 else   if (msg instanceof GridClientPingPacket || msg instanceof GridClientHandshakeResponse) {
    return super.encode(ses,msg);
  }
 else   throw new GridException("Unsupported message: " + msg);
}
