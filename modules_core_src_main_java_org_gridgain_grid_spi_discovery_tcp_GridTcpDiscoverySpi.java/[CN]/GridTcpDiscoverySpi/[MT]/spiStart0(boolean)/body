{
  if (!restart)   onSpiStart();
synchronized (mux) {
    spiState=DISCONNECTED;
  }
  fromAddrs.clear();
  noResAddrs.clear();
  sockTimeoutWorker=new SocketTimeoutWorker();
  sockTimeoutWorker.start();
  msgWorker=new MessageWorker();
  msgWorker.start();
  tcpSrvr=new TcpServer();
  GridBiTuple<Collection<String>,Collection<String>> addrs;
  try {
    addrs=U.resolveLocalAddresses(locHost);
  }
 catch (  IOException|GridException e) {
    throw new GridSpiException("Failed to resolve local host to set of external addresses: " + locHost,e);
  }
  locNode=new GridTcpDiscoveryNode(locNodeId,addrs.get1(),addrs.get2(),tcpSrvr.port,metricsProvider,nodeVer);
  try {
    Collection<InetSocketAddress> extAddrs=addrRslvr == null ? null : U.resolveAddresses(addrRslvr,F.flat(Arrays.asList(addrs.get1(),addrs.get2())),locNode.discoveryPort());
    if (extAddrs != null)     nodeAttrs.put(createSpiAttributeName(ATTR_EXT_ADDRS),extAddrs);
  }
 catch (  GridException e) {
    throw new GridSpiException("Failed to resolve local host to addresses: " + locHost,e);
  }
  locNode.setAttributes(nodeAttrs);
  locNode.local(true);
  locNodeAddrs=getNodeAddresses(locNode,null);
  if (log.isDebugEnabled())   log.debug("Local node initialized: " + locNode);
  tcpSrvr.start();
  ring.localNode(locNode);
  if (ipFinder.isShared())   registerLocalNodeAddress();
 else {
    if (F.isEmpty(ipFinder.getRegisteredAddresses()))     throw new GridSpiException("Non-shared IP finder must have IP addresses specified in " + "GridTcpDiscoveryIpFinder.getRegisteredAddresses() configuration property " + "(specify list of IP addresses in configuration).");
    ipFinderHasLocAddr=ipFinderHasLocalAddress();
  }
  if (statsPrintFreq > 0 && log.isInfoEnabled()) {
    statsPrinter=new StatisticsPrinter();
    statsPrinter.start();
  }
  stats.onJoinStarted();
  joinTopology();
  stats.onJoinFinished();
  hbsSnd=new HeartbeatsSender();
  hbsSnd.start();
  chkStatusSnd=new CheckStatusSender();
  chkStatusSnd.start();
  if (metricsStore != null) {
    metricsUpdateNtf=new MetricsUpdateNotifier();
    metricsUpdateNtf.start();
  }
  if (ipFinder.isShared() || metricsStore != null) {
    storesCleaner=new StoresCleaner();
    storesCleaner.start();
  }
  if (log.isDebugEnabled() && !restart)   log.debug(startInfo());
  if (restart)   getSpiContext().registerPort(tcpSrvr.port,TCP);
}
