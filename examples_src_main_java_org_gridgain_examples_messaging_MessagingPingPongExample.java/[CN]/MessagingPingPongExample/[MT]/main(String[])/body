{
  try (Grid g=GridGain.start("examples/config/example-compute.xml")){
    if (!ExamplesUtils.checkMinTopologySize(g.cluster(),2))     return;
    System.out.println();
    System.out.println(">>> Messaging ping-pong example started.");
    GridProjection nodeB=g.cluster().forRemotes().forRandom();
    g.message(nodeB).remoteListen(null,new GridBiPredicate<UUID,String>(){
      /** 
 * This will be injected on node listener comes to. 
 */
      @GridInstanceResource private Grid grid;
      @Override public boolean apply(      UUID nodeId,      String rcvMsg){
        System.out.println("Received message [msg=" + rcvMsg + ", sender="+ nodeId+ ']');
        try {
          if ("PING".equals(rcvMsg)) {
            grid.message(grid.cluster().forNodeId(nodeId)).send(null,"PONG");
            return true;
          }
          return false;
        }
 catch (        GridException e) {
          throw new GridClosureException(e);
        }
      }
    }
);
    int MAX_PLAYS=10;
    final CountDownLatch cnt=new CountDownLatch(MAX_PLAYS);
    g.message().localListen(null,new GridBiPredicate<UUID,String>(){
      @Override public boolean apply(      UUID nodeId,      String rcvMsg){
        System.out.println("Received message [msg=" + rcvMsg + ", sender="+ nodeId+ ']');
        try {
          if (cnt.getCount() == 1) {
            g.message(g.cluster().forNodeId(nodeId)).send(null,"STOP");
            cnt.countDown();
            return false;
          }
 else           if ("PONG".equals(rcvMsg))           g.message(g.cluster().forNodeId(nodeId)).send(null,"PING");
 else           throw new RuntimeException("Received unexpected message: " + rcvMsg);
          cnt.countDown();
          return true;
        }
 catch (        GridException e) {
          throw new GridClosureException(e);
        }
      }
    }
);
    g.message(nodeB).send(null,"PING");
    try {
      cnt.await();
    }
 catch (    InterruptedException e) {
      System.err.println("Hm... let us finish the game!\n" + e);
    }
  }
 }
