{
  GridCacheOperation op;
  Collection vals;
  if (val != null) {
    op=UPDATE;
    vals=Collections.singletonList(val);
  }
 else   if (proc != null) {
    op=TRANSFORM;
    vals=Collections.singletonList(proc);
  }
 else {
    op=DELETE;
    vals=null;
  }
  CacheOperationContext opCtx=ctx.operationContextPerCall();
  return new GridNearAtomicUpdateFuture(ctx,this,ctx.config().getWriteSynchronizationMode(),op,Collections.singletonList(key),vals,invokeArgs,null,null,retval,false,opCtx != null ? opCtx.expiry() : null,filter,ctx.subjectIdPerCall(null,opCtx),ctx.kernalContext().job().currentTaskNameHash(),opCtx != null && opCtx.skipStore(),opCtx != null && opCtx.isKeepBinary(),opCtx != null && opCtx.noRetries() ? 1 : MAX_RETRIES,waitTopFut);
}
