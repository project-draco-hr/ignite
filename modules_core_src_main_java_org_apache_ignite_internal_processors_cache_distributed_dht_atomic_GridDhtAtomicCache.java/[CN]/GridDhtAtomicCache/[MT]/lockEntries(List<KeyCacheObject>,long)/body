{
  if (keys.size() == 1) {
    K key=keys.get(0);
    while (true) {
      try {
        GridDhtCacheEntry<K,V> entry=entryExx(key,topVer);
        UNSAFE.monitorEnter(entry);
        if (entry.obsolete())         UNSAFE.monitorExit(entry);
 else         return Collections.singletonList(entry);
      }
 catch (      GridDhtInvalidPartitionException e) {
        if (ctx.config().getAtomicWriteOrderMode() == CLOCK)         return Collections.singletonList(null);
 else         throw e;
      }
    }
  }
 else {
    List<GridDhtCacheEntry<K,V>> locked=new ArrayList<>(keys.size());
    while (true) {
      for (      K key : keys) {
        try {
          GridDhtCacheEntry<K,V> entry=entryExx(key,topVer);
          locked.add(entry);
        }
 catch (        GridDhtInvalidPartitionException e) {
          if (ctx.config().getAtomicWriteOrderMode() == CLOCK)           locked.add(null);
 else           throw e;
        }
      }
      boolean retry=false;
      for (int i=0; i < locked.size(); i++) {
        GridCacheMapEntry<K,V> entry=locked.get(i);
        if (entry == null)         continue;
        UNSAFE.monitorEnter(entry);
        if (entry.obsolete()) {
          for (int j=0; j <= i; j++) {
            if (locked.get(j) != null)             UNSAFE.monitorExit(locked.get(j));
          }
          locked.clear();
          retry=true;
          break;
        }
      }
      if (!retry)       return locked;
    }
  }
}
