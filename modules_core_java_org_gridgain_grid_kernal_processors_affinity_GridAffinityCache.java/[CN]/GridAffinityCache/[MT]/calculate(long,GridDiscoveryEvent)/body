{
  CachedAffinity updated=new CachedAffinity(topVer);
  updated.calculate(discoEvt);
  updated=F.addIfAbsent(affCache,topVer,updated);
  while (true) {
    CachedAffinity headItem=head.get();
    if (headItem.topologyVersion() >= topVer)     break;
    if (head.compareAndSet(headItem,updated))     break;
  }
  for (  Map.Entry<Long,AffinityReadyFuture> entry : readyFuts.entrySet()) {
    if (entry.getKey() >= topVer)     entry.getValue().onDone(topVer);
  }
  return updated.assignment;
}
