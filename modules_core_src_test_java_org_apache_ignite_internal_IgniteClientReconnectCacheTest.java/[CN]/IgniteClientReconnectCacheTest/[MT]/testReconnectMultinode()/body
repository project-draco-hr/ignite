{
  grid(0).createCache(new CacheConfiguration<>());
  clientMode=true;
  final int CLIENTS=2;
  List<Ignite> clients=new ArrayList<>();
  for (int i=0; i < CLIENTS; i++) {
    Ignite client=startGrid(SRV_CNT + i);
    assertNotNull(client.getOrCreateCache(new CacheConfiguration<>()));
    clients.add(client);
  }
  int nodes=SRV_CNT + CLIENTS;
  int srvNodes=SRV_CNT;
  for (int iter=0; iter < 3; iter++) {
    log.info("Iteration: " + iter);
    reconnectClientNodes(clients,grid(0),null);
    for (    Ignite client : clients) {
      IgniteCache<Object,Object> cache=client.cache(null);
      assertNotNull(cache);
      cache.put(client.name(),1);
      assertEquals(1,cache.get(client.name()));
      ClusterGroup grp=client.cluster().forCacheNodes(null);
      assertEquals(CLIENTS + srvNodes,grp.nodes().size());
      grp=client.cluster().forClientNodes(null);
      assertEquals(CLIENTS,grp.nodes().size());
    }
    for (int i=0; i < nodes; i++) {
      Ignite ignite=grid(i);
      ClusterGroup grp=ignite.cluster().forCacheNodes(null);
      assertEquals(CLIENTS + srvNodes,grp.nodes().size());
      grp=ignite.cluster().forClientNodes(null);
      assertEquals(CLIENTS,grp.nodes().size());
    }
    clientMode=false;
    startGrid(nodes++);
    srvNodes++;
    clientMode=true;
    startGrid(nodes++);
  }
}
