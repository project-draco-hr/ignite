{
  IgniteCache<Integer,Integer> cache=ignite().cache(null);
  GridCacheContext cctx=((IgniteCacheProxy)cache).context();
  Map<Integer,Map<Integer,Integer>> entries=new HashMap<>();
  for (int i=0; i < KEY_CNT; i++) {
    cache.put(i,i);
    int part=cctx.affinity().partition(i);
    Map<Integer,Integer> partEntries=entries.get(part);
    if (partEntries == null)     entries.put(part,partEntries=new HashMap<>());
    partEntries.put(i,i);
  }
  for (int i=0; i < cctx.affinity().partitions(); i++) {
    ScanQuery<Integer,Integer> scan=new ScanQuery<>(i);
    Collection<Cache.Entry<Integer,Integer>> actual=cache.query(scan).getAll();
    Map<Integer,Integer> exp=entries.get(i);
    int size=exp == null ? 0 : exp.size();
    assertEquals("Failed for partition: " + i,size,actual.size());
    if (exp == null)     assertTrue(actual.isEmpty());
 else     for (    Cache.Entry<Integer,Integer> entry : actual)     assertTrue(entry.getValue().equals(exp.get(entry.getKey())));
  }
}
