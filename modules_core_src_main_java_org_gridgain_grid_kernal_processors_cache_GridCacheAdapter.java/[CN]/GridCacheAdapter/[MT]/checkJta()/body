{
  if (jtaTm == null) {
    if (cacheCfg.getTransactionManagerLookup() != null) {
      jtaTm=cacheCfg.getTransactionManagerLookup().getTm();
    }
  }
  if (jtaTm != null) {
    GridCacheXAResource rsrc=xaRsrc.get();
    if (rsrc == null || rsrc.isFinished()) {
      try {
        Transaction jtaTx=jtaTm.getTransaction();
        if (jtaTx != null) {
          GridCacheTx tx=ctx.tm().userTx();
          if (tx == null) {
            GridCacheConfiguration cfg=ctx.config();
            tx=ctx.tm().onCreated(newTx(false,false,cfg.getDefaultTxConcurrency(),cfg.getDefaultTxIsolation(),cfg.getDefaultTxTimeout(),cfg.isInvalidate() || ctx.hasFlag(INVALIDATE),ctx.syncCommit(),ctx.syncRollback(),ctx.isSwapOrOffheapEnabled(),ctx.isStoreEnabled(),0,null,false));
          }
          rsrc=new GridCacheXAResource((GridCacheTxEx)tx,ctx);
          if (!jtaTx.enlistResource(rsrc)) {
            throw new GridException("Failed to enlist XA resource to JTA user transaction.");
          }
          xaRsrc.set(rsrc);
        }
      }
 catch (      SystemException e) {
        throw new GridException("Failed to obtain JTA transaction.",e);
      }
catch (      RollbackException e) {
        throw new GridException("Failed to enlist XAResource to JTA transaction.",e);
      }
    }
  }
}
