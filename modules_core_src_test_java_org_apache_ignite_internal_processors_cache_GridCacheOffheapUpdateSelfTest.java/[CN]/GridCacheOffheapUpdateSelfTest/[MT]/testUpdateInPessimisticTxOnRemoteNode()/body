{
  try {
    Ignite ignite=startGrids(2);
    IgniteCache<Object,Object> rmtCache=ignite.cache(null);
    int key=0;
    while (!ignite.affinity(null).isPrimary(grid(1).localNode(),key))     key++;
    IgniteCache<Object,Object> locCache=grid(1).cache(null);
    try (Transaction tx=grid(1).transactions().txStart(PESSIMISTIC,REPEATABLE_READ)){
      locCache.putIfAbsent(key,0);
      tx.commit();
    }
     try (Transaction tx=ignite.transactions().txStart(PESSIMISTIC,REPEATABLE_READ)){
      assertEquals(0,rmtCache.get(key));
      rmtCache.put(key,1);
      tx.commit();
    }
     try (Transaction tx=ignite.transactions().txStart(PESSIMISTIC,REPEATABLE_READ)){
      assertEquals(1,rmtCache.get(key));
      rmtCache.put(key,2);
      tx.commit();
    }
   }
  finally {
    stopAllGrids();
  }
}
