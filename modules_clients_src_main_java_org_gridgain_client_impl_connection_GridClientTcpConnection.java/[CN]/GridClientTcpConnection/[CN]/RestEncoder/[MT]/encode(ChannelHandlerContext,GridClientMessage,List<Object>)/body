{
  if (msg instanceof GridClientPingPacket)   out.add(Unpooled.EMPTY_BUFFER);
 else {
    ByteBuf body=msg instanceof GridRouterRequest ? Unpooled.wrappedBuffer(((GridRouterRequest)msg).body()) : Unpooled.wrappedBuffer(marsh.marshal(msg));
    ByteBuf hdr=ctx.alloc().buffer(40);
    hdr.writeLong(msg.requestId());
    hdr.writeLong(msg.clientId().getMostSignificantBits());
    hdr.writeLong(msg.clientId().getLeastSignificantBits());
    if (msg.destinationId() != null) {
      hdr.writeLong(msg.destinationId().getMostSignificantBits());
      hdr.writeLong(msg.destinationId().getLeastSignificantBits());
    }
 else {
      hdr.writeLong(0);
      hdr.writeLong(0);
    }
    out.add(Unpooled.wrappedBuffer(hdr,body).retain());
  }
}
