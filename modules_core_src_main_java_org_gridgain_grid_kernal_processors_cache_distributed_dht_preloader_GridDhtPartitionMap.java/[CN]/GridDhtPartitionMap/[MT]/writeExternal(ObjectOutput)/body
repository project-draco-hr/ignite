{
  U.writeUuid(out,nodeId);
  out.writeLong(updateSeq);
  GridBitByteArrayOutputStream bitOut=new GridBitByteArrayOutputStream();
  for (  Map.Entry<Integer,GridDhtPartitionState> entry : entrySet()) {
    int part=entry.getKey();
    GridDhtPartitionState state=entry.getValue();
    if (part > 32767)     throw new IllegalStateException("Partition index overflow: " + part);
    if (part <= 127) {
      bitOut.writeBit(false);
      bitOut.writeBits(part,7);
    }
 else {
      bitOut.writeBit(true);
      bitOut.writeBits(part,15);
    }
    if (state.ordinal() > 3)     throw new IllegalStateException("State ordinal index overflow: " + state.ordinal());
    bitOut.writeBits(state.ordinal(),2);
  }
  out.writeLong(bitOut.bitsLength());
  U.writeByteArray(out,bitOut.internalArray(),bitOut.bytesLength());
}
