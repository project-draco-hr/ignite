{
  startUpSecondary();
  GridGgfsConfiguration ggfsCfg=new GridGgfsConfiguration();
  ggfsCfg.setDataCacheName("partitioned");
  ggfsCfg.setMetaCacheName("replicated");
  ggfsCfg.setName("ggfs");
  ggfsCfg.setBlockSize(512 * 1024);
  ggfsCfg.setDefaultMode(mode);
  ggfsCfg.setPathModes(pathModes);
  ggfsCfg.setIpcEndpointConfiguration("{type:'tcp', port:10500}");
  ggfsCfg.setManagementPort(-1);
  ggfsCfg.setSecondaryHadoopFileSystemUri("ggfs://secondary/");
  ggfsCfg.setSecondaryHadoopFileSystemConfigPath("modules/core/src/test/config/hadoop/core-site-loopback-secondary.xml");
  GridCacheConfiguration cacheCfg=defaultCacheConfiguration();
  cacheCfg.setName("partitioned");
  cacheCfg.setCacheMode(PARTITIONED);
  cacheCfg.setDistributionMode(GridCacheDistributionMode.PARTITIONED_ONLY);
  cacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
  cacheCfg.setAffinityMapper(new GridGgfsGroupDataBlocksKeyMapper(128));
  cacheCfg.setBackups(0);
  cacheCfg.setQueryIndexEnabled(false);
  cacheCfg.setAtomicityMode(TRANSACTIONAL);
  GridCacheConfiguration metaCacheCfg=defaultCacheConfiguration();
  metaCacheCfg.setName("replicated");
  metaCacheCfg.setCacheMode(REPLICATED);
  metaCacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
  metaCacheCfg.setQueryIndexEnabled(false);
  metaCacheCfg.setAtomicityMode(TRANSACTIONAL);
  GridConfiguration cfg=new GridConfiguration();
  cfg.setGridName("ggfs-grid");
  GridTcpDiscoverySpi discoSpi=new GridTcpDiscoverySpi();
  discoSpi.setIpFinder(new GridTcpDiscoveryVmIpFinder(true));
  cfg.setDiscoverySpi(discoSpi);
  cfg.setCacheConfiguration(metaCacheCfg,cacheCfg);
  cfg.setGgfsConfiguration(ggfsCfg);
  G.start(cfg);
  Configuration fsCfg=new Configuration();
  fsCfg.addResource(U.resolveGridGainUrl("modules/core/src/test/config/hadoop/core-site-loopback.xml"));
  fs=(GridGgfsHadoopFileSystem)FileSystem.get(new URI("ggfs://primary/"),fsCfg);
}
