{
  evts=Collections.synchronizedList(new ArrayList<CacheEntryEvent<?,?>>());
  evtsLatch=new CountDownLatch(expEvts);
  syncEvtLatch=new CountDownLatch(1);
  final AtomicBoolean done=new AtomicBoolean();
  IgniteInternalFuture<?> fut=GridTestUtils.runAsync(new Callable<Void>(){
    @Override public Void call() throws Exception {
      assertFalse(done.get());
      U.sleep(500);
      assertFalse(done.get());
      syncEvtLatch.countDown();
      return null;
    }
  }
);
  if (val != null)   cache.put(key(key),value(val));
 else   cache.remove(key(key));
  done.set(true);
  fut.get();
  evtsLatch.await(5000,MILLISECONDS);
  assertEquals(expEvts,evts.size());
}
