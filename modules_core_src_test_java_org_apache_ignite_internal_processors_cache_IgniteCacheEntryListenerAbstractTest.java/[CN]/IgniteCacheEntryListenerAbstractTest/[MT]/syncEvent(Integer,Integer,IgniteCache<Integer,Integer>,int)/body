{
  evts=new ArrayList<>();
  evtsLatch=new CountDownLatch(expEvts);
  syncEvtLatch=new CountDownLatch(1);
  final AtomicBoolean done=new AtomicBoolean();
  IgniteFuture<?> fut=GridTestUtils.runAsync(new Callable<Void>(){
    @Override public Void call() throws Exception {
      assertFalse(done.get());
      U.sleep(500);
      assertFalse(done.get());
      syncEvtLatch.countDown();
      return null;
    }
  }
);
  if (val != null)   cache.put(key,val);
 else   cache.remove(key);
  done.set(true);
  fut.get();
  evtsLatch.await(5000,MILLISECONDS);
  assertEquals(expEvts,evts.size());
}
