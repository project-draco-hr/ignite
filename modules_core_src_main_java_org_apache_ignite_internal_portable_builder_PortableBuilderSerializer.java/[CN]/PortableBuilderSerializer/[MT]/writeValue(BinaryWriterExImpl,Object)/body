{
  if (val == null) {
    writer.writeByte(GridPortableMarshaller.NULL);
    return;
  }
  if (val instanceof PortableBuilderSerializationAware) {
    ((PortableBuilderSerializationAware)val).writeTo(writer,this);
    return;
  }
  if (val instanceof BinaryObjectExImpl) {
    if (portableObjToWrapper == null)     portableObjToWrapper=new IdentityHashMap<>();
    BinaryObjectBuilderImpl wrapper=portableObjToWrapper.get(val);
    if (wrapper == null) {
      wrapper=BinaryObjectBuilderImpl.wrap((BinaryObject)val);
      portableObjToWrapper.put((BinaryObject)val,wrapper);
    }
    val=wrapper;
  }
  if (val instanceof BinaryObjectBuilderImpl) {
    BinaryObjectBuilderImpl obj=(BinaryObjectBuilderImpl)val;
    Integer posInResArr=objToPos.get(obj);
    if (posInResArr == null) {
      objToPos.put(obj,writer.out().position());
      obj.serializeTo(writer.newWriter(obj.typeId()),this);
    }
 else {
      int handle=writer.out().position() - posInResArr;
      writer.writeByte(GridPortableMarshaller.HANDLE);
      writer.writeInt(handle);
    }
    return;
  }
  if (val.getClass().isEnum()) {
    writer.writeByte(GridPortableMarshaller.ENUM);
    writer.writeInt(writer.context().typeId(val.getClass().getName()));
    writer.writeInt(((Enum)val).ordinal());
    return;
  }
  if (val instanceof Collection) {
    Collection<?> c=(Collection<?>)val;
    writer.writeByte(GridPortableMarshaller.COL);
    writer.writeInt(c.size());
    byte colType;
    if (c instanceof GridConcurrentSkipListSet)     colType=GridPortableMarshaller.CONC_SKIP_LIST_SET;
 else     colType=writer.context().collectionType(c.getClass());
    writer.writeByte(colType);
    for (    Object obj : c)     writeValue(writer,obj);
    return;
  }
  if (val instanceof Map) {
    Map<?,?> map=(Map<?,?>)val;
    writer.writeByte(GridPortableMarshaller.MAP);
    writer.writeInt(map.size());
    writer.writeByte(writer.context().mapType(map.getClass()));
    for (    Map.Entry<?,?> entry : map.entrySet()) {
      writeValue(writer,entry.getKey());
      writeValue(writer,entry.getValue());
    }
    return;
  }
  Byte flag=PortableUtils.PLAIN_CLASS_TO_FLAG.get(val.getClass());
  if (flag != null) {
    PortableUtils.writePlainObject(writer,val);
    return;
  }
  if (val instanceof Object[]) {
    int compTypeId=writer.context().typeId(((Object[])val).getClass().getComponentType().getName());
    if (val instanceof PortableBuilderEnum[]) {
      writeArray(writer,GridPortableMarshaller.ENUM_ARR,(Object[])val,compTypeId);
      return;
    }
    if (((Object[])val).getClass().getComponentType().isEnum()) {
      Enum[] enumArr=(Enum[])val;
      writer.writeByte(GridPortableMarshaller.ENUM_ARR);
      writer.writeInt(compTypeId);
      writer.writeInt(enumArr.length);
      for (      Enum anEnum : enumArr)       writeValue(writer,anEnum);
      return;
    }
    writeArray(writer,GridPortableMarshaller.OBJ_ARR,(Object[])val,compTypeId);
    return;
  }
  writer.doWriteObject(val);
}
