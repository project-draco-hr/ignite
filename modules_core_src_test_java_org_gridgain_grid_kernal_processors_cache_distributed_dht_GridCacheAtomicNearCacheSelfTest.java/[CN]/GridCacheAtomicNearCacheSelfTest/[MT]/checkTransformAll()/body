{
  log.info("Check transformAll.");
  Grid grid0=grid(0);
  GridCache<Integer,Integer> cache0=grid0.cache(null);
  GridCacheAffinity<Integer> aff=cache0.affinity();
  UUID id0=grid0.localNode().id();
  Map<Integer,TransformClosure> primaryKeys=new HashMap<>();
  for (int i=0; i < 10; i++)   primaryKeys.put(key(grid0,PRIMARY),new TransformClosure(1));
  log.info("TransformAll from primary.");
  cache0.transformAll(primaryKeys);
  for (int i=0; i < GRID_CNT; i++) {
    for (    Integer primaryKey : primaryKeys.keySet())     checkEntry(grid(i),primaryKey,1,false);
  }
  if (backups > 0) {
    Map<Integer,TransformClosure> backupKeys=new HashMap<>();
    for (int i=0; i < 10; i++)     backupKeys.put(key(grid0,BACKUP),new TransformClosure(2));
    log.info("TransformAll from backup.");
    cache0.transformAll(backupKeys);
    for (int i=0; i < GRID_CNT; i++) {
      for (      Integer backupKey : backupKeys.keySet())       checkEntry(grid(i),backupKey,2,false);
    }
  }
  Map<Integer,TransformClosure> nearKeys=new HashMap<>();
  for (int i=0; i < 30; i++)   nearKeys.put(key(grid0,NOT_PRIMARY_AND_BACKUP),new TransformClosure(3));
  log.info("TransformAll from near.");
  cache0.transformAll(nearKeys);
  for (int i=0; i < GRID_CNT; i++) {
    for (    Integer nearKey : nearKeys.keySet()) {
      UUID[] expReaders=aff.isPrimary(grid(i).localNode(),nearKey) ? new UUID[]{id0} : new UUID[]{};
      checkEntry(grid(i),nearKey,3,i == 0,expReaders);
    }
  }
  Map<Integer,Collection<UUID>> readersMap=new HashMap<>();
  for (  Integer key : nearKeys.keySet())   readersMap.put(key,new HashSet<UUID>());
  int val=4;
  for (int i=0; i < GRID_CNT; i++) {
    delay();
    GridCache<Integer,Integer> cache=grid(i).cache(null);
    for (    Integer key : nearKeys.keySet())     nearKeys.put(key,new TransformClosure(val));
    log.info("TransformAll [grid=" + grid(i).name() + ", val="+ val+ ']');
    cache.transformAll(nearKeys);
    for (    Integer key : nearKeys.keySet()) {
      if (!aff.isPrimaryOrBackup(grid(i).localNode(),key))       readersMap.get(key).add(grid(i).localNode().id());
    }
    for (int j=0; j < GRID_CNT; j++) {
      for (      Integer key : nearKeys.keySet()) {
        boolean primaryNode=aff.isPrimary(grid(j).localNode(),key);
        Collection<UUID> readers=readersMap.get(key);
        UUID[] expReaders=primaryNode ? U.toArray(readers,new UUID[readers.size()]) : new UUID[]{};
        checkEntry(grid(j),key,val,readers.contains(grid(j).localNode().id()),expReaders);
      }
    }
    val++;
  }
}
