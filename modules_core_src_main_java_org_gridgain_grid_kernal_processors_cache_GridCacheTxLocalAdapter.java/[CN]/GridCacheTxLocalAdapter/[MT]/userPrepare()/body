{
  if (state() != PREPARING) {
    if (timedOut())     throw new GridCacheTxTimeoutException("Transaction timed out: " + this);
    GridCacheTxState state=state();
    setRollbackOnly();
    throw new IgniteCheckedException("Invalid transaction state for prepare [state=" + state + ", tx="+ this+ ']');
  }
  checkValid();
  try {
    cctx.tm().prepareTx(this);
  }
 catch (  IgniteCheckedException e) {
    throw e;
  }
catch (  Throwable e) {
    setRollbackOnly();
    throw new IgniteCheckedException("Transaction validation produced a runtime exception: " + this,e);
  }
}
