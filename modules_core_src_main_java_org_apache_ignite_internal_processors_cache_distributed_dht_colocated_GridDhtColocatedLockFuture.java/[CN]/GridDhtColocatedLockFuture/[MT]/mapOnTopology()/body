{
  try {
    cctx.topology().readLock();
    try {
      GridDhtTopologyFuture fut=cctx.topologyVersionFuture();
      if (fut.isDone()) {
        GridDiscoveryTopologySnapshot snapshot=fut.topologySnapshot();
        if (tx != null) {
          tx.topologyVersion(snapshot.topologyVersion());
          tx.topologySnapshot(snapshot);
        }
        topSnapshot.compareAndSet(null,snapshot);
        map(keys);
        markInitialized();
      }
 else {
        fut.listenAsync(new CI1<IgniteInternalFuture<Long>>(){
          @Override public void apply(          IgniteInternalFuture<Long> t){
            mapOnTopology();
          }
        }
);
      }
    }
  finally {
      cctx.topology().readUnlock();
    }
  }
 catch (  IgniteCheckedException e) {
    onDone(e);
  }
}
