{
  cctx.topology().readLock();
  try {
    if (cctx.topology().stopping()) {
      onDone(new IgniteCheckedException("Failed to perform cache operation (cache is stopped): " + cctx.name()));
      return;
    }
    GridDhtTopologyFuture fut=cctx.topologyVersionFuture();
    if (fut.isDone()) {
      AffinityTopologyVersion topVer=fut.topologyVersion();
      if (tx != null)       tx.topologyVersion(topVer);
      this.topVer.compareAndSet(null,topVer);
      map(keys);
      markInitialized();
    }
 else {
      fut.listen(new CI1<IgniteInternalFuture<AffinityTopologyVersion>>(){
        @Override public void apply(        IgniteInternalFuture<AffinityTopologyVersion> t){
          mapOnTopology();
        }
      }
);
    }
  }
  finally {
    cctx.topology().readUnlock();
  }
}
