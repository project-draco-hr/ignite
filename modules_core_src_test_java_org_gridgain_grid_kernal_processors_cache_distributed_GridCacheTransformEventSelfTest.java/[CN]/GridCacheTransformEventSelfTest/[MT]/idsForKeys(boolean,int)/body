{
  List<UUID> res=new ArrayList<>();
  if (cacheMode == LOCAL) {
    for (    int key : keys)     res.add(ids[0]);
  }
 else   if (cacheMode == PARTITIONED) {
    for (    int key : keys) {
      for (int i=0; i < GRID_CNT; i++) {
        GridCacheEntry<Integer,Integer> entry=caches[i].entry(key);
        if (entry.primary() || (!primaryOnly && entry.backup()))         res.add(ids[i]);
      }
    }
  }
 else   if (cacheMode == REPLICATED) {
    for (    int key : keys) {
      if (primaryOnly)       res.add(caches[0].affinity().mapKeyToNode(key).id());
 else       res.addAll(Arrays.asList(ids));
    }
  }
  return res.toArray(new UUID[res.size()]);
}
