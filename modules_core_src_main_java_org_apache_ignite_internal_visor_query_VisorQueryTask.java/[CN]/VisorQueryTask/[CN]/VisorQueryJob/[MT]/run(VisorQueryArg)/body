{
  try {
    Boolean scan=arg.queryTxt().toUpperCase().startsWith("SCAN");
    String qryId=(scan ? SCAN_QRY_NAME : SQL_QRY_NAME) + "-" + UUID.randomUUID();
    GridCacheProcessor cacheProcessor=ignite.context().cache();
    IgniteCache<Object,Object> c=cacheProcessor.privateJCache(arg.cacheName(),false);
    if (scan) {
      ScanQuery<Object,Object> qry=new ScanQuery<>(null);
      qry.setPageSize(arg.pageSize());
      long start=U.currentTimeMillis();
      VisorQueryCursor<Cache.Entry<Object,Object>> cur=new VisorQueryCursor<>(c.query(qry));
      List<Object[]> rows=fetchScanQueryRows(cur,arg.pageSize());
      long duration=U.currentTimeMillis() - start;
      ignite.cluster().<String,VisorQueryCursorHolder>nodeLocalMap().put(qryId,new VisorQueryCursorHolder(cur,false));
      scheduleResultSetHolderRemoval(qryId);
      return new IgniteBiTuple<>(null,new VisorQueryResultEx(ignite.localNode().id(),qryId,SCAN_COL_NAMES,rows,cur.hasNext(),duration));
    }
 else {
      SqlFieldsQuery qry=new SqlFieldsQuery(arg.queryTxt());
      qry.setPageSize(arg.pageSize());
      long start=U.currentTimeMillis();
      VisorQueryCursor<List<?>> cur=new VisorQueryCursor<>(c.query(qry));
      Collection<GridQueryFieldMetadata> meta=cur.fieldsMeta();
      if (meta == null)       return new IgniteBiTuple<Exception,VisorQueryResultEx>(new SQLException("Fail to execute query. No metadata available."),null);
 else {
        List<VisorQueryField> names=new ArrayList<>(meta.size());
        for (        GridQueryFieldMetadata col : meta)         names.add(new VisorQueryField(col.typeName(),col.fieldName()));
        List<Object[]> rows=fetchSqlQueryRows(cur,arg.pageSize());
        long duration=U.currentTimeMillis() - start;
        ignite.cluster().<String,VisorQueryCursorHolder>nodeLocalMap().put(qryId,new VisorQueryCursorHolder(cur,false));
        scheduleResultSetHolderRemoval(qryId);
        return new IgniteBiTuple<>(null,new VisorQueryResultEx(ignite.localNode().id(),qryId,names,rows,cur.hasNext(),duration));
      }
    }
  }
 catch (  Exception e) {
    return new IgniteBiTuple<>(e,null);
  }
}
