{
  if (log.isDebugEnabled())   log.debug("Committing near local tx: " + this);
  prepareAsync();
  GridNearTxFinishFuture<K,V> fut=commitFut.get();
  if (fut == null && !commitFut.compareAndSet(null,fut=new GridNearTxFinishFuture<>(cctx,this,true)))   return commitFut.get();
  cctx.mvcc().addFuture(fut);
  GridFuture<GridCacheTxEx<K,V>> prepareFut=prepFut.get();
  prepareFut.listenAsync(new CI1<GridFuture<GridCacheTxEx<K,V>>>(){
    @Override public void apply(    GridFuture<GridCacheTxEx<K,V>> f){
      GridNearTxFinishFuture<K,V> fut0=commitFut.get();
      try {
        f.get();
        if (finish(true))         fut0.finish();
 else         fut0.onError(new GridException("Failed to commit transaction: " + CU.txString(GridNearTxLocal.this)));
      }
 catch (      Error|RuntimeException e) {
        commitErr.compareAndSet(null,e);
        throw e;
      }
catch (      GridException e) {
        commitErr.compareAndSet(null,e);
        fut0.onError(e);
      }
    }
  }
);
  return fut;
}
