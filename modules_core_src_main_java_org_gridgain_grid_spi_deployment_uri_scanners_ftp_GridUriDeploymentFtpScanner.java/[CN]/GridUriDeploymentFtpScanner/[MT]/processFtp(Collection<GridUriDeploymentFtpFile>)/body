{
  GridUriDeploymentFtpClient ftp=new GridUriDeploymentFtpClient(cfg,getLogger());
  try {
    ftp.connect();
    for (    GridUriDeploymentFtpFile file : ftp.getFiles()) {
      String fileName=file.getName();
      if (getFilter().accept(null,fileName.toLowerCase()) && file.isFile()) {
        files.add(file);
        Long lastModified=cache.get(file);
        Calendar fileTstamp=file.getTimestamp();
        if (fileTstamp == null) {
          if (lastModified == null) {
            cache.put(file,UNKNOWN_FILE_TSTAMP);
            U.warn(getLogger(),"File with unknown timestamp will be ignored " + "(check FTP server configuration): " + file);
          }
        }
 else         if (lastModified == null || lastModified != fileTstamp.getTimeInMillis()) {
          cache.put(file,fileTstamp.getTimeInMillis());
          if (getLogger().isDebugEnabled())           getLogger().debug("Discovered deployment file or directory: " + file);
          try {
            File diskFile=createTempFile(fileName,getDeployDirectory());
            ftp.downloadToFile(file,diskFile);
            String fileUri=getFileUri(fileName);
            diskFile.deleteOnExit();
            getListener().onNewOrUpdatedFile(diskFile,fileUri,fileTstamp.getTimeInMillis());
          }
 catch (          IOException e) {
            U.error(getLogger(),"Failed to download file from FTP server: " + fileName,e);
          }
        }
      }
    }
  }
 catch (  GridUriDeploymentFtpException e) {
    if (!isCancelled()) {
      String maskedUri=getUri() != null ? U.hidePassword(getUri().toString()) : null;
      if (e.hasCause(ConnectException.class))       LT.warn(getLogger(),e,"Failed to connect to FTP server (connection refused): " + maskedUri);
 else       if (e.hasCause(UnknownHostException.class))       LT.warn(getLogger(),e,"Failed to connect to FTP server (host is unknown): " + maskedUri);
 else       U.error(getLogger(),"Failed to get files from FTP server: " + maskedUri,e);
    }
  }
 finally {
    try {
      ftp.close();
    }
 catch (    GridUriDeploymentFtpException e) {
      if (!isCancelled())       U.error(getLogger(),"Failed to close FTP client.",e);
    }
  }
}
