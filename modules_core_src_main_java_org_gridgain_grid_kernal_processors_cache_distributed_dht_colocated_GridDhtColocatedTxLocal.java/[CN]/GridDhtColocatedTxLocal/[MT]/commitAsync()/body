{
  if (log.isDebugEnabled())   log.debug("Committing colocated tx: " + this);
  prepareAsync();
  GridDhtColocatedTxFinishFuture<K,V> fut=commitFut.get();
  if (fut != null)   return fut;
  if (!commitFut.compareAndSet(null,fut=new GridDhtColocatedTxFinishFuture<>(cctx,this)))   return commitFut.get();
  cctx.mvcc().addFuture(fut);
  GridFuture<GridCacheTxEx<K,V>> prepareFut=prepFut.get();
  prepareFut.listenAsync(new CI1<GridFuture<GridCacheTxEx<K,V>>>(){
    @Override public void apply(    GridFuture<GridCacheTxEx<K,V>> f){
      GridDhtColocatedTxFinishFuture<K,V> commitFut0=commitFut.get();
      try {
        f.get();
        if (finish(true))         commitFut0.finish(true);
 else         commitFut0.onError(new GridException("Failed to commit transaction: " + CU.txString(GridDhtColocatedTxLocal.this)));
      }
 catch (      GridException e) {
        commitErr.compareAndSet(null,e);
        commitFut0.onError(e);
      }
catch (      Error|RuntimeException e) {
        commitErr.compareAndSet(null,e);
        throw e;
      }
    }
  }
);
  return fut;
}
