{
  long qryReqId=reqIdGen.incrementAndGet();
  QueryRun r=new QueryRun();
  r.tbls=new ArrayList<>(qry.mapQueries().size());
  r.conn=h2.connectionForSpace(space);
  final Collection<ClusterNode> nodes=ctx.grid().cluster().forCacheNodes(space).nodes();
  for (  GridCacheSqlQuery mapQry : qry.mapQueries()) {
    GridMergeTable tbl;
    try {
      tbl=createFunctionTable((JdbcConnection)r.conn,mapQry);
    }
 catch (    IgniteCheckedException e) {
      throw new IgniteException(e);
    }
    GridMergeIndex idx=tbl.getScanIndex(null);
    for (    ClusterNode node : nodes)     idx.addSource(node.id());
    r.tbls.add(tbl);
    curFunTbl.set(tbl);
  }
  r.latch=new CountDownLatch(r.tbls.size() * nodes.size());
  runs.put(qryReqId,r);
  try {
    ctx.io().sendUserMessage(nodes,new GridQueryRequest(qryReqId,1000,space,qry.mapQueries()),GridTopic.TOPIC_QUERY,false,0);
    r.latch.await();
    if (r.rmtErr != null)     throw new CacheException("Failed to run map query remotely.",r.rmtErr);
    GridCacheSqlQuery rdc=qry.reduceQuery();
    final ResultSet res=h2.executeSqlQueryWithTimer(space,r.conn,rdc.query(),F.asList(rdc.parameters()));
    for (    GridMergeTable tbl : r.tbls) {
      if (!tbl.getScanIndex(null).fetchedAll())       ctx.io().sendUserMessage(nodes,new GridQueryCancelRequest(qryReqId),GridTopic.TOPIC_QUERY,false,0);
    }
    return new QueryCursorImpl<>(new Iter(res));
  }
 catch (  IgniteCheckedException|InterruptedException|RuntimeException e) {
    U.closeQuiet(r.conn);
    if (e instanceof CacheException)     throw (CacheException)e;
    throw new CacheException("Failed to run reduce query locally.",e);
  }
 finally {
    if (!runs.remove(qryReqId,r))     U.warn(log,"Query run was already removed: " + qryReqId);
    curFunTbl.remove();
  }
}
