{
  if (params == null)   params=GridCacheSqlQuery.EMPTY_PARAMS;
  Set<String> spaces=new HashSet<>();
  final GridSqlSelect mapQry=wrapUnion(collectAllSpaces(GridSqlQueryParser.parse(stmt),spaces));
  final boolean explain=mapQry.explain();
  mapQry.explain(false);
  GridSqlSelect rdcQry=new GridSqlSelect().from(table(0));
  List<GridSqlElement> mapExps=F.addAll(new ArrayList<GridSqlElement>(mapQry.allColumns()),mapQry.columns(false));
  GridSqlElement[] rdcExps=new GridSqlElement[mapQry.visibleColumns()];
  Set<String> colNames=new HashSet<>();
  boolean aggregateFound=false;
  for (int i=0, len=mapExps.size(); i < len; i++)   aggregateFound|=splitSelectExpression(mapExps,rdcExps,colNames,i,collocated);
  mapQry.clearColumns();
  for (  GridSqlElement exp : mapExps)   mapQry.addColumn(exp,true);
  for (  GridSqlElement rdcExp : rdcExps)   rdcQry.addColumn(rdcExp,true);
  for (int i=rdcExps.length; i < mapExps.size(); i++)   rdcQry.addColumn(column(((GridSqlAlias)mapExps.get(i)).alias()),false);
  if (mapQry.groupColumns() != null && !collocated)   rdcQry.groupColumns(mapQry.groupColumns());
  if (mapQry.havingColumn() >= 0 && !collocated) {
    rdcQry.whereAnd(column(columnName(mapQry.havingColumn())));
    mapQry.havingColumn(-1);
  }
  if (!mapQry.sort().isEmpty()) {
    for (    GridSqlSortColumn sortCol : mapQry.sort())     rdcQry.addSort(sortCol);
    if (aggregateFound)     mapQry.clearSort();
  }
  if (mapQry.limit() != null) {
    rdcQry.limit(mapQry.limit());
    if (aggregateFound)     mapQry.limit(null);
  }
  if (mapQry.offset() != null) {
    rdcQry.offset(mapQry.offset());
    if (mapQry.limit() != null)     mapQry.limit(op(GridSqlOperationType.PLUS,mapQry.offset(),mapQry.limit()));
    mapQry.offset(null);
  }
  if (mapQry.distinct()) {
    mapQry.distinct(!aggregateFound && mapQry.groupColumns() == null && mapQry.havingColumn() < 0);
    rdcQry.distinct(true);
  }
  IntArray paramIdxs=new IntArray(params.length);
  GridCacheSqlQuery rdc=new GridCacheSqlQuery(rdcQry.getSQL(),findParams(rdcQry,params,new ArrayList<>(),paramIdxs).toArray());
  rdc.parameterIndexes(toIntArray(paramIdxs));
  paramIdxs=new IntArray(params.length);
  GridCacheSqlQuery map=new GridCacheSqlQuery(mapQry.getSQL(),findParams(mapQry,params,new ArrayList<>(params.length),paramIdxs).toArray()).columns(collectColumns(mapExps));
  map.parameterIndexes(toIntArray(paramIdxs));
  GridCacheTwoStepQuery res=new GridCacheTwoStepQuery(spaces,rdc,rdcQry.simpleQuery()).addMapQuery(map);
  res.explain(explain);
  return res;
}
