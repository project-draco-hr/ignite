{
  if (params == null)   params=GridCacheSqlQuery.EMPTY_PARAMS;
  GridSqlQuery srcQry=GridSqlQueryParser.parse(stmt);
  if (!(srcQry instanceof GridSqlSelect))   throw new UnsupportedOperationException();
  GridSqlSelect srcSelect=(GridSqlSelect)srcQry;
  final String mergeTable=TABLE_FUNC_NAME + "()";
  GridSqlSelect mapQry=srcSelect.clone();
  GridSqlSelect rdcQry=new GridSqlSelect().from(new GridSqlFunction("PUBLIC",TABLE_FUNC_NAME));
  List<GridSqlElement> mapExps=new ArrayList<>(srcSelect.allExpressions());
  GridSqlElement[] rdcExps=new GridSqlElement[srcSelect.select().size()];
  Set<String> colNames=new HashSet<>();
  for (int i=0, len=mapExps.size(); i < len; i++)   splitSelectExpression(mapExps,rdcExps,colNames,i);
  mapQry.clearSelect();
  for (  GridSqlElement exp : mapExps)   mapQry.addSelectExpression(exp);
  for (  GridSqlElement rdcExp : rdcExps)   rdcQry.addSelectExpression(rdcExp);
  if (!srcSelect.groups().isEmpty()) {
    mapQry.clearGroups();
    for (    int col : srcSelect.groupColumns())     mapQry.addGroupExpression(column(((GridSqlAlias)mapExps.get(col)).alias()));
    for (    int col : srcSelect.groupColumns())     rdcQry.addGroupExpression(column(((GridSqlAlias)mapExps.get(col)).alias()));
  }
  if (srcSelect.having() != null) {
    rdcQry.whereAnd(column(columnName(srcSelect.havingColumn())));
    mapQry.having(null);
  }
  if (!srcSelect.sort().isEmpty()) {
    for (    GridSqlSortColumn sortCol : srcSelect.sort().values())     rdcQry.addSort(column(((GridSqlAlias)mapExps.get(sortCol.column())).alias()),sortCol);
  }
  if (srcSelect.limit() != null)   rdcQry.limit(srcSelect.limit());
  if (srcSelect.offset() != null) {
    mapQry.offset(null);
    rdcQry.offset(srcSelect.offset());
  }
  if (srcSelect.distinct()) {
    mapQry.distinct(false);
    rdcQry.distinct(true);
  }
  GridCacheTwoStepQuery res=new GridCacheTwoStepQuery(rdcQry.getSQL(),findParams(rdcQry,params,new ArrayList<>()).toArray());
  res.addMapQuery(mergeTable,mapQry.getSQL(),findParams(mapQry,params,new ArrayList<>(params.length)).toArray());
  return res;
}
