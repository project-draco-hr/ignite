{
  String marshallerName=System.getProperty(MARSH_CLASS_NAME,GridTestProperties.getProperty(GridTestProperties.MARSH_CLASS_NAME));
  Marshaller marsh;
  if (marshallerName == null)   marsh=new OptimizedMarshaller();
 else {
    try {
      Class<? extends Marshaller> cls=(Class<? extends Marshaller>)Class.forName(marshallerName);
      marsh=cls.newInstance();
    }
 catch (    ClassNotFoundException|IllegalAccessException|InstantiationException e) {
      throw new IgniteCheckedException("Failed to create test marshaller [marshaller=" + marshallerName + ']',e);
    }
  }
  if (marsh instanceof OptimizedMarshaller)   ((OptimizedMarshaller)marsh).setRequireSerializable(false);
  marsh.setContext(new MarshallerContextTestImpl());
  if (marsh instanceof BinaryMarshaller) {
    BinaryContext ctx=new BinaryContext(BinaryCachingMetadataHandler.create(),new IgniteConfiguration(),new NullLogger());
    IgniteUtils.invoke(BinaryMarshaller.class,marsh,"setBinaryContext",ctx,new IgniteConfiguration());
  }
  return marsh;
}
