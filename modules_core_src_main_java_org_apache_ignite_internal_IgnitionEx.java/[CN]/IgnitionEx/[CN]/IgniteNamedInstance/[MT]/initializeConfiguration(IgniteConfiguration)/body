{
  IgniteConfiguration myCfg=new IgniteConfiguration(cfg);
  myCfg.setIgniteHome(U.getIgniteHome());
  String locHost=IgniteSystemProperties.getString(IGNITE_LOCAL_HOST);
  myCfg.setLocalHost(F.isEmpty(locHost) ? myCfg.getLocalHost() : locHost);
  if (daemon)   myCfg.setDaemon(true);
  Marshaller marsh=myCfg.getMarshaller();
  if (marsh == null) {
    if (!U.isHotSpot()) {
      U.warn(log,"OptimizedMarshaller is not supported on this JVM " + "(only Java HotSpot VMs are supported). Switching to standard JDK marshalling - " + "object serialization performance will be significantly slower.","To enable fast marshalling upgrade to recent 1.6 or 1.7 HotSpot VM release.");
      marsh=new JdkMarshaller();
    }
 else     if (!OptimizedMarshaller.available()) {
      U.warn(log,"OptimizedMarshaller is not supported on this JVM " + "(only recent 1.6 and 1.7 versions HotSpot VMs are supported). " + "To enable fast marshalling upgrade to recent 1.6 or 1.7 HotSpot VM release. "+ "Switching to standard JDK marshalling - "+ "object serialization performance will be significantly slower.","To enable fast marshalling upgrade to recent 1.6 or 1.7 HotSpot VM release.");
      marsh=new JdkMarshaller();
    }
 else     marsh=new OptimizedMarshaller();
  }
 else   if (marsh instanceof OptimizedMarshaller && !U.isHotSpot()) {
    U.warn(log,"Using OptimizedMarshaller on untested JVM (only Java HotSpot VMs were tested) - " + "object serialization behavior could yield unexpected results.","Using GridOptimizedMarshaller on untested JVM.");
  }
  String depModeName=IgniteSystemProperties.getString(IGNITE_DEP_MODE_OVERRIDE);
  if (!F.isEmpty(depModeName)) {
    if (!F.isEmpty(myCfg.getCacheConfiguration())) {
      U.quietAndInfo(log,"Skipping deployment mode override for caches (custom closure " + "execution may not work for console Visor)");
    }
 else {
      try {
        DeploymentMode depMode=DeploymentMode.valueOf(depModeName);
        if (myCfg.getDeploymentMode() != depMode)         myCfg.setDeploymentMode(depMode);
      }
 catch (      IllegalArgumentException e) {
        throw new IgniteCheckedException("Failed to override deployment mode using system property " + "(are there any misspellings?)" + "[name=" + IGNITE_DEP_MODE_OVERRIDE + ", value="+ depModeName+ ']',e);
      }
    }
  }
  myCfg.setMarshaller(marsh);
  myCfg.setConnectorConfiguration(myCfg.getConnectorConfiguration() != null ? new ConnectorConfiguration(myCfg.getConnectorConfiguration()) : null);
  IgfsConfiguration[] igfsCfgs=myCfg.getIgfsConfiguration();
  if (igfsCfgs != null) {
    IgfsConfiguration[] clone=igfsCfgs.clone();
    for (int i=0; i < igfsCfgs.length; i++)     clone[i]=new IgfsConfiguration(igfsCfgs[i]);
    myCfg.setIgfsConfiguration(clone);
  }
  if (myCfg.getMBeanServer() == null)   myCfg.setMBeanServer(ManagementFactory.getPlatformMBeanServer());
  if (myCfg.getNodeId() == null)   myCfg.setNodeId(UUID.randomUUID());
  if (myCfg.getPeerClassLoadingLocalClassPathExclude() == null)   myCfg.setPeerClassLoadingLocalClassPathExclude(EMPTY_STR_ARR);
  StreamerConfiguration[] streamerCfgs=myCfg.getStreamerConfiguration();
  if (streamerCfgs != null) {
    StreamerConfiguration[] clone=streamerCfgs.clone();
    for (int i=0; i < streamerCfgs.length; i++)     clone[i]=new StreamerConfiguration(streamerCfgs[i]);
    myCfg.setStreamerConfiguration(clone);
  }
  myCfg.setTransactionConfiguration(myCfg.getTransactionConfiguration() != null ? new TransactionConfiguration(myCfg.getTransactionConfiguration()) : null);
  if (myCfg.getUserAttributes() == null) {
    Map<String,?> emptyAttr=Collections.emptyMap();
    myCfg.setUserAttributes(emptyAttr);
  }
  initializeDefaultCacheConfiguration(myCfg);
  initializeDefaultSpi(myCfg);
  return myCfg;
}
