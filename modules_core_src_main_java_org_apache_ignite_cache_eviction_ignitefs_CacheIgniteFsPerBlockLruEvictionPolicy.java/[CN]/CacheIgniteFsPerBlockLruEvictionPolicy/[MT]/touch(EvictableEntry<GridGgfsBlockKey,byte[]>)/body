{
  byte[] val=peek(entry);
  int blockSize=val != null ? val.length : 0;
  MetaEntry meta=entry.meta();
  if (meta == null) {
    while (true) {
      Node<EvictableEntry<GridGgfsBlockKey,byte[]>> node=queue.offerLastx(entry);
      meta=new MetaEntry(node,blockSize);
      if (entry.putMetaIfAbsent(meta) != null) {
        queue.unlinkx(node);
        return false;
      }
 else       if (node.item() != null) {
        if (!entry.isCached()) {
          queue.unlinkx(node);
          return false;
        }
        changeSize(blockSize);
        return true;
      }
 else       if (!entry.removeMeta(node))       return false;
    }
  }
 else {
    int oldBlockSize=meta.size();
    Node<EvictableEntry<GridGgfsBlockKey,byte[]>> node=meta.node();
    if (queue.unlinkx(node)) {
      Node<EvictableEntry<GridGgfsBlockKey,byte[]>> newNode=queue.offerLastx(entry);
      int delta=blockSize - oldBlockSize;
      if (!entry.replaceMeta(meta,new MetaEntry(newNode,blockSize))) {
        if (queue.unlinkx(newNode))         delta-=blockSize;
      }
      if (delta != 0) {
        changeSize(delta);
        if (delta > 0)         return true;
      }
    }
  }
  return false;
}
