{
  if (dsCacheCtx == null)   return;
  if (!dsCacheCtx.isDht() && tx.internal() && (!dsCacheCtx.isColocated() || dsCacheCtx.isReplicated())) {
    Collection<IgniteTxEntry> entries=tx.writeEntries();
    if (log.isDebugEnabled())     log.debug("Committed entries: " + entries);
    for (    IgniteTxEntry entry : entries) {
      if ((entry.op() == CREATE || entry.op() == UPDATE) && entry.key().internal()) {
        GridCacheInternal key=(GridCacheInternal)entry.key();
        Object val0=CU.value(entry.value(),entry.context());
        if (val0 instanceof GridCacheCountDownLatchValue) {
          GridCacheRemovable latch=dsMap.get(key);
          GridCacheCountDownLatchValue val=(GridCacheCountDownLatchValue)val0;
          if (latch instanceof GridCacheCountDownLatchEx) {
            GridCacheCountDownLatchEx latch0=(GridCacheCountDownLatchEx)latch;
            latch0.onUpdate(val.get());
            if (val.get() == 0 && val.autoDelete()) {
              entry.cached().markObsolete(dsCacheCtx.versions().next());
              dsMap.remove(key);
              latch.onRemoved();
            }
          }
 else           if (latch != null) {
            U.error(log,"Failed to cast object " + "[expected=" + IgniteCountDownLatch.class.getSimpleName() + ", actual="+ latch.getClass()+ ", value="+ latch+ ']');
          }
        }
      }
      if (entry.op() == DELETE && entry.key() instanceof GridCacheInternal) {
        GridCacheInternal key=(GridCacheInternal)entry.key();
        GridCacheRemovable obj=dsMap.remove(key);
        if (obj != null)         obj.onRemoved();
      }
    }
  }
}
