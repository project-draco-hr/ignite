{
  while (!cancelled) {
    lock.lock();
    try {
      if (!cancelled && nextBatch == null)       cond.await(THREAD_REUSE_WAIT_TIME,TimeUnit.MILLISECONDS);
      curBatch=nextBatch;
      nextBatch=null;
      if (cancelled && curBatch != null)       curBatch.finish();
    }
  finally {
      lock.unlock();
    }
    if (curBatch != null)     curBatch.process();
 else {
      lock.lock();
      try {
        if (nextBatch == null)         cancelled=true;
      }
  finally {
        lock.unlock();
      }
    }
  }
}
