{
  ThreadLocalRandom rnd=ThreadLocalRandom.current();
  for (int i=0; i < 3; i++) {
    try {
      clientNodes=new HashSet<>();
      while (clientNodes.size() < 2)       clientNodes.add(rnd.nextInt(1,NODES_CNT));
      clientNodes.add(NODES_CNT - 1);
      log.info("Test iteration [iter=" + i + ", clients="+ clientNodes+ ']');
      Ignite srv=startGrid(0);
      assertFalse(srv.configuration().isClientMode());
      startGridsMultiThreaded(1,NODES_CNT - 1);
      checkTopology(NODES_CNT);
      awaitPartitionMapExchange();
      for (      int node : clientNodes) {
        Ignite ignite=grid(node);
        assertTrue(ignite.configuration().isClientMode());
      }
    }
  finally {
      stopAllGrids();
    }
  }
}
