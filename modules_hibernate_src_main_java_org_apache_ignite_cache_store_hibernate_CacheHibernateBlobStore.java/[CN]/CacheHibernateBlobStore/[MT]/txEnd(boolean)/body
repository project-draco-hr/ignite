{
  init();
  Transaction tx=transaction();
  Map<String,Session> props=session().properties();
  Session ses=props.remove(ATTR_SES);
  if (ses != null) {
    org.hibernate.Transaction hTx=ses.getTransaction();
    if (hTx != null) {
      try {
        if (commit) {
          ses.flush();
          hTx.commit();
        }
 else         hTx.rollback();
        if (log.isDebugEnabled())         log.debug("Transaction ended [xid=" + tx.xid() + ", commit="+ commit+ ']');
      }
 catch (      HibernateException e) {
        throw new CacheWriterException("Failed to end transaction [xid=" + tx.xid() + ", commit="+ commit+ ']',e);
      }
 finally {
        ses.close();
      }
    }
  }
}
