{
  String histProp=System.getProperty(IgniteSystemProperties.IGNITE_AFFINITY_HISTORY_SIZE);
  try {
    System.setProperty(IgniteSystemProperties.IGNITE_AFFINITY_HISTORY_SIZE,"5");
    Ignite ignite=startGrid(0);
    checkHistory(ignite,F.asList(topVer(1,0)),1);
    for (int i=0; i < 3; i++) {
      startGrid(1);
      stopGrid(1);
    }
    checkHistory(ignite,F.asList(topVer(3,0),topVer(4,0),topVer(5,0),topVer(6,0),topVer(7,0)),5);
    client=true;
    startGrid(1);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(3,0),topVer(4,0),topVer(5,0),topVer(6,0),topVer(7,0),topVer(8,0),topVer(9,0)),5);
    startGrid(1);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(3,0),topVer(4,0),topVer(5,0),topVer(6,0),topVer(7,0),topVer(8,0),topVer(9,0),topVer(10,0),topVer(11,0)),5);
    startGrid(1);
    checkHistory(ignite,F.asList(topVer(3,0),topVer(4,0),topVer(5,0),topVer(6,0),topVer(7,0),topVer(8,0),topVer(9,0),topVer(10,0),topVer(11,0),topVer(12,0)),5);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(8,0),topVer(9,0),topVer(10,0),topVer(11,0),topVer(12,0),topVer(13,0)),0);
    client=false;
    startGrid(1);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(8,0),topVer(9,0),topVer(10,0),topVer(11,0),topVer(12,0),topVer(13,0),topVer(14,0),topVer(15,0)),2);
    startGrid(1);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(8,0),topVer(9,0),topVer(10,0),topVer(11,0),topVer(12,0),topVer(13,0),topVer(14,0),topVer(15,0),topVer(16,0),topVer(17,0)),4);
    startGrid(1);
    checkHistory(ignite,F.asList(topVer(13,0),topVer(14,0),topVer(15,0),topVer(16,0),topVer(17,0),topVer(18,0)),5);
    stopGrid(1);
    checkHistory(ignite,F.asList(topVer(14,0),topVer(15,0),topVer(16,0),topVer(17,0),topVer(18,0),topVer(19,0)),6);
    startGrid(1);
    checkHistory(ignite,F.asList(topVer(16,0),topVer(17,0),topVer(18,0),topVer(19,0),topVer(20,0)),5);
    client=true;
    startGrid(2);
    stopGrid(2);
    checkHistory(ignite,F.asList(topVer(16,0),topVer(17,0),topVer(18,0),topVer(19,0),topVer(20,0),topVer(21,0),topVer(22,0)),5);
  }
  finally {
    if (histProp != null)     System.setProperty(IgniteSystemProperties.IGNITE_AFFINITY_HISTORY_SIZE,histProp);
 else     System.clearProperty(IgniteSystemProperties.IGNITE_AFFINITY_HISTORY_SIZE);
  }
}
