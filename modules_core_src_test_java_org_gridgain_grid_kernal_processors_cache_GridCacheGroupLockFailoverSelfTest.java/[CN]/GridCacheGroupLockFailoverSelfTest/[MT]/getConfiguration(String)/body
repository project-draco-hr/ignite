{
  IgniteConfiguration cfg=super.getConfiguration(gridName);
  cfg.setPeerClassLoadingEnabled(false);
  cfg.setDeploymentMode(IgniteDeploymentMode.CONTINUOUS);
  GridTcpDiscoverySpi discoverySpi=new GridTcpDiscoverySpi();
  discoverySpi.setAckTimeout(60000);
  discoverySpi.setIpFinder(ipFinder);
  cfg.setDiscoverySpi(discoverySpi);
  if (gridName.startsWith("master")) {
    cfg.setUserAttributes(ImmutableMap.of("segment","master"));
    GridTestFailoverSpi failoverSpi=new GridTestFailoverSpi(true,(IgnitePredicate)workerNodesFilter);
    failoverSpi.setMaximumFailoverAttempts(50);
    cfg.setFailoverSpi(failoverSpi);
  }
 else   if (gridName.startsWith("worker")) {
    GridTestFailoverSpi failoverSpi=new GridTestFailoverSpi(false);
    cfg.setFailoverSpi(failoverSpi);
    cfg.setUserAttributes(ImmutableMap.of("segment","worker"));
    GridCacheConfiguration cacheCfg=defaultCacheConfiguration();
    cacheCfg.setName("partitioned");
    cacheCfg.setCacheMode(GridCacheMode.PARTITIONED);
    cacheCfg.setStartSize(4500000);
    cacheCfg.setBackups(backups);
    cacheCfg.setDgcSuspectLockTimeout(600000);
    cacheCfg.setDgcFrequency(0);
    cacheCfg.setStoreValueBytes(true);
    cacheCfg.setDistributionMode(nearEnabled ? NEAR_PARTITIONED : PARTITIONED_ONLY);
    cacheCfg.setQueryIndexEnabled(false);
    cacheCfg.setWriteSynchronizationMode(FULL_SYNC);
    cacheCfg.setAtomicityMode(TRANSACTIONAL);
    cfg.setCacheConfiguration(cacheCfg);
  }
 else   throw new IllegalStateException("Unexpected grid name: " + gridName);
  return cfg;
}
