{
  GridDiscoverySpi discoSpi=spiTest.discoverySpi().newInstance();
  if (discoSpi instanceof GridTcpDiscoverySpi) {
    GridTcpDiscoverySpi tcpDisco=(GridTcpDiscoverySpi)discoSpi;
    tcpDisco.setIpFinder(new GridTcpDiscoveryVmIpFinder(true));
  }
  getTestData().setDiscoverySpi(discoSpi);
  getTestResources().inject(discoSpi);
  configure(discoSpi);
  if (discoSpi.getNodeAttributes() != null)   getTestData().getAttributes().putAll(discoSpi.getNodeAttributes());
}
