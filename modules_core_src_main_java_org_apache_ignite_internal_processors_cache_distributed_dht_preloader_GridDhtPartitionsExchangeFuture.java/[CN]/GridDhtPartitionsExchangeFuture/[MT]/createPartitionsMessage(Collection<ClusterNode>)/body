{
  GridCacheVersion last=lastVer.get();
  GridDhtPartitionsFullMessage m=new GridDhtPartitionsFullMessage(exchangeId(),last != null ? last : cctx.versions().last(),topologyVersion());
  boolean useOldApi=false;
  if (nodes != null) {
    for (    ClusterNode node : nodes) {
      if (node.version().compareTo(GridDhtPartitionMap2.SINCE) < 0)       useOldApi=true;
    }
  }
  for (  GridCacheContext cacheCtx : cctx.cacheContexts()) {
    if (!cacheCtx.isLocal()) {
      AffinityTopologyVersion startTopVer=cacheCtx.startTopologyVersion();
      boolean ready=startTopVer == null || startTopVer.compareTo(topologyVersion()) <= 0;
      if (ready) {
        GridDhtPartitionFullMap locMap=cacheCtx.topology().partitionMap(true);
        if (useOldApi)         locMap=new GridDhtPartitionFullMap(locMap.nodeId(),locMap.nodeOrder(),locMap.updateSequence(),locMap);
        m.addFullPartitionsMap(cacheCtx.cacheId(),locMap);
        m.addPartitionUpdateCounters(cacheCtx.cacheId(),cacheCtx.topology().updateCounters());
      }
    }
  }
  for (  GridClientPartitionTopology top : cctx.exchange().clientTopologies()) {
    m.addFullPartitionsMap(top.cacheId(),top.partitionMap(true));
    m.addPartitionUpdateCounters(top.cacheId(),top.updateCounters());
  }
  return m;
}
