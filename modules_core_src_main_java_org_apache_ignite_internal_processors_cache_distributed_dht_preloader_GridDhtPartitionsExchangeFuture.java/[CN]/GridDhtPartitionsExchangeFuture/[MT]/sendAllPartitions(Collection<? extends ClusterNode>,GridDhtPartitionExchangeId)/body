{
  GridDhtPartitionsFullMessage m=new GridDhtPartitionsFullMessage(id,lastVer.get(),id.topologyVersion());
  boolean useOldApi=false;
  for (  ClusterNode node : nodes) {
    if (node.version().compareTo(GridDhtPartitionMap2.SINCE) < 0)     useOldApi=true;
  }
  for (  GridCacheContext cacheCtx : cctx.cacheContexts()) {
    if (!cacheCtx.isLocal()) {
      AffinityTopologyVersion startTopVer=cacheCtx.startTopologyVersion();
      boolean ready=startTopVer == null || startTopVer.compareTo(id.topologyVersion()) <= 0;
      if (ready) {
        GridDhtPartitionFullMap locMap=cacheCtx.topology().partitionMap(true);
        if (useOldApi) {
          locMap=new GridDhtPartitionFullMap(locMap.nodeId(),locMap.nodeOrder(),locMap.updateSequence(),locMap);
        }
        m.addFullPartitionsMap(cacheCtx.cacheId(),locMap);
        m.addPartitionUpdateCounters(cacheCtx.cacheId(),cacheCtx.topology().updateCounters());
      }
    }
  }
  for (  GridClientPartitionTopology top : cctx.exchange().clientTopologies()) {
    m.addFullPartitionsMap(top.cacheId(),top.partitionMap(true));
    m.addPartitionUpdateCounters(top.cacheId(),top.updateCounters());
  }
  if (log.isDebugEnabled())   log.debug("Sending full partition map [nodeIds=" + F.viewReadOnly(nodes,F.node2id()) + ", exchId="+ exchId+ ", msg="+ m+ ']');
  cctx.io().safeSend(nodes,m,SYSTEM_POOL,null);
}
