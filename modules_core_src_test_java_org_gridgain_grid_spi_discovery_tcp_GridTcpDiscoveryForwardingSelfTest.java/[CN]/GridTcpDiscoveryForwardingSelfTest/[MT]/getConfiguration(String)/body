{
  GridTcpDiscoveryVmIpFinder ipFinder=new GridTcpDiscoveryVmIpFinder();
  ipFinder.setAddresses(Arrays.asList("127.0.0.1:" + extPort1,"127.0.0.1:" + extPort2));
  GridTcpDiscoverySpi spi=new GridTcpDiscoverySpi();
  final int locPort;
  final int extPort;
  if (getTestGridName(0).equals(gridName)) {
    locPort=localPort1;
    extPort=extPort1;
  }
 else   if (getTestGridName(1).equals(gridName)) {
    locPort=localPort2;
    extPort=extPort2;
  }
 else   throw new IllegalArgumentException("Unknown grid name");
  spi.setIpFinder(ipFinder);
  GridConfiguration cfg=super.getConfiguration(gridName);
  spi.setLocalPort(locPort);
  spi.setLocalPortRange(1);
  cfg.setDiscoverySpi(spi);
  cfg.setLocalHost("127.0.0.1");
  cfg.setRestEnabled(false);
  cfg.setMarshaller(new GridOptimizedMarshaller(false));
  cfg.setAddressResolver(new GridAddressResolver(){
    @Override public Collection<InetSocketAddress> getExternalAddresses(    InetSocketAddress addr){
      return addr.equals(new InetSocketAddress("127.0.0.1",locPort)) ? F.asList(new InetSocketAddress("127.0.0.1",extPort)) : null;
    }
  }
);
  return cfg;
}
