{
  super.prepareMarshal(ctx);
  if (ownedVals != null && ownedValsBytes == null) {
    ownedValsBytes=new ArrayList<>(ownedVals.size());
    for (    Map.Entry<IgniteTxKey,IgniteBiTuple<GridCacheVersion,CacheObject>> entry : ownedVals.entrySet()) {
      IgniteBiTuple<GridCacheVersion,CacheObject> tup=entry.getValue();
      GridCacheContext cctx=ctx.cacheContext(entry.getKey().cacheId());
      entry.getKey().prepareMarshal(cctx);
      CacheObject val=tup.get2();
      if (val != null)       val.prepareMarshal(cctx.cacheObjectContext());
      ownedValsBytes.add(ctx.marshaller().marshal(F.t(entry.getKey(),tup.get1(),val)));
    }
  }
  if (retValBytes == null && retVal != null)   retValBytes=ctx.marshaller().marshal(retVal);
  if (filterFailedKeys != null) {
    for (    IgniteTxKey key : filterFailedKeys) {
      GridCacheContext cctx=ctx.cacheContext(key.cacheId());
      key.prepareMarshal(cctx);
    }
  }
}
