{
  checkObsolete();
  if (curVer == null || curVer.equals(ver)) {
    if (val != this.val) {
      GridCacheMvcc mvcc=mvccExtras();
      if (mvcc != null && !mvcc.isEmpty())       return null;
      if (newVer == null)       newVer=cctx.versions().next();
      CacheObject old=rawGetOrUnmarshalUnlocked(false);
      long ttl=ttlExtras();
      long expTime=CU.toExpireTime(ttl);
      val=cctx.kernalContext().cacheObjects().prepareForCache(val,cctx);
      if (val != null) {
        updateIndex(val,expTime,newVer,old);
        if (deletedUnlocked())         deletedUnlocked(false);
      }
      update(val,expTime,ttl,newVer);
      return newVer;
    }
  }
  return null;
}
