{
  int keyHash=key.hashCode();
  byte[] keyBytes=marsh.marshal(key);
  Lock l=filesLock.readLock();
  l.lock();
  try {
    DataEntry old=findEntry(keyHash,keyBytes);
    if (old == null && val == null)     return;
    StoreFile file=curFile;
    AbstractFileEntry entry;
    if (val == null)     entry=new RmvEntry(0,keyBytes,keyHash,file.fileIdx,maxCompactIdx);
 else     entry=new PutEntry(keyBytes,keyHash,marsh.marshal(val),0,store.checksum);
    long addr=file.write(entry);
    updateMap(val,old,keyHash,keyBytes,addr);
  }
  finally {
    l.unlock();
  }
}
