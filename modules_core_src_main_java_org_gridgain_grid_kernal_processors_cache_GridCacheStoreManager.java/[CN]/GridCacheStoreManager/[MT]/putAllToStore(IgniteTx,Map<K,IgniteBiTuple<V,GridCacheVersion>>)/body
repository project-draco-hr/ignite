{
  if (F.isEmpty(map))   return true;
  if (map.size() == 1) {
    Map.Entry<K,IgniteBiTuple<V,GridCacheVersion>> e=map.entrySet().iterator().next();
    return putToStore(tx,e.getKey(),e.getValue().get1(),e.getValue().get2());
  }
 else {
    if (store != null) {
      Map<K,IgniteBiTuple<V,GridCacheVersion>> map0;
      if (convertPortable) {
        map0=U.newHashMap(map.size());
        for (        Map.Entry<K,IgniteBiTuple<V,GridCacheVersion>> e : map.entrySet()) {
          IgniteBiTuple<V,GridCacheVersion> t=e.getValue();
          map0.put((K)cctx.unwrapPortableIfNeeded(e.getKey(),false),F.t((V)cctx.unwrapPortableIfNeeded(t.get1(),false),t.get2()));
        }
      }
 else       map0=map;
      if (log.isDebugEnabled())       log.debug("Storing values in cache store [map=" + map0 + ']');
      boolean ses=initSession(tx);
      try {
        store.putAll(tx,locStore ? map0 : F.viewReadOnly(map0,new C1<IgniteBiTuple<V,GridCacheVersion>,Object>(){
          @Override public Object apply(          IgniteBiTuple<V,GridCacheVersion> t){
            return t.get1();
          }
        }
));
      }
 catch (      ClassCastException e) {
        handleClassCastException(e);
      }
 finally {
        sesHolder.set(null);
      }
      if (log.isDebugEnabled())       log.debug("Stored value in cache store [map=" + map0 + ']');
      return true;
    }
    return false;
  }
}
