{
  A.notNull(f,"f");
  enterBusy();
  try {
    GridGgfsPath path=convert(f);
    GridGgfsMode mode=mode(path);
    if (mode == PROXY) {
      if (secondaryFs == null) {
        assert mgmt;
        throw new IOException("Failed to open file (secondary file system is not initialized): " + f);
      }
      FSDataInputStream is=secondaryFs.open(toSecondary(f),bufSize);
      if (clientLog.isLogEnabled()) {
        FileStatus status=secondaryFs.getFileStatus(toSecondary(f));
        long size=status != null ? status.getLen() : -1;
        long logId=GridGgfsHadoopLogger.nextId();
        clientLog.logOpen(logId,path,PROXY,bufSize,size);
        return new FSDataInputStream(new GridGgfsHadoopProxyInputStream(is,clientLog,logId));
      }
 else       return is;
    }
 else {
      GridGgfsInputStreamDescriptor desc=seqReadsBeforePrefetchOverride ? rmtClient.open(path,seqReadsBeforePrefetch).get() : rmtClient.open(path).get();
      long logId=-1;
      if (clientLog.isLogEnabled()) {
        logId=GridGgfsHadoopLogger.nextId();
        clientLog.logOpen(logId,path,mode,bufSize,desc.length());
      }
      if (LOG.isDebugEnabled())       LOG.debug("Opening input stream [thread=" + Thread.currentThread().getName() + ", path="+ path+ ", bufSize="+ bufSize+ ']');
      GridGgfsHadoopInputStream ggfsIn=new GridGgfsHadoopInputStream(rmtClient,desc.streamId(),desc.length(),bufSize,LOG,clientLog,logId);
      if (LOG.isDebugEnabled())       LOG.debug("Opened input stream [path=" + path + ", streamId="+ desc.streamId()+ ']');
      return new FSDataInputStream(ggfsIn);
    }
  }
 catch (  GridException e) {
    throw new IOException("Failed to open a file [path=" + f + ", bufferSize="+ bufSize+ ']',e);
  }
 finally {
    leaveBusy();
  }
}
