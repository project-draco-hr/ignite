{
  for (int splitPos=1; splitPos < 5; splitPos++) {
    log.info("Checking split position: " + splitPos);
    ByteBuffer tmp=clientHandshakePacket(U.OPTIMIZED_CLIENT_PROTO_ID);
    ByteBuffer[] split=split(tmp,splitPos);
    GridNioSession ses=new GridMockNioSession();
    GridTcpRestParser parser=new GridTcpRestParser(log);
    Collection<GridClientMessage> lst=new ArrayList<>(1);
    for (    ByteBuffer buf : split) {
      GridClientMessage r;
      while (buf.hasRemaining() && (r=parser.decode(ses,buf)) != null)       lst.add(r);
      assertTrue("Parser has left unparsed bytes.",buf.remaining() == 0);
    }
    assertEquals(1,lst.size());
    GridClientHandshakeRequest req=(GridClientHandshakeRequest)F.first(lst);
    assertNotNull(req);
    assertEquals(U.OPTIMIZED_CLIENT_PROTO_ID,req.protocolId());
    assertTrue(Arrays.equals(new byte[]{5,0,0,0},req.versionBytes()));
  }
}
