{
  rmtNodes=new ConcurrentLinkedQueue<>(CU.aliveRemoteNodes(cctx,exchId.topologyVersion()));
  rmtIds=Collections.unmodifiableSet(new HashSet<>(F.nodeIds(rmtNodes)));
  for (  Map.Entry<UUID,GridDhtPartitionsSingleMessage<K,V>> m : new HashMap<>(msgs).entrySet()) {
    onReceive(m.getKey(),m.getValue());
  }
  if (canCalculateAffinity()) {
    if (log.isDebugEnabled())     log.debug("Will recalculate affinity [locNodeId=" + cctx.localNodeId() + ", exchId="+ exchId+ ']');
    cctx.affinity().calculateAffinity(exchId.topologyVersion(),discoEvt);
  }
 else {
    if (log.isDebugEnabled())     log.debug("Will request affinity from remote node [locNodeId=" + cctx.localNodeId() + ", exchId="+ exchId+ ']');
    GridDhtAssignmentFetchFuture<K,V> fetchFut=new GridDhtAssignmentFetchFuture<>(cctx,exchId.topologyVersion(),CU.affinityNodes(cctx));
    fetchFut.init();
    List<List<GridNode>> affAssignment=fetchFut.get();
    if (log.isDebugEnabled())     log.debug("Fetched affinity from remote node, initializing affinity assignment [locNodeId=" + cctx.localNodeId() + ", topVer="+ exchId.topologyVersion()+ ']');
    cctx.affinity().initializeAffinity(exchId.topologyVersion(),affAssignment);
  }
  if (oldestNode.get().id().equals(cctx.nodeId())) {
    if (allReceived() && ready.get() && replied.compareAndSet(false,true)) {
      spreadPartitions(top.partitionMap(true));
      onDone(exchId.topologyVersion());
    }
  }
}
