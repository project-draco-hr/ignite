{
  lock.writeLock().lock();
  try {
    boolean newNode=!nodes.containsKey(node.nodeId());
    GridClientNodeImpl preparedNode=prepareNode(node);
    if (newNode || metricsCache || attrCache) {
      Map<UUID,GridClientNodeImpl> updatedTop=new HashMap<>(nodes);
      updatedTop.put(node.nodeId(),preparedNode);
      nodes=updatedTop;
      lastError=null;
    }
    if (newNode)     notifyEvents(Collections.singletonList(new TopologyEvent(true,preparedNode)));
    return preparedNode;
  }
  finally {
    lock.writeLock().unlock();
  }
}
