{
  if (!busyLock.enterBusy())   throw new IllegalStateException("Failed to start new threads (test is being stopped).");
  try {
    final GridTestSafeThreadFactory thrFactory=new GridTestSafeThreadFactory("async-runner");
    final GridFutureAdapter<T> fut=new GridFutureAdapter<T>(){
      @Override public boolean cancel() throws IgniteCheckedException {
        super.cancel();
        thrFactory.interruptAllThreads();
        onCancelled();
        return true;
      }
    }
;
    thrFactory.newThread(new Runnable(){
      @Override public void run(){
        try {
          T res=task.call();
          fut.onDone(res);
        }
 catch (        Throwable e) {
          fut.onDone(e);
        }
      }
    }
).start();
    return fut;
  }
  finally {
    busyLock.leaveBusy();
  }
}
