{
  long timeout=cctx.gridConfig().getNetworkTimeout();
  long delay=cctx.config().getPreloadPartitionedDelay();
  boolean startEvtFired=false;
  while (!isCancelled()) {
    GridDhtPartitionsExchangeFuture<K,V> exchFut=null;
    try {
      if (futQ.isEmpty() && syncFut.isDone()) {
        refreshPartitions(timeout);
        timeout=cctx.gridConfig().getNetworkTimeout();
      }
      if (log.isDebugEnabled())       log.debug("Before waiting for exchange futures [futs" + F.view((cctx.dht().dhtPreloader()).exchangeFutures(),F.unfinishedFutures()) + ", worker="+ this+ ']');
      exchFut=poll(futQ,timeout,this);
      if (exchFut == null)       continue;
      busy=true;
      Assignments assigns=null;
      boolean dummyReassign=dummyReassign(exchFut);
      boolean forcePreload=forcePreload(exchFut);
      try {
        if (isCancelled())         break;
        if (!dummyExchange(exchFut) && !forcePreload(exchFut)) {
          lastExchangeFut.set(exchFut);
          exchFut.init();
          exchFut.get();
          if (log.isDebugEnabled())           log.debug("After waiting for exchange future [exchFut=" + exchFut + ", worker="+ this+ ']');
          if (exchFut.exchangeId().nodeId().equals(cctx.localNodeId()))           lastRefresh.compareAndSet(-1,U.currentTimeMillis());
          if (top.afterExchange(exchFut.exchangeId()))           resendPartitions();
          if (cctx.events().isRecordable(EVT_CACHE_PRELOAD_STARTED)) {
            if (!cctx.isReplicated() || !startEvtFired) {
              preloadEvent(EVT_CACHE_PRELOAD_STARTED,exchFut.discoveryEvent());
              startEvtFired=true;
            }
          }
        }
 else {
          if (log.isDebugEnabled())           log.debug("Got dummy exchange (will reassign)");
          if (!dummyReassign) {
            timeout=0;
            continue;
          }
        }
        if (delay == 0 || forcePreload)         assigns=assign(exchFut);
      }
  finally {
        busy=false;
      }
      addAssignments(assigns,forcePreload);
    }
 catch (    GridInterruptedException e) {
      throw e;
    }
catch (    GridException e) {
      U.error(log,"Failed to wait for completion of partition map exchange " + "(preloading will not start): " + exchFut,e);
    }
  }
}
