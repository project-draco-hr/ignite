{
  Ignite ignite0=startGrid(0);
  Ignite ignite1=startGrid(1);
  waitForTopologyUpdate(2,2);
  final String CACHE_NAME="cache1";
  CacheConfiguration ccfg=new CacheConfiguration();
  ccfg.setName(CACHE_NAME);
  ignite0.createCache(ccfg);
  client=true;
  Ignite ignite2=startGrid(2);
  waitForTopologyUpdate(3,3);
  TestCommunicationSpi spi0=(TestCommunicationSpi)ignite0.configuration().getCommunicationSpi();
  TestCommunicationSpi spi1=(TestCommunicationSpi)ignite1.configuration().getCommunicationSpi();
  TestCommunicationSpi spi2=(TestCommunicationSpi)ignite2.configuration().getCommunicationSpi();
  spi0.reset();
  spi1.reset();
  spi2.reset();
  assertNull(((IgniteKernal)ignite2).context().cache().context().cache().internalCache("cache1"));
  if (nearCache)   ignite2.getOrCreateNearCache(CACHE_NAME,new NearCacheConfiguration<>());
 else   ignite2.cache(CACHE_NAME);
  GridCacheAdapter cache=((IgniteKernal)ignite2).context().cache().context().cache().internalCache("cache1");
  assertNotNull(cache);
  assertEquals(nearCache,cache.context().isNear());
  assertEquals(0,spi0.partitionsSingleMessages());
  assertEquals(0,spi0.partitionsFullMessages());
  assertEquals(0,spi1.partitionsSingleMessages());
  assertEquals(0,spi1.partitionsFullMessages());
  assertEquals(0,spi2.partitionsSingleMessages());
  assertEquals(0,spi2.partitionsFullMessages());
  ClusterNode clientNode=((IgniteKernal)ignite2).localNode();
  for (  Ignite ignite : Ignition.allGrids()) {
    GridDiscoveryManager disco=((IgniteKernal)ignite).context().discovery();
    assertTrue(disco.cacheNode(clientNode,CACHE_NAME));
    assertFalse(disco.cacheAffinityNode(clientNode,CACHE_NAME));
    assertEquals(nearCache,disco.cacheNearNode(clientNode,CACHE_NAME));
  }
}
