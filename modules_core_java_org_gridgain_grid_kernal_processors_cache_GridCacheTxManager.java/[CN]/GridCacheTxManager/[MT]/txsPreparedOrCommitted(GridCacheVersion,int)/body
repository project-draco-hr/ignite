{
  Collection<GridCacheVersion> processedVers=null;
  for (  Map.Entry<GridCacheVersion,GridCacheTxEx<K,V>> e : idMap.entrySet()) {
    GridCacheTxEx<K,V> tx=e.getValue();
    if (nearVer.equals(tx.nearXidVersion())) {
      GridCacheTxState state=tx.state();
      if (state == PREPARED || state == COMMITTING || state == COMMITTED) {
        if (--txNum == 0)         return true;
      }
 else {
        if (tx.state(MARKED_ROLLBACK) || tx.state() == UNKNOWN) {
          tx.rollbackAsync();
          if (log.isDebugEnabled())           log.debug("Transaction was not prepared (rolled back): " + tx);
          return false;
        }
 else {
          if (tx.state() == COMMITTED) {
            if (--txNum == 0)             return true;
          }
 else {
            if (log.isDebugEnabled())             log.debug("Transaction is not prepared: " + tx);
            return false;
          }
        }
      }
      if (processedVers == null)       processedVers=new HashSet<>(txNum,1.0f);
      processedVers.add(tx.xidVersion());
    }
  }
  for (  GridCacheVersion ver : committedVers) {
    if (processedVers != null && processedVers.contains(ver))     continue;
    if (ver instanceof CommittedVersion) {
      CommittedVersion commitVer=(CommittedVersion)ver;
      if (commitVer.nearVer.equals(nearVer)) {
        if (--txNum == 0)         return true;
      }
    }
  }
  return false;
}
