{
  MessageAdapter msg=ses.removeMeta(MSG_META_KEY);
  if (msg == null && buf.hasRemaining()) {
    MessageReader reader=formatter.reader(msgFactory);
    reader.setBuffer(buf);
    MessageHeader header=reader.readHeader();
    if (reader.isLastRead()) {
      msg=msgFactory.create(header.messageType());
      msg.setReader(reader);
    }
  }
  boolean finished=false;
  if (buf.hasRemaining())   finished=msg.readFrom(buf);
  if (finished)   return msg;
 else {
    ses.addMeta(MSG_META_KEY,msg);
    return null;
  }
}
