{
  if (map != null) {
    if (it == null) {
      writeInt(map.size());
      if (!lastFinished)       return;
      it=map.entrySet().iterator();
    }
    IgniteInClosure<Object> keyWriter=WRITERS.get(keyCls);
    IgniteInClosure<Object> valWriter=WRITERS.get(valCls);
    while (it.hasNext() || cur != NULL) {
      if (cur == NULL)       cur=it.next();
      Map.Entry<K,V> e=(Map.Entry<K,V>)cur;
      if (!keyDone) {
        keyWriter.apply(e.getKey());
        if (!lastFinished)         return;
        keyDone=true;
      }
      valWriter.apply(e.getValue());
      if (!lastFinished)       return;
      cur=NULL;
      keyDone=false;
    }
    it=null;
  }
 else   writeInt(-1);
}
