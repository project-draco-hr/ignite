{
  if (msg != null) {
    if (buf.hasRemaining()) {
      MessageWriteState state=MessageWriteState.get();
      try {
        state.forward();
        lastFinished=msg.writeTo(buf);
      }
  finally {
        state.backward(lastFinished);
      }
    }
 else     lastFinished=false;
  }
 else   writeByte(Byte.MIN_VALUE);
}
