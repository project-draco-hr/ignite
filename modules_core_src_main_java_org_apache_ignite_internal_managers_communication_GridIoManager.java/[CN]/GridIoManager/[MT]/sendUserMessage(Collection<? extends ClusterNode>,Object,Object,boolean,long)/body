{
  boolean loc=nodes.size() == 1 && F.first(nodes).id().equals(locNodeId);
  byte[] serMsg=null;
  byte[] serTopic=null;
  if (!loc) {
    serMsg=marsh.marshal(msg);
    if (topic != null)     serTopic=marsh.marshal(topic);
  }
  GridDeployment dep=null;
  String depClsName=null;
  if (ctx.config().isPeerClassLoadingEnabled()) {
    Class<?> cls0=U.detectClass(msg);
    if (U.isJdk(cls0) && topic != null)     cls0=U.detectClass(topic);
    dep=ctx.deploy().deploy(cls0,U.detectClassLoader(cls0));
    if (dep == null)     throw new IgniteDeploymentCheckedException("Failed to deploy user message: " + msg);
    depClsName=cls0.getName();
  }
  GridTcpCommunicationMessageAdapter ioMsg=new GridIoUserMessage(msg,serMsg,depClsName,topic,serTopic,dep != null ? dep.classLoaderId() : null,dep != null ? dep.deployMode() : null,dep != null ? dep.userVersion() : null,dep != null ? dep.participants() : null);
  if (ordered)   sendOrderedMessage(nodes,TOPIC_COMM_USER,ioMsg,PUBLIC_POOL,timeout,true);
 else   if (loc)   send(F.first(nodes),TOPIC_COMM_USER,ioMsg,PUBLIC_POOL);
 else {
    ClusterNode locNode=F.find(nodes,null,F.localNode(locNodeId));
    Collection<? extends ClusterNode> rmtNodes=F.view(nodes,F.remoteNodes(locNodeId));
    if (locNode != null)     send(locNode,TOPIC_COMM_USER,ioMsg,PUBLIC_POOL);
    if (!rmtNodes.isEmpty())     send(rmtNodes,TOPIC_COMM_USER,ioMsg,PUBLIC_POOL);
  }
}
