{
  for (int i=0; i < GRID_CNT; i++)   startGrid(i);
  try {
    for (int i=1; i <= RUN_CNT; i++) {
      Grid g=startGrid();
      try {
        runQuery(g);
      }
  finally {
        stopGrid();
      }
      final int fi=i;
      assertTrue(GridTestUtils.waitForCondition(new PA(){
        @Override public boolean apply(){
          for (int i=0; i < GRID_CNT; i++) {
            Grid g=grid(i);
            GridNodeLocalMap<String,Integer> nodeLoc=g.cluster().nodeLocalMap();
            Integer depCnt=nodeLoc.get(DEPLOY_CNT_KEY);
            Integer undepCnt=nodeLoc.get(UNDEPLOY_CNT_KEY);
            if (depCnt == null || depCnt != fi)             return false;
            if (undepCnt == null || undepCnt != fi)             return false;
          }
          return true;
        }
      }
,getTestTimeout()));
    }
  }
  finally {
    for (int i=0; i < GRID_CNT; i++)     stopGrid(i);
  }
}
