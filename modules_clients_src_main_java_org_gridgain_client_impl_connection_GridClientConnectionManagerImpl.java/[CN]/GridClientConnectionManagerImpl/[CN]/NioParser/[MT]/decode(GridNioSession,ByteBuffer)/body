{
  GridClientFutureAdapter<?> handshakeFut=ses.meta(GridClientNioTcpConnection.SES_META_HANDSHAKE);
  if (handshakeFut != null) {
    byte code=buf.get();
    return new GridClientHandshakeResponse(code);
  }
  GridTcpCommunicationMessageAdapter msg=ses.removeMeta(MSG_META_KEY);
  UUID nodeId=ses.meta(GridNioServer.DIFF_VER_NODE_ID_META_KEY);
  if (msg == null && buf.hasRemaining()) {
    byte type=buf.get();
    if (type == GridClientMessageWrapper.REQ_HEADER)     msg=new GridClientMessageWrapper();
  }
  boolean finished=false;
  if (buf.hasRemaining())   finished=msgReader.read(nodeId,msg,buf);
  if (finished)   return msg;
 else {
    ses.addMeta(MSG_META_KEY,msg);
    return null;
  }
}
