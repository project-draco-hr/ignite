{
  grid(0).cache(Person.class.getSimpleName()).clear();
  grid(0).compute().affinityRun(Arrays.asList(Person.class.getSimpleName(),Organization.class.getSimpleName()),0,new ReservedPartitionCacheOpAffinityRun(0,0));
  beginNodesRestart();
  IgniteInternalFuture<Long> affFut=null;
  try {
    affFut=GridTestUtils.runMultiThreadedAsync(new Runnable(){
      @Override public void run(){
        for (int i=0; i < PARTS_CNT; ++i) {
          if (System.currentTimeMillis() >= endTime)           break;
          grid(0).compute().affinityRun(Arrays.asList(Organization.class.getSimpleName(),Person.class.getSimpleName()),new Integer(i),new ReservedPartitionCacheOpAffinityRun(i,key.getAndIncrement() * KEYS_CNT));
        }
      }
    }
,AFFINITY_THREADS_CNT,"affinity-run");
  }
  finally {
    if (affFut != null)     affFut.get();
    stopRestartThread.set(true);
    nodeRestartFut.get();
    Thread.sleep(5000);
    log.info("Final await. Timed out if failed");
    awaitPartitionMapExchange();
    IgniteCache cache=grid(0).cache(Person.class.getSimpleName());
    cache.clear();
  }
}
