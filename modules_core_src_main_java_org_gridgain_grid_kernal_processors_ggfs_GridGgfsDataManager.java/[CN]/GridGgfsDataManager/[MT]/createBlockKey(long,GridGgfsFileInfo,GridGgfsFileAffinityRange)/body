{
  if (fileInfo.affinityKey() != null)   return new GridGgfsBlockKey(fileInfo.id(),fileInfo.affinityKey(),fileInfo.evictExclude(),block);
  if (locRange == null || locRange.done())   return new GridGgfsBlockKey(fileInfo.id(),null,fileInfo.evictExclude(),block);
  long blockStart=block * fileInfo.blockSize();
  if (locRange.less(blockStart)) {
    IgniteUuid affKey=fileInfo.fileMap().affinityKey(blockStart,false);
    return new GridGgfsBlockKey(fileInfo.id(),affKey,fileInfo.evictExclude(),block);
  }
  if (dataCachePrj.ggfsDataSpaceUsed() > dataCachePrj.ggfsDataSpaceMax() * ggfsCtx.configuration().getFragmentizerLocalWritesRatio()) {
    locRange.markDone();
    return new GridGgfsBlockKey(fileInfo.id(),null,fileInfo.evictExclude(),block);
  }
  if (!locRange.belongs(blockStart))   locRange.expand(blockStart,fileInfo.blockSize());
  return new GridGgfsBlockKey(fileInfo.id(),locRange.affinityKey(),fileInfo.evictExclude(),block);
}
