{
  GridException err=null;
  Delegate curDelegate=delegateRef.get();
  if (curDelegate != null)   return curDelegate;
  GridGgfsEx ggfs=null;
  if (endpoint.grid() == null) {
    try {
      Grid grid=G.grid();
      ggfs=(GridGgfsEx)grid.ggfs(endpoint.ggfs());
    }
 catch (    Exception ignore) {
    }
  }
 else {
    for (    Grid grid : G.allGrids()) {
      try {
        ggfs=(GridGgfsEx)grid.ggfs(endpoint.ggfs());
        break;
      }
 catch (      Exception ignore) {
      }
    }
  }
  if (ggfs != null) {
    try {
      NewGridGgfsHadoopEx hadoop=new NewGridGgfsHadoopInProc(ggfs,log);
      curDelegate=new Delegate(hadoop,hadoop.handshake(logDir));
    }
 catch (    GridException e) {
      log.debug("Failed to connect to in-proc GGFS, fallback to IPC mode.",e);
      err=e;
    }
  }
  if (curDelegate == null && !U.isWindows()) {
    try {
      NewGridGgfsHadoopEx hadoop=new NewGridGgfsHadoopOutProc(log);
      curDelegate=new Delegate(hadoop,hadoop.handshake(logDir));
    }
 catch (    GridException e) {
      log.debug("Failed to connect to out-proc local GGFS using shmem.",e);
      err=e;
    }
  }
  if (curDelegate == null) {
    try {
      NewGridGgfsHadoopEx hadoop=new NewGridGgfsHadoopOutProc(LOCALHOST,endpoint.port(),log);
      curDelegate=new Delegate(hadoop,hadoop.handshake(logDir));
    }
 catch (    GridException e) {
      log.debug("Failed to connect to out-proc local GGFS using TCP.",e);
      err=e;
    }
  }
  if (curDelegate == null && !F.eq(LOCALHOST,endpoint.host())) {
    try {
      NewGridGgfsHadoopEx hadoop=new NewGridGgfsHadoopOutProc(LOCALHOST,endpoint.port(),log);
      curDelegate=new Delegate(hadoop,hadoop.handshake(logDir));
    }
 catch (    GridException e) {
      log.debug("Failed to connect to out-proc remote GGFS using TCP.",e);
      err=e;
    }
  }
  if (curDelegate != null)   return curDelegate;
 else   throw new IOException("Failed to connect to GGFS: " + endpoint,err);
}
