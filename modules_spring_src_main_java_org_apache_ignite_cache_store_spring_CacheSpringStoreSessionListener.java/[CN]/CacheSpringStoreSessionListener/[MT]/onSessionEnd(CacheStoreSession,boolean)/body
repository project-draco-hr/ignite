{
  if (ses.isWithinTransaction()) {
    TransactionStatus tx=ses.attachment();
    if (tx != null) {
      ses.attach(null);
      try {
        if (commit)         txMgr.commit(tx);
 else         txMgr.rollback(tx);
      }
 catch (      TransactionException e) {
        throw new CacheWriterException("Failed to end store session [tx=" + ses.transaction() + ']',e);
      }
    }
  }
}
