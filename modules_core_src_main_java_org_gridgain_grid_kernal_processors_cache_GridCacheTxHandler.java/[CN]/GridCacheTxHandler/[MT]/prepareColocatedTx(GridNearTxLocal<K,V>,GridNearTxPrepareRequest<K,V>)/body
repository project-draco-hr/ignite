{
  IgniteFuture<Object> fut=new GridFinishedFutureEx<>();
  return new GridEmbeddedFuture<>(ctx.kernalContext(),fut,new C2<Object,Exception,IgniteFuture<GridCacheTxEx<K,V>>>(){
    @Override public IgniteFuture<GridCacheTxEx<K,V>> apply(    Object o,    Exception ex){
      if (ex != null)       throw new GridClosureException(ex);
      IgniteFuture<GridCacheTxEx<K,V>> fut=locTx.prepareAsyncLocal(req.reads(),req.writes(),locTx.transactionNodes(),req.last(),req.lastBackups());
      if (locTx.isRollbackOnly())       locTx.rollbackAsync();
      return fut;
    }
  }
,new C2<GridCacheTxEx<K,V>,Exception,GridCacheTxEx<K,V>>(){
    @Nullable @Override public GridCacheTxEx<K,V> apply(    GridCacheTxEx<K,V> tx,    Exception e){
      if (e != null) {
        if (tx != null)         tx.setRollbackOnly();
        if (!(e instanceof GridCacheTxOptimisticException))         U.error(log,"Failed to prepare DHT transaction: " + tx,e);
      }
      return tx;
    }
  }
);
}
