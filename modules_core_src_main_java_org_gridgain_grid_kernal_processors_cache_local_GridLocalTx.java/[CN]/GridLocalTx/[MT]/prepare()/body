{
  if (!state(PREPARING)) {
    GridCacheTxState state=state();
    if (state == PREPARING || state == PREPARED || state == COMMITTING || state == COMMITTED)     return;
    setRollbackOnly();
    throw new GridException("Invalid transaction state for prepare [state=" + state + ", tx="+ this+ ']');
  }
  try {
    userPrepare();
    state(PREPARED);
  }
 catch (  GridException e) {
    setRollbackOnly();
    throw e;
  }
}
