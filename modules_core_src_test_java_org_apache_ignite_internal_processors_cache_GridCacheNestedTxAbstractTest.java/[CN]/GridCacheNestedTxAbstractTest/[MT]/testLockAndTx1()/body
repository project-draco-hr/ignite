{
  final IgniteCache<String,Integer> c=grid(0).cache(null);
  final IgniteCache<Integer,Integer> c1=grid(0).cache(null);
  Collection<Thread> threads=new LinkedList<>();
  c.put(CNTR_KEY,0);
  for (int i=0; i < THREAD_CNT; i++) {
    info("*** Init lock thread: " + i);
    threads.add(new Thread(new Runnable(){
      @Override public void run(){
        Lock lock=c.lock(CNTR_KEY);
        try {
          lock.lock();
          int cntr=c.get(CNTR_KEY);
          info("*** Cntr in lock thread: " + cntr);
          Transaction tx=grid(0).transactions().txStart(OPTIMISTIC,READ_COMMITTED);
          try {
            Map<Integer,Integer> data=new HashMap<>();
            for (int i=0; i < RETRIES; i++) {
              int val=globalCntr.getAndIncrement();
              data.put(val,val);
            }
            c1.putAll(data);
            tx.commit();
          }
 catch (          IgniteException e) {
            error("Failed tx thread",e);
          }
          c.put(CNTR_KEY,++cntr);
        }
 catch (        Exception e) {
          error("Failed lock thread",e);
        }
 finally {
          lock.unlock();
        }
      }
    }
));
  }
  for (  Thread t : threads)   t.start();
  for (  Thread t : threads)   t.join();
  int cntr=c.get(CNTR_KEY);
  assertEquals(THREAD_CNT,cntr);
  for (int i=0; i < globalCntr.get(); i++)   assertNotNull(c1.get(i));
}
