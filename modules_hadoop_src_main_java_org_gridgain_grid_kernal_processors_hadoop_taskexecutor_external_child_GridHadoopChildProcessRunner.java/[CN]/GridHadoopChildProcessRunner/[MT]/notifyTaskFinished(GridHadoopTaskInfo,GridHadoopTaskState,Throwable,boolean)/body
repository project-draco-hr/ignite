{
  if (!flush) {
    try {
      if (log.isDebugEnabled())       log.debug("Sending notification to parent node [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']');
      comm.sendMessage(nodeDesc,new GridHadoopTaskFinishedMessage(taskInfo,state,err));
    }
 catch (    GridException e) {
      log.error("Failed to send message to parent node (will terminate child process).",e);
      shutdown();
      terminate();
    }
  }
 else {
    if (log.isDebugEnabled())     log.debug("Flushing shuffle messages before sending last task completion notification [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']');
    try {
      shuffleJob.flush().listenAsync(new CI1<GridFuture<?>>(){
        @Override public void apply(        GridFuture<?> f){
          if (log.isDebugEnabled())           log.debug("Finished flushing shuffle messages [taskInfo=" + taskInfo + "]");
          try {
            f.get();
            notifyTaskFinished(taskInfo,state,err,false);
          }
 catch (          GridException e) {
            log.error("Failed to flush shuffle messages (will fail the task) [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']',e);
            notifyTaskFinished(taskInfo,GridHadoopTaskState.FAILED,e,false);
          }
        }
      }
);
    }
 catch (    GridException e) {
      log.error("Failed to flush shuffle messages (will fail the task) [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']',e);
      notifyTaskFinished(taskInfo,GridHadoopTaskState.FAILED,e,false);
    }
  }
}
