{
  final GridHadoopTaskState state=status.state();
  final Throwable err=status.failCause();
  if (!flush) {
    try {
      if (log.isDebugEnabled())       log.debug("Sending notification to parent node [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']');
      comm.sendMessage(nodeDesc,new GridHadoopTaskFinishedMessage(taskInfo,status));
    }
 catch (    GridException e) {
      log.error("Failed to send message to parent node (will terminate child process).",e);
      shutdown();
      terminate();
    }
  }
 else {
    if (log.isDebugEnabled())     log.debug("Flushing shuffle messages before sending last task completion notification [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']');
    final long start=System.currentTimeMillis();
    try {
      shuffleJob.flush().listenAsync(new CI1<GridFuture<?>>(){
        @Override public void apply(        GridFuture<?> f){
          long end=System.currentTimeMillis();
          if (log.isDebugEnabled())           log.debug("Finished flushing shuffle messages [taskInfo=" + taskInfo + ", flushTime="+ (end - start)+ ']');
          try {
            f.get();
            notifyTaskFinished(taskInfo,status,false);
          }
 catch (          GridException e) {
            log.error("Failed to flush shuffle messages (will fail the task) [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']',e);
            notifyTaskFinished(taskInfo,new GridHadoopTaskStatus(GridHadoopTaskState.FAILED,e),false);
          }
        }
      }
);
    }
 catch (    GridException e) {
      log.error("Failed to flush shuffle messages (will fail the task) [taskInfo=" + taskInfo + ", state="+ state+ ", err="+ err+ ']',e);
      notifyTaskFinished(taskInfo,new GridHadoopTaskStatus(GridHadoopTaskState.FAILED,e),false);
    }
  }
}
