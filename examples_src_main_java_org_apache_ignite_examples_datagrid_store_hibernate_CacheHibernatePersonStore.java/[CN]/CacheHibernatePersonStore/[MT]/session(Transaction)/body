{
  Session hbSes;
  if (tx != null) {
    Map<String,Session> props=ses.properties();
    hbSes=props.get(ATTR_SES);
    if (hbSes == null) {
      hbSes=sesFactory.openSession();
      hbSes.beginTransaction();
      props.put(ATTR_SES,hbSes);
      System.out.println("Hibernate session open [ses=" + hbSes + ", tx="+ tx.xid()+ "]");
    }
  }
 else {
    hbSes=sesFactory.openSession();
    hbSes.beginTransaction();
  }
  return hbSes;
}
