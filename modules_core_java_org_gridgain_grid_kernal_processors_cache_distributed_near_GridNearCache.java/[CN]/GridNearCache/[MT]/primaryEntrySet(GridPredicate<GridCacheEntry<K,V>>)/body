{
  final long topVer=ctx.discovery().topologyVersion();
  Collection<GridCacheEntry<K,V>> entries=F.flat(F.viewReadOnly(dht.topology().currentLocalPartitions(),new C1<GridDhtLocalPartition<K,V>,Collection<GridCacheEntry<K,V>>>(){
    @Override public Collection<GridCacheEntry<K,V>> apply(    GridDhtLocalPartition<K,V> p){
      return F.viewReadOnly(p.entries(),new C1<GridDhtCacheEntry<K,V>,GridCacheEntry<K,V>>(){
        @Override public GridCacheEntry<K,V> apply(        GridDhtCacheEntry<K,V> e){
          return e.wrap(true);
        }
      }
,new P1<GridDhtCacheEntry<K,V>>(){
        @Override public boolean apply(        GridDhtCacheEntry<K,V> e){
          return !e.obsoleteOrDeleted();
        }
      }
);
    }
  }
,new P1<GridDhtLocalPartition<K,V>>(){
    @Override public boolean apply(    GridDhtLocalPartition<K,V> p){
      return p.primary(topVer);
    }
  }
));
  return new GridCacheEntrySet<>(ctx,entries,filter);
}
