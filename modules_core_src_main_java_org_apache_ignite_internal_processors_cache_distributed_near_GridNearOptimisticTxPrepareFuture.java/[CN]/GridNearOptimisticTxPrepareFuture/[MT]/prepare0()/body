{
  try {
    if (!tx.state(PREPARING)) {
      if (tx.setRollbackOnly()) {
        if (tx.timedOut())         onError(null,null,new IgniteTxTimeoutCheckedException("Transaction timed out and " + "was rolled back: " + this));
 else         onError(null,null,new IgniteCheckedException("Invalid transaction state for prepare " + "[state=" + tx.state() + ", tx="+ this+ ']'));
      }
 else       onError(null,null,new IgniteTxRollbackCheckedException("Invalid transaction state for " + "prepare [state=" + tx.state() + ", tx="+ this+ ']'));
      return;
    }
    cctx.mvcc().addFuture(this);
    prepare(tx.optimistic() && tx.serializable() ? tx.readEntries() : Collections.<IgniteTxEntry>emptyList(),tx.writeEntries());
    markInitialized();
  }
 catch (  TransactionTimeoutException|TransactionOptimisticException e) {
    onError(cctx.localNodeId(),null,e);
  }
catch (  IgniteCheckedException e) {
    onDone(e);
  }
}
