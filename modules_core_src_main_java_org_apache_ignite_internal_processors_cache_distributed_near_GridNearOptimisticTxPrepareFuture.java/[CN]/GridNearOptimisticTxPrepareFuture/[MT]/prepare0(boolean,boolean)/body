{
  try {
    boolean txStateCheck=remap ? tx.state() == PREPARING : tx.state(PREPARING);
    if (!txStateCheck) {
      if (tx.setRollbackOnly()) {
        if (tx.timedOut())         onError(new IgniteTxTimeoutCheckedException("Transaction timed out and " + "was rolled back: " + this));
 else         onError(new IgniteCheckedException("Invalid transaction state for prepare " + "[state=" + tx.state() + ", tx="+ this+ ']'));
      }
 else       onError(new IgniteTxRollbackCheckedException("Invalid transaction state for " + "prepare [state=" + tx.state() + ", tx="+ this+ ']'));
      return;
    }
    IgniteTxEntry singleWrite=tx.singleWrite();
    if (singleWrite != null)     prepareSingle(singleWrite,topLocked,remap);
 else     prepare(tx.writeEntries(),topLocked,remap);
    markInitialized();
  }
 catch (  TransactionTimeoutException e) {
    onError(e);
  }
}
