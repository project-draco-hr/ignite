{
  final GridCacheAdapter<Integer,EnemyCamp> cache1=((IgniteKernal)grid(0)).internalCache(null);
  final GridCacheAdapter<Integer,EnemyCamp> cache2=((IgniteKernal)grid(1)).internalCache(null);
  final GridCacheAdapter<Integer,EnemyCamp> cache3=((IgniteKernal)grid(2)).internalCache(null);
  final String[] points=new String[CNT];
  WKTReader r=new WKTReader();
  ThreadLocalRandom rnd=ThreadLocalRandom.current();
  for (int idx=0; idx < CNT; idx++) {
    int x=rnd.nextInt(1,100);
    int y=rnd.nextInt(1,100);
    cache1.put(idx,new EnemyCamp(r.read("POINT(" + x + " "+ y+ ")"),Integer.toString(idx)));
    points[idx]=Integer.toString(idx);
  }
  Thread.sleep(200);
  final AtomicBoolean stop=new AtomicBoolean();
  final AtomicReference<Exception> err=new AtomicReference<>();
  IgniteInternalFuture<?> putFut=GridTestUtils.runMultiThreadedAsync(new Callable<Void>(){
    @Override public Void call() throws Exception {
      WKTReader r=new WKTReader();
      ThreadLocalRandom rnd=ThreadLocalRandom.current();
      while (!stop.get()) {
        int cacheIdx=rnd.nextInt(0,3);
        GridCache<Integer,EnemyCamp> cache=cacheIdx == 0 ? cache1 : cacheIdx == 1 ? cache2 : cache3;
        int idx=rnd.nextInt(CNT);
        int x=rnd.nextInt(1,100);
        int y=rnd.nextInt(1,100);
        cache.put(idx,new EnemyCamp(r.read("POINT(" + x + " "+ y+ ")"),Integer.toString(idx)));
        U.sleep(50);
      }
      return null;
    }
  }
,Runtime.getRuntime().availableProcessors(),"put-thread");
  IgniteInternalFuture<?> qryFut=GridTestUtils.runMultiThreadedAsync(new Callable<Void>(){
    @Override public Void call() throws Exception {
      WKTReader r=new WKTReader();
      ThreadLocalRandom rnd=ThreadLocalRandom.current();
      while (!stop.get()) {
        try {
          int cacheIdx=rnd.nextInt(0,3);
          GridCache<Integer,EnemyCamp> cache=cacheIdx == 0 ? cache1 : cacheIdx == 1 ? cache2 : cache3;
          CacheQuery<Map.Entry<Integer,EnemyCamp>> qry=cache.queries().createSqlQuery(EnemyCamp.class,"coords && ?");
          Collection<Map.Entry<Integer,EnemyCamp>> res=qry.execute(r.read("POLYGON((0 0, 0 100, 100 100, 100 0, 0 0))")).get();
          checkPoints(res,points);
          U.sleep(5);
        }
 catch (        Exception e) {
          err.set(e);
          stop.set(true);
          break;
        }
      }
      return null;
    }
  }
,4,"qry-thread");
  U.sleep(60000L);
  stop.set(true);
  putFut.get();
  qryFut.get();
  Exception err0=err.get();
  if (err0 != null)   throw err0;
}
