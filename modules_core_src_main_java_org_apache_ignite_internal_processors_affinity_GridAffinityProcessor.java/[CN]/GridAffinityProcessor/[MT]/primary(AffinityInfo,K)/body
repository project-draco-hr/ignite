{
  int part=aff.affFunc.partition(aff.mapper.affinityKey(key));
  Collection<ClusterNode> nodes=aff.assignment.get(part);
  if (F.isEmpty(nodes))   throw new IgniteCheckedException("Failed to get affinity nodes [aff=" + aff + ", key="+ key+ ']');
  Collection<ClusterNode> primaryNodes=new HashSet<>();
  for (  ClusterNode n : nodes) {
    if (aff.assignment.primaryPartitions(n.id()).contains(part))     primaryNodes.add(n);
  }
  if (F.isEmpty(primaryNodes))   throw new IgniteCheckedException("Failed to get affinity nodes [aff=" + aff + ", key="+ key+ ']');
  return primaryNodes.iterator().next();
}
