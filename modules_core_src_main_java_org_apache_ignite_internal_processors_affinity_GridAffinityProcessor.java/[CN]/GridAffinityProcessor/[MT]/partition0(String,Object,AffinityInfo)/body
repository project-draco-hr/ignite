{
  if (aff == null) {
    aff=affinityCache(cacheName,ctx.discovery().topologyVersionEx());
    if (aff == null)     throw new IgniteCheckedException("Failed to get cache affinity.");
  }
  return aff.affFunc.partition(aff.affinityKey(key));
}
