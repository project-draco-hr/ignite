{
  if (state(COMMITTING)) {
    try {
      userCommit();
    }
  finally {
      if (!done()) {
        if (isRollbackOnly()) {
          state(ROLLING_BACK);
          userRollback();
          state(ROLLED_BACK);
        }
 else         state(COMMITTED);
      }
    }
  }
}
