{
  if (map == null)   doWriteByte(NULL);
 else {
    if (tryWriteAsHandle(map))     return;
    doWriteByte(MAP);
    doWriteInt(map.size());
    doWriteByte(ctx.mapType(map.getClass()));
    for (    Map.Entry<?,?> e : map.entrySet()) {
      doWriteObject(e.getKey());
      doWriteObject(e.getValue());
    }
  }
}
