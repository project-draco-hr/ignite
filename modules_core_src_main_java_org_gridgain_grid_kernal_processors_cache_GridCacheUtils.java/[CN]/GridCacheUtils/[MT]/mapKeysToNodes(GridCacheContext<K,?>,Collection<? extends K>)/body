{
  if (keys == null || keys.isEmpty())   return Collections.emptyMap();
  if (ctx.config().getCacheMode() == LOCAL)   return F.asMap(ctx.localNode(),(Collection<K>)keys);
  long topVer=ctx.discovery().topologyVersion();
  if (CU.affinityNodes(ctx,topVer).isEmpty())   return Collections.emptyMap();
  if (keys.size() == 1)   return Collections.singletonMap(ctx.affinity().primary(F.first(keys),topVer),(Collection<K>)keys);
  Map<GridNode,Collection<K>> map=new GridLeanMap<>(5);
  for (  K k : keys) {
    GridNode primary=ctx.affinity().primary(k,topVer);
    Collection<K> mapped=map.get(primary);
    if (mapped == null)     map.put(primary,mapped=new LinkedList<>());
    mapped.add(k);
  }
  return map;
}
