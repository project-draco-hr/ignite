{
  if (state == CONNECTED) {
    DiscoverySpiListener lsnr=spi.lsnr;
    if (lsnr != null) {
      UUID nodeId=msg.creatorNodeId();
      TcpDiscoveryNode node=nodeId.equals(getLocalNodeId()) ? locNode : rmtNodes.get(nodeId);
      if (node != null && node.visible()) {
        try {
          DiscoverySpiCustomMessage msgObj=msg.message(spi.marsh,U.resolveClassLoader(spi.ignite().configuration()));
          notifyDiscovery(EVT_DISCOVERY_CUSTOM_EVT,topVer,node,allVisibleNodes(),msgObj);
        }
 catch (        Throwable e) {
          U.error(log,"Failed to unmarshal discovery custom message.",e);
        }
      }
 else       if (log.isDebugEnabled())       log.debug("Received metrics from unknown node: " + nodeId);
    }
  }
}
