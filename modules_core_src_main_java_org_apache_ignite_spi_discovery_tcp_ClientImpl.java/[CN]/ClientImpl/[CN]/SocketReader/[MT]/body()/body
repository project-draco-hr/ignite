{
  while (!isInterrupted()) {
    Socket sock;
    UUID rmtNodeId;
synchronized (mux) {
      if (this.sock == null) {
        mux.wait();
        continue;
      }
      sock=this.sock;
      rmtNodeId=this.rmtNodeId;
    }
    try {
      InputStream in=new BufferedInputStream(sock.getInputStream());
      sock.setKeepAlive(true);
      sock.setTcpNoDelay(true);
      while (!isInterrupted()) {
        TcpDiscoveryAbstractMessage msg;
        try {
          msg=spi.marsh.unmarshal(in,U.gridClassLoader());
        }
 catch (        IgniteCheckedException e) {
          if (log.isDebugEnabled())           U.error(log,"Failed to read message [sock=" + sock + ", "+ "locNodeId="+ getLocalNodeId()+ ", rmtNodeId="+ rmtNodeId+ ']',e);
          IOException ioEx=X.cause(e,IOException.class);
          if (ioEx != null)           throw ioEx;
          ClassNotFoundException clsNotFoundEx=X.cause(e,ClassNotFoundException.class);
          if (clsNotFoundEx != null)           LT.warn(log,null,"Failed to read message due to ClassNotFoundException " + "(make sure same versions of all classes are available on all nodes) " + "[rmtNodeId=" + rmtNodeId + ", err="+ clsNotFoundEx.getMessage()+ ']');
 else           LT.error(log,e,"Failed to read message [sock=" + sock + ", locNodeId="+ getLocalNodeId()+ ", rmtNodeId="+ rmtNodeId+ ']');
          continue;
        }
        msg.senderNodeId(rmtNodeId);
        if (log.isDebugEnabled())         log.debug("Message has been received: " + msg);
        spi.stats.onMessageReceived(msg);
        if (spi.ensured(msg) && joinLatch.getCount() == 0L)         lastMsgId=msg.id();
        msgWorker.addMessage(msg);
      }
    }
 catch (    IOException e) {
      msgWorker.addMessage(new SocketClosedMessage(sock));
      if (log.isDebugEnabled())       U.error(log,"Connection failed [sock=" + sock + ", locNodeId="+ getLocalNodeId()+ ']',e);
    }
 finally {
      U.closeQuiet(sock);
synchronized (mux) {
        if (this.sock == sock) {
          this.sock=null;
          this.rmtNodeId=null;
        }
      }
    }
  }
}
