{
  if (mode != PRIMARY) {
    IgniteFsConfiguration ggfsCfg=new IgniteFsConfiguration();
    ggfsCfg.setDataCacheName("partitioned");
    ggfsCfg.setMetaCacheName("replicated");
    ggfsCfg.setName("ggfs_secondary");
    ggfsCfg.setIpcEndpointConfiguration(GridGgfsTestUtils.jsonToMap(SECONDARY_ENDPOINT_CFG));
    ggfsCfg.setBlockSize(512 * 1024);
    ggfsCfg.setPrefetchBlocks(1);
    GridCacheConfiguration cacheCfg=defaultCacheConfiguration();
    cacheCfg.setName("partitioned");
    cacheCfg.setCacheMode(PARTITIONED);
    cacheCfg.setDistributionMode(GridCacheDistributionMode.PARTITIONED_ONLY);
    cacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
    cacheCfg.setAffinityMapper(new GridGgfsGroupDataBlocksKeyMapper(GRP_SIZE));
    cacheCfg.setBackups(0);
    cacheCfg.setQueryIndexEnabled(false);
    cacheCfg.setAtomicityMode(TRANSACTIONAL);
    GridCacheConfiguration metaCacheCfg=defaultCacheConfiguration();
    metaCacheCfg.setName("replicated");
    metaCacheCfg.setCacheMode(REPLICATED);
    metaCacheCfg.setWriteSynchronizationMode(GridCacheWriteSynchronizationMode.FULL_SYNC);
    metaCacheCfg.setQueryIndexEnabled(false);
    metaCacheCfg.setAtomicityMode(TRANSACTIONAL);
    IgniteConfiguration cfg=new IgniteConfiguration();
    cfg.setGridName("grid_secondary");
    GridTcpDiscoverySpi discoSpi=new GridTcpDiscoverySpi();
    discoSpi.setIpFinder(new GridTcpDiscoveryVmIpFinder(true));
    cfg.setDiscoverySpi(discoSpi);
    cfg.setCacheConfiguration(metaCacheCfg,cacheCfg);
    cfg.setGgfsConfiguration(ggfsCfg);
    cfg.setIncludeEventTypes(EVT_TASK_FAILED,EVT_TASK_FINISHED,EVT_JOB_MAPPED);
    cfg.setCommunicationSpi(communicationSpi());
    G.start(cfg);
  }
  startGrids(4);
}
