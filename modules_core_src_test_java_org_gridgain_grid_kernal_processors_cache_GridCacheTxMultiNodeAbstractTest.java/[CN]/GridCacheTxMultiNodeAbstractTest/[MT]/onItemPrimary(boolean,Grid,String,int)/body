{
  GridCache<String,Integer> cache=grid.cache(null);
  UUID locId=grid.cluster().localNode().id();
  UUID itemPrimaryId=primaryId(grid,itemKey);
  UUID cntrPrimaryId=primaryId(grid,CNTR_KEY);
  boolean isCntrPrimary=cntrPrimaryId.equals(locId);
  try (GridCacheTx tx=cache.txStart(PESSIMISTIC,REPEATABLE_READ)){
    if (DEBUG)     info("Before item primary get [retry=" + retry + ", xid="+ tx.xid()+ ", node="+ grid.name()+ ", isCntrPrimary="+ isCntrPrimary+ ", nearId="+ locId+ ", nearEntry="+ nearEntry(locId,CNTR_KEY)+ (isCntrPrimary ? ", dhtEntry=" + dhtEntry(locId,CNTR_KEY) : "")+ ']');
    Integer cntr=cache.get(CNTR_KEY);
    int newVal=cntr + 1;
    if (putCntr) {
      if (DEBUG)       info("Before item primary put counter [retry=" + retry + ", isCntrPrimary="+ isCntrPrimary+ ", cur="+ cntr+ ", new="+ newVal+ ", nearEntry="+ nearEntry(locId,CNTR_KEY)+ (isCntrPrimary ? ", dhtEntry=" + dhtEntry(locId,CNTR_KEY) : "")+ ']');
      cache.putx(CNTR_KEY,newVal);
    }
    if (DEBUG)     info("Before item primary put item [retry=" + retry + ", key="+ itemKey+ ", cur="+ cntr+ ", new="+ newVal+ ", nearEntry="+ nearEntry(locId,itemKey)+ ", dhtEntry="+ dhtEntry(itemPrimaryId,itemKey)+ ']');
    cache.putx(itemKey,cntr);
    if (DEBUG)     info("After item primary put item [retry=" + retry + ", key="+ itemKey+ ", cur="+ cntr+ ", new="+ newVal+ ", nearEntry="+ nearEntry(locId,itemKey)+ ", dhtEntry="+ dhtEntry(itemPrimaryId,itemKey)+ ']');
    tx.commit();
  }
 }
