{
  GridDhtPartitionsExchangeFuture lastInitializedFut0=lastInitializedFut;
  if (lastInitializedFut0 != null && lastInitializedFut0.topologyVersion().compareTo(ver) == 0) {
    if (log.isDebugEnabled())     log.debug("Return lastInitializedFut for topology ready future " + "[ver=" + ver + ", fut="+ lastInitializedFut0+ ']');
    return lastInitializedFut0;
  }
  AffinityTopologyVersion topVer=readyTopVer.get();
  if (topVer.compareTo(ver) >= 0) {
    if (log.isDebugEnabled())     log.debug("Return finished future for topology ready future [ver=" + ver + ", topVer="+ topVer+ ']');
    return null;
  }
  GridFutureAdapter<AffinityTopologyVersion> fut=F.addIfAbsent(readyFuts,ver,new AffinityReadyFuture(ver));
  if (log.isDebugEnabled())   log.debug("Created topology ready future [ver=" + ver + ", fut="+ fut+ ']');
  topVer=readyTopVer.get();
  if (topVer.compareTo(ver) >= 0) {
    if (log.isDebugEnabled())     log.debug("Completing created topology ready future " + "[ver=" + topVer + ", topVer="+ topVer+ ", fut="+ fut+ ']');
    fut.onDone(topVer);
  }
 else   if (stopErr != null)   fut.onDone(stopErr);
  return fut;
}
