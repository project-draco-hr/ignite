{
  AffinityTopologyVersion topVer=exchFut.topologyVersion();
  if (log.isDebugEnabled())   log.debug("Exchange done [topVer=" + topVer + ", fut="+ exchFut+ ", err="+ err+ ']');
  if (err == null) {
    while (true) {
      AffinityTopologyVersion readyVer=readyTopVer.get();
      if (readyVer.compareTo(topVer) >= 0)       break;
      if (readyTopVer.compareAndSet(readyVer,topVer))       break;
    }
    for (    Map.Entry<AffinityTopologyVersion,AffinityReadyFuture> entry : readyFuts.entrySet()) {
      if (entry.getKey().compareTo(topVer) <= 0) {
        if (log.isDebugEnabled())         log.debug("Completing created topology ready future " + "[ver=" + topVer + ", fut="+ entry.getValue()+ ']');
        entry.getValue().onDone(topVer);
      }
    }
  }
 else {
    for (    Map.Entry<AffinityTopologyVersion,AffinityReadyFuture> entry : readyFuts.entrySet()) {
      if (entry.getKey().compareTo(topVer) <= 0) {
        if (log.isDebugEnabled())         log.debug("Completing created topology ready future with error " + "[ver=" + topVer + ", fut="+ entry.getValue()+ ']');
        entry.getValue().onDone(err);
      }
    }
  }
  ExchangeFutureSet exchFuts0=exchFuts;
  if (exchFuts0 != null) {
    int skipped=0;
    for (    GridDhtPartitionsExchangeFuture fut : exchFuts0.values()) {
      if (exchFut.exchangeId().topologyVersion().compareTo(fut.exchangeId().topologyVersion()) < 0)       continue;
      skipped++;
      if (skipped == EXCH_FUT_CLEANUP_HISTORY_SIZE) {
        for (        GridCacheContext cacheCtx : cctx.cacheContexts()) {
          if (err == null) {
            if (!cacheCtx.isLocal())             cacheCtx.affinity().cleanUpCache(fut.topologyVersion());
          }
        }
      }
      if (skipped > 10)       fut.cleanUp();
    }
  }
}
