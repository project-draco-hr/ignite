{
  try {
    for (int i=0; i < getSpiCount(); i++) {
      DiscoverySpi spi=getSpi(i);
      IgniteTestResources rsrcMgr=new IgniteTestResources(getMBeanServer(i));
      rsrcMgr.inject(spi);
      spi.setNodeAttributes(Collections.<String,Object>singletonMap(TEST_ATTRIBUTE_NAME,"true"),fromString("99.99.99"));
      spi.setListener(new DiscoverySpiListener(){
        @SuppressWarnings({"NakedNotify"}) @Override public void onDiscovery(        int type,        long topVer,        ClusterNode node,        Collection<ClusterNode> topSnapshot,        Map<Long,Collection<ClusterNode>> topHist){
          info("Discovery event [type=" + type + ", node="+ node+ ']');
synchronized (mux) {
            mux.notifyAll();
          }
        }
      }
);
      spi.setDataExchange(new DiscoverySpiDataExchange(){
        @Override public Map<Integer,Object> collect(        UUID nodeId){
          return new HashMap<Integer,Object>();
        }
        @Override public void onExchange(        Map<Integer,Object> data){
        }
      }
);
      spi.setAuthenticator(new DiscoverySpiNodeAuthenticator(){
        @Override public SecurityContext authenticateNode(        ClusterNode n,        GridSecurityCredentials cred){
          GridSecuritySubject subj=getGridSecuritySubject(GridSecuritySubjectType.REMOTE_NODE,n.id());
          return new GridSecurityContext(subj);
        }
        @Override public boolean isGlobalNodeAuthentication(){
          return false;
        }
      }
);
      spi.spiStart(getTestGridName() + i);
      spis.add(spi);
      spiRsrcs.add(rsrcMgr);
      spi.onContextInitialized(initSpiContext());
    }
  }
 catch (  Throwable e) {
    e.printStackTrace();
  }
  spiStartTime=System.currentTimeMillis();
}
