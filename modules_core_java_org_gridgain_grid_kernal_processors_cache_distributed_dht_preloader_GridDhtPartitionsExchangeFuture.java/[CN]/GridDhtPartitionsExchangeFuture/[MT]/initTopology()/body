{
  U.debug(log,"Initializing topology");
  rmtNodes=new ConcurrentLinkedQueue<>(CU.aliveRemoteNodes(cctx,exchId.topologyVersion()));
  rmtIds=Collections.unmodifiableSet(new HashSet<>(F.nodeIds(rmtNodes)));
  for (  Map.Entry<UUID,GridDhtPartitionsSingleMessage<K,V>> m : new HashMap<>(msgs).entrySet()) {
    onReceive(m.getKey(),m.getValue());
  }
  if (canCalculateAffinity()) {
    U.debug(log,"Will recalculate affinity");
    cctx.affinity().calculateAffinity(exchId.topologyVersion(),discoEvt);
  }
 else {
    U.debug(log,"Will request affinity from remote node.");
    GridDhtAssignmentFetchFuture<K,V> fetchFut=new GridDhtAssignmentFetchFuture<>(cctx,exchId.topologyVersion(),CU.affinityNodes(cctx));
    fetchFut.init();
    List<List<GridNode>> affAssignment=fetchFut.get();
    U.debug(log,"Going to initialize affinity assignment [locNodeId=" + cctx.localNodeId() + ", topVer="+ exchId.topologyVersion()+ ']');
    cctx.affinity().initializeAffinity(exchId.topologyVersion(),affAssignment);
    U.debug(log,"Initialized affinity from remote node [locNodeId=" + cctx.localNodeId() + ", topVer="+ exchId.topologyVersion()+ ']');
  }
  if (oldestNode.get().id().equals(cctx.nodeId())) {
    if (allReceived() && ready.get() && replied.compareAndSet(false,true)) {
      spreadPartitions(top.partitionMap(true));
      onDone(exchId.topologyVersion());
    }
  }
}
