{
  GridSqlSelect srcQry=GridSqlQueryParser.parse(conn,query);
  if (srcQry.groups().isEmpty()) {
    String tbl0=table(0);
    GridCacheTwoStepQuery res=new GridCacheTwoStepQuery("select * from " + tbl0);
    res.addMapQuery(tbl0,srcQry.getSQL(),params);
    return res;
  }
  List<GridSqlElement> mapExps=new ArrayList<>(srcQry.allExpressions());
  GridSqlElement[] rdcExps=new GridSqlElement[srcQry.select().size()];
  for (int i=0, len=mapExps.size(); i < len; i++)   splitSelectExpression(mapExps,rdcExps,i);
  GridSqlSelect mapQry=srcQry.clone();
  mapQry.clearSelect();
  int idx=0;
  for (  GridSqlElement exp : mapExps) {
    mapQry.addSelectExpression(exp);
    idx++;
  }
  mapQry.clearGroups();
  for (  int col : srcQry.groupColumns())   mapQry.addGroupExpression(column(aliases.get(col).alias()));
  mapQry.clearSort();
  GridSqlSelect rdcQry=new GridSqlSelect();
  for (int i=0; i < srcQry.select().size(); i++)   rdcQry.addSelectExpression(column(aliases.get(i).alias()));
  rdcQry.from(new GridSqlTable(null,table(0)));
  for (  int col : srcQry.groupColumns())   rdcQry.addGroupExpression(column(aliases.get(col).alias()));
  GridCacheTwoStepQuery res=new GridCacheTwoStepQuery(rdcQry.getSQL());
  res.addMapQuery(table(0),mapQry.getSQL(),params);
  return res;
}
