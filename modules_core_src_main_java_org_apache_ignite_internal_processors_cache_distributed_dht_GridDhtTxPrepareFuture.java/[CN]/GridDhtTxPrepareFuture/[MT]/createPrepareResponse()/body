{
  Throwable prepErr=err.get();
  GridNearTxPrepareResponse res=new GridNearTxPrepareResponse(tx.nearXidVersion(),tx.colocated() ? tx.xid() : tx.nearFutureId(),nearMiniId == null ? tx.xid() : nearMiniId,tx.xidVersion(),tx.invalidPartitions(),ret,prepErr);
  if (prepErr == null) {
    addDhtValues(res);
    GridCacheVersion min=tx.minVersion();
    res.completedVersions(cctx.tm().committedVersions(min),cctx.tm().rolledbackVersions(min));
    res.pending(localDhtPendingVersions(tx.writeEntries(),min));
    tx.implicitSingleResult(ret);
  }
  res.filterFailedKeys(filterFailedKeys);
  return res;
}
