{
  try {
    Boolean scan=arg.queryTxt().toUpperCase().startsWith("SCAN");
    String qryId=(scan ? SCAN_QRY_NAME : SQL_QRY_NAME) + "-" + UUID.randomUUID();
    GridCache<Object,Object> c=g.cachex(arg.cacheName());
    if (scan) {
      GridCacheQueryFuture<Map.Entry<Object,Object>> fut=c.queries().createScanQuery(null).pageSize(arg.pageSize()).projection(g.forNodeIds(arg.proj())).execute();
      GridBiTuple<List<Object[]>,Map.Entry<Object,Object>> rows=fetchScanQueryRows(fut,null,arg.pageSize());
      Map.Entry<Object,Object> next=rows.get2();
      g.<String,VisorFutureResultSetHolder>nodeLocalMap().put(qryId,new VisorFutureResultSetHolder<>(fut,next,false));
      scheduleResultSetHolderRemoval(qryId);
      return new GridBiTuple<>(null,new VisorQueryResultEx(g.localNode().id(),qryId,SCAN_COL_NAMES,rows.get1(),next != null));
    }
 else {
      GridCacheQueryFuture<List<?>> fut=((GridCacheQueriesEx<?,?>)c.queries()).createSqlFieldsQuery(arg.queryTxt(),true).pageSize(arg.pageSize()).projection(g.forNodeIds(arg.proj())).execute();
      List<Object> firstRow=(List<Object>)fut.next();
      List<GridIndexingFieldMetadata> meta=((GridCacheQueryMetadataAware)fut).metadata().get();
      if (meta == null)       return new GridBiTuple<Exception,VisorQueryResultEx>(new SQLException("Fail to execute query. No metadata available."),null);
 else {
        VisorFieldsQueryColumn[] names=new VisorFieldsQueryColumn[meta.size()];
        for (int i=0; i < meta.size(); i++) {
          GridIndexingFieldMetadata col=meta.get(i);
          names[i]=new VisorFieldsQueryColumn(col.typeName(),col.fieldName());
        }
        GridBiTuple<List<Object[]>,List<?>> rows=fetchSqlQueryRows(fut,firstRow,arg.pageSize());
        g.<String,VisorFutureResultSetHolder>nodeLocalMap().put(qryId,new VisorFutureResultSetHolder<>(fut,rows.get2(),false));
        scheduleResultSetHolderRemoval(qryId);
        return new GridBiTuple<>(null,new VisorQueryResultEx(g.localNode().id(),qryId,names,rows.get1(),rows.get2() != null));
      }
    }
  }
 catch (  Exception e) {
    return new GridBiTuple<>(e,null);
  }
}
